# Restructuring Plan - 2025-12-28

This plan restructures the Dockhand monorepo to focus exclusively on "research" functionality, establishing a clear area-based architecture for future expansion.

---

## Phase 1: Changing Focus

**Goal:** Transform the project from a multi-purpose CLI to a research-focused toolset by restructuring modules into a `/research` area.

### 1.1 Move Library Module (`/lib` → `/research/lib`)

**Current state:**
- Location: `/lib`
- Package name: `dockhand-lib`
- Library crate: `dockhand_lib`
- Binary: `dockhand-dev` (development binary)

**Actions:**
1. Create `/research` directory
2. Move `/lib` to `/research/lib`
3. Update package name in `Cargo.toml`: `dockhand-lib` → `research-lib`
4. Update library crate name: `dockhand_lib` → `research_lib`
5. Update binary name: `dockhand-dev` → `research-dev` (if keeping dev binary)
6. Update all internal references

**Files to modify:**
- `/research/lib/Cargo.toml` - package name, lib name, bin name
- `/research/lib/src/lib.rs` - module documentation
- `/research/lib/src/main.rs` - any references

### 1.2 Move CLI Module (`/cli` → `/research/cli`)

**Current state:**
- Location: `/cli`
- Package name: `deckhand-cli`
- Binary: `deck`
- Command: `research` (subcommand)
- Dependency: `dockhand-lib`

**Actions:**
1. Move `/cli` to `/research/cli`
2. Update package name: `deckhand-cli` → `research-cli`
3. Update binary name: `deck` → `research`
4. Rename `Research` command to `Library` command
5. Update command documentation to reflect "library research"
6. Update dependency path: `../lib` → `../lib` (same relative path after move)
7. Update dependency name: `dockhand-lib` → `research-lib`

**Files to modify:**
- `/research/cli/Cargo.toml` - package name, binary name, dependency
- `/research/cli/src/main.rs` - command struct, imports, documentation

### 1.3 Move and Adapt justfile

**Current state:**
- Location: `/justfile`
- Targets: `default`, `build`, `test`, `install`, `cli`
- References: `deckhand-cli`

**Actions:**
1. Move `/justfile` to `/research/justfile`
2. Update references from `deckhand-cli` to `research-cli`
3. Update output messages to say "Research" instead of "Deckhand"
4. Update `cli` target to run `cargo run -p research-cli`
5. Update paths to be relative to `/research`

**New `/research/justfile` targets:**
- `default` - list available commands
- `build` - build research modules (cli, lib)
- `test` - test research modules
- `install` - install the `research` binary
- `cli` - run the debug CLI

### 1.4 Create New Root justfile

**Goal:** Delegate to area-specific justfiles with fallback messaging for missing targets.

**Actions:**
1. Create new `/justfile`
2. Implement `build`, `test`, `install` targets that:
   - Scan for area directories (currently just `/research`)
   - Check if each area has the corresponding target
   - Execute if present, log warning to STDERR if absent

**New `/justfile` structure:**
```just
# build - delegates to areas
build:
    @for area in research; do \
        if just -f "$area/justfile" --summary 2>/dev/null | grep -q "build"; then \
            just -f "$area/justfile" build; \
        else \
            echo "- no **build** command for the area **$area**" >&2; \
        fi \
    done

# Similar for test, install
```

### 1.5 Update Root Cargo.toml

**Current state:**
```toml
[workspace]
resolver = "2"
members = ["cli", "lib", "tui"]
```

**Actions:**
1. Update members to new paths: `["research/cli", "research/lib", "tui"]`

### 1.6 Update Documentation

**Files to update:**
- `/README.md` - Update module descriptions, paths, and terminology
- `/docs/system-prompt.md` - Update if it references old paths
- Any `CLAUDE.md` files if they exist

**Documentation changes:**
- Replace "Deckhand" with "Research" where appropriate
- Update path references from `/lib`, `/cli` to `/research/lib`, `/research/cli`
- Refer to modules as "Research Library" and "Research CLI"
- Update binary name from `deck` to `research`
- Update subcommand from `research` to `library`

---

## Phase 2: Adding a "Shared" Area

**Goal:** Create a shared utility library for cross-area functionality.

### 2.1 Initialize Shared Library

**Actions:**
1. Create `/shared` directory
2. Create `/shared/Cargo.toml`:
   ```toml
   [package]
   name = "shared"
   version = "0.1.0"
   edition = "2024"

   [lib]
   name = "shared"
   path = "src/lib.rs"
   ```
3. Create `/shared/src/lib.rs` with placeholder content
4. Create `/shared/src/mod.rs` if needed for module organization

### 2.2 Create Shared justfile

**Actions:**
1. Create `/shared/justfile` with targets:
   - `build` - build the shared library
   - `test` - run shared library tests

### 2.3 Update Root Cargo.toml

**Actions:**
1. Add `shared` to workspace members:
   ```toml
   members = ["research/cli", "research/lib", "tui", "shared"]
   ```

### 2.4 Update Root justfile

**Actions:**
1. Add `shared` to the list of areas to scan

### 2.5 Update Documentation

**Actions:**
1. Update `/README.md` to include Shared Library section
2. Document the shared library purpose and future intent

---

## Phase 3: Research Improvements (FUTURE - Requires User Clarification)

**Note:** This phase will NOT be executed until explicitly requested. Several areas require user clarification before implementation.

### 3.1 Change Research Output Location

**Current:** `research/${library_name}` (relative to CWD)
**New:** `${RESEARCH_DIR:-$HOME}/.research/library/${library_name}`

**Questions to clarify:**
- Should `RESEARCH_DIR` point to the parent of `.research` or replace the entire path?
- How should we handle the `.research` directory structure for other future research types?

### 3.2 Research Metadata (`metadata.json`)

**Structure:**
```rust
struct ResearchMetadata {
    kind: ResearchKind,
    additional_files: HashMap<String, String>, // filename -> prompt
}

enum ResearchKind {
    Library,
    // Future: Software, Standard, Company, etc.
}
```

**Questions to clarify:**
- Should metadata include timestamps, versions, or other tracking info?
- Should we store the library info (package manager, language) in metadata?

### 3.3 DRY Research Implementation

**Flow:**
1. Check if research exists for the library
2. If no existing research: run normal process
3. If existing research exists:
   - If user provided additional prompts:
     - Use Gemini 3 Flash to check overlap via `PromptOverlap` structure
     - If all new: add underlying docs, regenerate synthesis
     - If overlapping: interactive prompt for user to select which to include

**Questions to clarify:**
- What's the exact format for `PromptOverlap` response from Gemini?
- How should filenames be generated for additional prompts? (slugify? hash? numbered?)
- Should we also track when research was last updated?
- What happens if metadata.json is missing but research files exist?

---

## Execution Order

### Phase 1 (Execute Now)
1. Create `/research` directory
2. Move `/lib` to `/research/lib`
3. Move `/cli` to `/research/cli`
4. Update `/research/lib/Cargo.toml`
5. Update `/research/lib/src/lib.rs` and `main.rs`
6. Update `/research/cli/Cargo.toml`
7. Update `/research/cli/src/main.rs`
8. Move `/justfile` to `/research/justfile`
9. Update `/research/justfile`
10. Create new `/justfile`
11. Update root `/Cargo.toml`
12. Update `/README.md`
13. Verify build and test pass

### Phase 2 (Execute After Phase 1)
1. Create `/shared/Cargo.toml`
2. Create `/shared/src/lib.rs`
3. Create `/shared/justfile`
4. Update root `/Cargo.toml` to include shared
5. Update root `/justfile` to include shared area
6. Update `/README.md`
7. Verify build passes

### Phase 3 (Requires User Approval - DO NOT EXECUTE)
- Wait for user clarification on open questions
- Wait for explicit request to proceed
