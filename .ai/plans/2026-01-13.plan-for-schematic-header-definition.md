---
status: "done"
started_at: 14:32:00
finished_at: 14:39:00
duration: 7 minutes
tts_gender: male
requirements:
  1. Add support for defining Header key/values in the schematic API definition layer
  2. Headers definable at BOTH API-wide level (defaults) and endpoint-specific level (overrides/additions)
  3. Header values are STATIC (fixed at definition time, no dynamic/runtime values)
  4. Headers should propagate from definition stage to the "schema" module (generated code)
  5. Example use case - Anthropic API beta endpoints require extra header properties (e.g., `anthropic-beta: message-batches-2024-09-24`)
  6. Restructure directory - move @schematic/schematic/schema/ to @schematic/schema/
  7. Update ALL import paths and Cargo.toml references after directory restructure
required_skills:
  - rust
  - thiserror
  - monorepos
important_skills:
  serde: "Serialization/deserialization of header definitions"
  prettyplease: "Code formatting for generated Rust code"
  syn: "AST manipulation if code generation uses safe injection"
  reqwest: "Understanding HTTP header mechanics"
subagents:
  Plan: "Create phased implementation plan"
  Explore: "Module assessment for monorepo impacts"
  general-purpose: "Reviews (completeness, concurrency, correctness) and finalization"
  feature-tester-rust: "Testing the implementation"
monorepo_modules_impacted:
  - schematic/define (HIGH - add header fields to RestApi and Endpoint structs)
  - schematic/gen (CRITICAL - code generation for headers)
  - schematic/schema (HIGH - directory restructure + regeneration)
  - Root Cargo.toml (LOW - reference check)
completeness_changes:
  - "HIGH: Define header merging algorithm before Phase 3 (silent override? normalize keys?)"
  - "HIGH: Specify 4-tuple elements for into_parts() return"
  - "HIGH: Add explicit edge-case testing to Phase 5"
  - "MEDIUM: Clarify if headers need Serialize/Deserialize support"
  - "MEDIUM: Add quote crate to required skills for Phase 3-4"
concurrency_changes:
  - "Defer Phase 1 directory restructuring to after Phase 5 (validate paths only initially)"
  - "Overlap Phase 2-3: Type definition + codegen design in parallel"
  - "Phase 3 can be split into 3 parallel modules: request_structs, client, api_struct"
  - "Run Phase 5 tests with --test-threads=4 for parallel execution"
detail_changes:
  - "CRITICAL: request_enum.rs has return type mismatch (pre-existing bug)"
  - "CRITICAL: Add headers field initialization to ALL constructors in api_struct.rs"
  - "CRITICAL: Update into_parts() signature to return 4-tuple with headers"
  - "HIGH: Optimize merge_headers() from O(nÂ²) to O(n)"
  - "HIGH: Add header merging logic to client.rs request() method"
lessons_learned_count: 5
---
# Planning Process

- [x] Prep Started [14:32]
    - [x] Identified Skills [14:33] - rust, thiserror, monorepos (+ suggested: serde, prettyplease, syn, reqwest)
    - [x] Identified Subagents [14:33] - Plan, Explore, general-purpose, feature-tester-rust
- [x] Prep complete [14:33]
- [x] Clarify (orchestrator) [14:34]
    - [x] User asked clarifying questions (human in the loop) [14:34]
        - Header scope: Both levels (API-wide + endpoint-specific)
        - Dynamic values: Static only
        - Import updates: Yes, update all references
    - [x] Requirements have been updated based on user responses [14:34]
- [x] Planning Subagent [agent: **Plan**] started [14:34]
    - [x] subagent skills used: rust, thiserror, monorepos
    - [x] Planning completed [14:35]
- [x] Module Assessment Subagent [agent: **Explore**] started [14:34]
    - [x] subagent skills used: rust, monorepos
    - [x] Module Assessment completed [14:35]
- [x] All Pre-review Steps are complete [14:35]
- [x] Review Started [14:36]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: monorepos, rust, syn, thiserror
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, monorepos
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
        - [x] subagent skills used: rust, thiserror
- [x] Reviews Completed [14:37]
- [x] Plan Finalization [agent: **general-purpose**] started [14:37]
    - [x] subagent skills used: rust, thiserror, monorepos
- [x] Plan finalized [14:38]
- Final Steps
    - [x] Lessons learned collected from all subagents [14:39]
    - [x] No new packages to research (all dependencies already present)
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-13.plan-for-schematic-header-definition.md
    - Started: 14:32
    - Completed: 14:39
    - Duration: 7 minutes



## Plan

### Header Merging Semantics

Headers are merged using a **last-write-wins** strategy with endpoint headers taking precedence over API-level headers:

```rust
// Endpoint headers override API headers for matching keys (case-insensitive)
fn merge_headers(api: &[(String, String)], endpoint: &[(String, String)]) -> Vec<(String, String)> {
    let mut result: Vec<(String, String)> = Vec::with_capacity(api.len() + endpoint.len());
    // Build lookup of endpoint keys (lowercase for comparison)
    let endpoint_keys: std::collections::HashSet<String> =
        endpoint.iter().map(|(k, _)| k.to_lowercase()).collect();
    // Add API headers that aren't overridden
    for (k, v) in api {
        if !endpoint_keys.contains(&k.to_lowercase()) {
            result.push((k.clone(), v.clone()));
        }
    }
    // Add all endpoint headers (these take precedence)
    result.extend(endpoint.iter().cloned());
    result
}
```

**Complexity:** O(n) where n = api_headers + endpoint_headers

---

### Phase 0: Pre-existing Bug Fix

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, thiserror |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | No |

**Objective:** Fix the return type mismatch in `request_enum.rs` where `into_parts()` should return `Result` but doesn't.

**Deliverables:**
- Fixed return type in `request_enum.rs` to match `request_structs.rs`

**Acceptance Criteria:**
- [x] All existing tests pass
- [x] Generated code compiles successfully

---

### Phase 1: Header Type Definition

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | monorepos |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | No (must complete first) |

**Objective:** Move `schematic/schematic/schema/` to `schematic/schema/` and update all references.

**Deliverables:**
- Directory relocated from `schematic/schematic/schema/` to `schematic/schema/`
- Updated paths in `cargo_gen.rs`, `main.rs`, `justfile`
- Updated README documentation

**Acceptance Criteria:**
- [x] `schematic/schema/` directory exists
- [x] `schematic/schematic/` directory is removed
- [x] `just -f schematic/justfile full` succeeds

---

### Phase 2: Header Type Definition

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, thiserror |
| **Suggested Skills** | serde (serialization) |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No |

**Objective:** Add header fields to `RestApi` and `Endpoint` structs in `schematic-define`.

**Deliverables:**
- New `headers: Vec<(String, String)>` field on `RestApi` struct
- New `headers: Vec<(String, String)>` field on `Endpoint` struct
- Updated existing API definitions with `headers: vec![]`

**Acceptance Criteria:**
- [x] `RestApi` has `headers` field
- [x] `Endpoint` has `headers` field
- [x] Existing code compiles
- [x] `cargo test -p schematic-define` passes

---

### Phase 3: Code Generation for Headers

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, syn, prettyplease |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 2 |
| **Parallelizable** | No |

**Objective:** Update code generators to propagate headers from definition to generated client code.

**Deliverables:**
- Generated API struct includes `headers` field
- Generated `request()` method applies merged headers
- Header merging logic: endpoint headers override API headers with same key
- Updated constructors to initialize headers

**Acceptance Criteria:**
- [x] Generated struct has `headers` field
- [x] `new()` and other constructors initialize headers
- [x] `variant()` method handles header customization
- [x] `request()` method applies merged headers
- [x] Generated code compiles

---

### Phase 4: Endpoint Header Propagation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, syn, prettyplease |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 3 |
| **Parallelizable** | No |

**Objective:** Update request struct generation to carry endpoint-specific headers through to the request method.

**Deliverables:**
- `into_parts()` method returns endpoint headers (4-tuple)
- Request enum delegates headers correctly
- Per-endpoint struct stores headers from definition

**Acceptance Criteria:**
- [x] `into_parts()` returns 4-tuple with endpoint headers
- [x] Request enum's `into_parts()` delegates correctly
- [x] All unit tests pass

---

### Phase 5: Integration Testing

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 4 |
| **Parallelizable** | No |

**Objective:** Comprehensive testing of header functionality.

**Deliverables:**
- Unit tests for header merging logic
- Unit tests for header generation
- E2E test with header-enabled API definition

**Acceptance Criteria:**
- [x] All new unit tests pass
- [x] E2E compilation test passes
- [x] `cargo clippy` passes for both packages

---

### Phase 6: Documentation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 5 |
| **Parallelizable** | No |

**Objective:** Complete documentation and provide real-world example.

**Deliverables:**
- Updated README with header documentation
- Example demonstrating Anthropic-style beta headers
- Updated rustdoc on all new/modified types

**Acceptance Criteria:**
- [x] README documents header feature
- [x] All public types have rustdoc comments
- [x] `cargo doc` succeeds without warnings


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [CODE: schematic/gen/request_enum.rs]: Return type mismatch with request_structs.rs - `into_parts()` should return `Result` but currently returns plain tuple (pre-existing bug)
- [STRUCTURE: schematic/schematic/schema]: Nested directory structure suggests incomplete refactor from prior work - should be at schematic/schema/
- [PATTERN: into_parts]: The `into_parts()` method returns a tuple that needs extension for headers - changing return type is a breaking change for generated code
- [CODE_GENERATION: syn/quote]: Phases 3-4 will need quote! macro for efficient token stream construction
- [ARCHITECTURE: codegen_modules]: Header propagation requires coordinated changes across 4 codegen files (request_structs.rs, client.rs, api_struct.rs, request_enum.rs)

## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- **No new dependencies required** - quote and syn already present in schematic-gen/Cargo.toml

