---
status: "done"
started_at: 18:45:00
finished_at:
duration:
tts_gender: male
requirements: |
  Implement schematic generator improvements from .ai/prompts/schematic-improvements.md
  Note: Suggestion #3 (Optional Default Derive) has already been implemented via new() constructors.
  Remaining improvements:
  1. Configurable Module Paths - add module_path field to RestApi
  2. Naming Collision Detection - validate before generation
  4. Wrapper Struct Naming Configuration - add request_suffix field
  5. Schema Validation CLI - add validate subcommand
  6. Re-export Path Inference - auto-detect module paths
  7. Definition Examples in Generator Output - add doc examples
required_skills:
  - rust
  - clap
  - thiserror
  - syn
  - prettyplease
  - serde
  - strum
important_skills:
  quote: When generating Rust code with pub use statements and doc comments
  rust-testing: When writing unit tests for validation logic and collision detection
  monorepos: When working across schematic-define, schematic-gen, schematic-definitions crates
subagents: {}
monorepo_modules_impacted:
  - schematic/define (RestApi struct changes)
  - schematic/gen (codegen changes, CLI additions)
  - schematic/definitions (API definition updates)
  - schematic/schema (regenerated output)
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 0
---
# Planning Process

- [x] Prep Started [18:45:00]
    - [x] Identified Skills [18:46:00]
    - [x] Module Assessment Complete [18:46:00]
- [x] Prep complete [18:46:30]
- [x] Clarification [18:47:00]
    - [x] User asked clarifying questions (human in the loop)
    - Scope: All remaining items (P1, P2, P3)
    - Collision behavior: Error with suggestion (halt generation)
    - [x] Requirements have been updated based on user responses
- [x] Planning Subagent [agent: Plan] started [18:48:00]
    - [x] subagent skills used: rust, clap, thiserror, syn, quote
    - [x] Planning completed [18:49:00]
    - 8 phases identified
- [x] Module Assessment [agent: Explore] [18:46:00]
    - [x] subagent skills used: (exploration only)
    - [x] Module Assessment completed [18:46:30]
    - 4 modules impacted: define, gen, definitions, schema
- [x] All Pre-review Steps are complete [18:49:30]
- [x] Review Started [18:50:00]
   - [x] Completeness Review
       - [x] subagent skills used: rust, clap, thiserror
       - 10 recommendations (3 high, 5 medium, 2 low)
   - [x] Concurrency Review
       - [x] subagent skills used: rust
       - 7 recommendations (3 high, 2 medium, 2 low)
   - [x] Correctness Review
       - [x] subagent skills used: rust, syn
       - 10 recommendations (3 high, 4 medium, 3 low)
- [x] Reviews Completed [18:51:00]
- [x] Plan Finalization [agent: general-purpose] started [18:52:00]
    - [x] subagent skills used: rust, clap, thiserror, syn, quote
- [x] Plan finalized [18:53:00]
- Final Steps
    - [x] Lessons learned collected from all subagents
    - [x] No package research needed (all deps already present)
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-20.schematic-generator-improvements.md
    - Started: 18:45:00
    - Completed: 18:53:00
    - Duration: ~8 minutes

## Plan

### Phase 1: RestApi Struct Extensions and Codegen Wiring

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, syn, quote |
| **Suggested Skills** | thiserror (if adding new error variants) |
| **Complexity** | High |
| **Dependencies** | None (foundational) |
| **Parallelizable** | With Phase 2 |

**Objective:** Add `module_path` and `request_suffix` fields to `RestApi` and wire them through all codegen locations atomically.

**Deliverables:**
- Add `module_path: Option<String>` and `request_suffix: Option<String>` to `RestApi` in `define/src/types.rs`
- Add `get_module_path()` and `get_request_suffix()` helpers in `gen/src/output.rs`
- Update all 5 locations using `api.name.to_lowercase()` (lines 78, 96, 140, 192, 206)
- Update `generate_request_struct()` to use configurable suffix
- Update all `define_*_api()` functions with new fields (None defaults)

**Acceptance Criteria:**
- [ ] `RestApi` has both new optional fields
- [ ] All output.rs locations use helper methods
- [ ] All definition files compile with new fields
- [ ] Existing tests pass

---

### Phase 2: Naming Collision Validation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, thiserror |
| **Suggested Skills** | syn (for AST-based detection) |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | With Phase 1 |

**Objective:** Create validation module that detects naming collisions before code generation.

**Deliverables:**
- New `gen/src/validation.rs` with `validate_api()` function
- Add `NamingCollision` and `InvalidRequestSuffix` error variants to `gen/src/errors.rs`
- Validate body type names don't conflict with generated wrapper struct names
- Validate request_suffix is alphanumeric

**Acceptance Criteria:**
- [ ] Collision between body type and endpoint ID returns descriptive error
- [ ] Error message includes suggestion for renamed body type
- [ ] Unit tests cover collision scenarios

---

### Phase 3: Re-export Path Inference

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No |

**Objective:** Auto-detect module paths by scanning schematic-definitions structure.

**Deliverables:**
- New `gen/src/inference.rs` with `infer_module_path()` function
- Search order: exact match → without underscores → common prefix match
- Update `get_module_path()` to use inference as fallback

**Acceptance Criteria:**
- [ ] Infers "ollama" from "OllamaNative" API
- [ ] Explicit module_path overrides inference
- [ ] Unit tests cover search patterns

---

### Phase 4: Schema Validation CLI Subcommand

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, clap |
| **Suggested Skills** | thiserror (for error display) |
| **Complexity** | Medium |
| **Dependencies** | Phase 1, Phase 2 |
| **Parallelizable** | No |

**Objective:** Restructure CLI with validate subcommand that reuses validation.rs.

**Deliverables:**
- Restructure `gen/src/main.rs` with clap subcommands (Generate, Validate)
- `validate` subcommand calls `validate_api()` from validation.rs
- `generate` subcommand validates before generation
- Colored output with checkmarks/warnings

**Acceptance Criteria:**
- [ ] `schematic-gen validate --api openai` works
- [ ] `schematic-gen generate --api openai` still works
- [ ] Validation runs before generation

---

### Phase 5: Documentation Examples in Generated Code

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, quote |
| **Suggested Skills** | syn (for testing) |
| **Complexity** | Low |
| **Dependencies** | Phase 1, Phase 4 |
| **Parallelizable** | No |

**Objective:** Generate doc comments with usage examples for request structs.

**Deliverables:**
- Update `generate_request_struct()` to include `## Example` section
- Use `new()` when available, `Default::default()` otherwise
- Include `..Default::default()` for body types

**Acceptance Criteria:**
- [ ] Generated request structs have example section
- [ ] Examples use `new()` when available
- [ ] Examples compile (verified by cargo doc)

---

### Phase 6: Testing and Schema Regeneration

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, rust-testing |
| **Suggested Skills** | syn (for AST verification) |
| **Complexity** | Medium |
| **Dependencies** | Phases 1-5 |
| **Parallelizable** | No |

**Objective:** Comprehensive test coverage and single batch schema regeneration.

**Deliverables:**
- Unit tests for validation.rs, inference.rs, output.rs
- Integration tests for CLI subcommands
- Schema regeneration: `just -f schematic/justfile generate`
- Verify compilation and clippy pass

**Acceptance Criteria:**
- [ ] All unit tests pass
- [ ] Generated code compiles
- [ ] Generated code passes clippy
- [ ] Coverage > 80%

---

## Dependency Graph

```
Phase 1 (RestApi + Wiring) ─────────────────────┐
                                                │
Phase 2 (Validation) ──── [Parallel] ───────────┤
                                                │
Phase 3 (Inference) ────────── [Depends: P1] ───┤
                                                │
Phase 4 (CLI) ──────────── [Depends: P1, P2] ───┤
                                                │
Phase 5 (Doc Examples) ──── [Depends: P1, P4] ──┤
                                                │
Phase 6 (Testing + Regen) ─ [Depends: ALL] ─────┘
```

## Files to Modify

| File | Phase | Changes |
|------|-------|---------|
| `schematic/define/src/types.rs` | 1 | Add `module_path`, `request_suffix` fields |
| `schematic/gen/src/output.rs` | 1, 3 | Add helpers, update 5 module path locations |
| `schematic/gen/src/codegen/request_structs.rs` | 1, 5 | Configurable suffix, doc examples |
| `schematic/gen/src/errors.rs` | 2 | Add `NamingCollision`, `InvalidRequestSuffix` |
| `schematic/gen/src/validation.rs` | 2 | New file: validation logic |
| `schematic/gen/src/inference.rs` | 3 | New file: path inference |
| `schematic/gen/src/main.rs` | 4 | CLI subcommands |
| `schematic/definitions/src/*/mod.rs` | 1 | Update all `define_*_api()` |
| `schematic/schema/src/*.rs` | 6 | Regenerated output |

## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing.

- [CODE: output.rs]: Module path is derived from `api.name.to_lowercase()` in multiple places (lines 78, 96, 140, 192, 206) - all need updating for module_path support
- [PATTERN: request_structs.rs]: The suffix "Request" is hardcoded at line 50 - signature change will cascade to all callers
- [ARCHITECTURE: schematic]: Three separate crates (define, gen, definitions) require coordinated changes for new RestApi fields

## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation.

