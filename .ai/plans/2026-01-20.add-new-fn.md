# Add `new()` Constructor to Generated Request Structs

**Goal**: Generate `new()` constructors for request structs that enforce required fields at compile-time while keeping `Default` for backward compatibility.

## Context

Currently, all generated request structs derive `Default`, which creates semantically invalid instances (e.g., `model: ""`). This plan adds `new()` constructors that require path parameters and body, giving users a type-safe construction option.

## Scope

**In scope**: Generated request wrapper structs in `schematic/gen/`
**Out of scope**: Body type definitions in `schematic-definitions/` (user-defined, would need derive macro)

## Implementation

### 1. Add `generate_new_impl()` function

**File**: `schematic/gen/src/codegen/request_structs.rs`

Add a new function that generates a `new()` constructor:

```rust
fn generate_new_impl(
    struct_name: &proc_macro2::Ident,
    path_params: &[&str],
    has_body: bool,
    body_type: Option<&str>,
) -> TokenStream {
    let params: Vec<_> = path_params.iter().map(|p| {
        let name = format_ident!("{}", p);
        quote! { #name: impl Into<String> }
    }).collect();

    let field_inits: Vec<_> = path_params.iter().map(|p| {
        let name = format_ident!("{}", p);
        quote! { #name: #name.into() }
    }).collect();

    if has_body {
        let body_ty = format_ident!("{}", body_type.unwrap());
        quote! {
            impl #struct_name {
                /// Creates a new request with the required path parameters and body.
                pub fn new(#(#params,)* body: #body_ty) -> Self {
                    Self {
                        #(#field_inits,)*
                        body,
                    }
                }
            }
        }
    } else if !path_params.is_empty() {
        quote! {
            impl #struct_name {
                /// Creates a new request with the required path parameters.
                pub fn new(#(#params),*) -> Self {
                    Self {
                        #(#field_inits,)*
                    }
                }
            }
        }
    } else {
        // No params, no body - new() is just Default
        quote! {}
    }
}
```

### 2. Integrate into `generate_request_struct()`

**File**: `schematic/gen/src/codegen/request_structs.rs`

Update `generate_request_struct()` to call `generate_new_impl()` and combine the output:

```rust
pub fn generate_request_struct(endpoint: &Endpoint) -> TokenStream {
    // ... existing code ...

    let new_impl = generate_new_impl(
        &struct_name,
        &path_params,
        has_body,
        body_type_name.as_deref(),
    );

    quote! {
        #derives
        pub struct #struct_name {
            #(#fields)*
        }

        #default_impl
        #new_impl      // <-- Add this
        #into_parts_impl
    }
}
```

### 3. Update tests

**File**: `schematic/gen/src/codegen/request_structs.rs` (test module)

Add test cases:

```rust
#[test]
fn generates_new_for_path_param_only() {
    let endpoint = make_endpoint("GetModel", RestMethod::Get, "/models/{model}", None);
    let tokens = generate_request_struct(&endpoint);
    let code = format_generated_code(&tokens).unwrap();

    assert!(code.contains("pub fn new(model: impl Into<String>) -> Self"));
    assert!(code.contains("model: model.into()"));
}

#[test]
fn generates_new_for_path_param_and_body() {
    let endpoint = make_endpoint(
        "CreateMessage",
        RestMethod::Post,
        "/threads/{thread_id}/messages",
        Some(ApiRequest::json_type("CreateMessageBody")),
    );
    let tokens = generate_request_struct(&endpoint);
    let code = format_generated_code(&tokens).unwrap();

    assert!(code.contains("pub fn new(thread_id: impl Into<String>, body: CreateMessageBody) -> Self"));
}

#[test]
fn skips_new_for_empty_request() {
    let endpoint = make_endpoint("ListModels", RestMethod::Get, "/models", None);
    let tokens = generate_request_struct(&endpoint);
    let code = format_generated_code(&tokens).unwrap();

    // No new() needed - Default suffices
    assert!(!code.contains("pub fn new("));
}
```

### 4. Regenerate schemas

After implementation, regenerate all schemas to include the new constructors:

```bash
just -f schematic/justfile generate
```

## Files to Modify

| File | Change |
|------|--------|
| `schematic/gen/src/codegen/request_structs.rs` | Add `generate_new_impl()`, integrate into main generator |
| `schematic/schema/src/*.rs` | Regenerated output (automated) |

## Generated Output Example

**Before**:
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CreateSpeechRequest {
    pub voice_id: String,
    pub body: CreateSpeechBody,
}

impl Default for CreateSpeechRequest { ... }
impl CreateSpeechRequest {
    pub fn into_parts(self) -> Result<...> { ... }
}
```

**After**:
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CreateSpeechRequest {
    pub voice_id: String,
    pub body: CreateSpeechBody,
}

impl Default for CreateSpeechRequest { ... }

impl CreateSpeechRequest {
    /// Creates a new request with the required path parameters and body.
    pub fn new(voice_id: impl Into<String>, body: CreateSpeechBody) -> Self {
        Self {
            voice_id: voice_id.into(),
            body,
        }
    }
}

impl CreateSpeechRequest {
    pub fn into_parts(self) -> Result<...> { ... }
}
```

## Usage Patterns

```rust
// Type-safe construction (new)
let request = CreateSpeechRequest::new("voice-123", CreateSpeechBody {
    text: "Hello".to_string(),
    ..Default::default()
});

// Quick prototyping (Default still works)
let mut request = CreateSpeechRequest::default();
request.voice_id = "voice-123".to_string();
request.body.text = "Hello".to_string();
```

## Verification

1. **Unit tests pass**: `cargo test -p schematic-gen`
2. **Generated code compiles**: `cargo build -p schematic-schema`
3. **Integration tests pass**: `cargo test -p schematic-schema`
4. **Manual verification**: Check a few generated files for correct `new()` signatures

## Future Consideration

Body types (e.g., `CreateSpeechBody`) are defined in `schematic-definitions`, not generated. To add `new()` to those, options include:

1. **Manual**: Add `new()` by hand to each body type
2. **Derive macro**: Create `#[derive(RequiredNew)]` that generates `new()` from non-`Option` fields
3. **Companion struct**: Generate `*Required` structs (discussed but deferred)

This is out of scope for this change but noted for future improvement.
