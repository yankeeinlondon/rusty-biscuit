---
status: "done"
started_at: 21:59:53
finished_at: 22:08:30
duration: 9 minutes
tts_gender: male
requirements:
  Enhance the Sniff library and CLI with improvements across filesystem, git, monorepo, CLI switches, and hardware sections.

  Filesystem Enhancements:
  - Add filesystem.formatting section with editorconfig support
    - Parse ALL properties from .editorconfig including all sections ([*], [*.py], etc.)
    - Include: indent_style, indent_size, tab_width, end_of_line, charset, trim_trailing_whitespace, etc.
  - Add files property to filesystem.languages listing all files per language type

  Git Enhancements:
  - Add dirty property to git.status with:
    - filepath (relative), absolute_filepath
    - diff: FULL unified diff (like 'git diff' output)
    - last_local commit hash, origin commit hash
  - Add untracked property to git.status with filepath and absolute_filepath

  Monorepo Enhancements:
  - Add to each package: primary_language, languages array, detected_managers

  CLI Switches:
  - Add --hardware, --network, --filesystem flags as INCLUDE-ONLY mode
  - When any include flag is used, ONLY those sections are output (skip flags ignored)
  - Without include flags, existing skip flag behavior preserved

  Hardware Enhancements:
  - Add GPU hardware detection (default on, not feature-gated)
  - Add SIMD/AVX/AVX2/AVX512 instruction set detection
required_skills:
  - clap
  - thiserror
  - sysinfo
  - editorconfig
important_skills:
  getifaddrs: network section refactoring
  color-eyre: richer CLI error reporting
  serde: JSON output structure serialization
subagents:
  Plan: phased implementation planning
  Explore: module assessment for monorepo impact
  general-purpose: plan reviews (completeness, concurrency, correctness)
monorepo_modules_impacted:
  - sniff/lib/src/filesystem/mod.rs (formatting, languages)
  - sniff/lib/src/filesystem/git.rs (dirty, untracked)
  - sniff/lib/src/filesystem/languages.rs (files per language)
  - sniff/lib/src/filesystem/monorepo.rs (per-package info)
  - sniff/lib/src/hardware/mod.rs (gpu, simd)
  - sniff/lib/src/hardware/cpu.rs (simd)
  - sniff/cli/src/main.rs (CLI flags)
  - sniff/cli/src/output.rs (new output sections)
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 7
---
# Planning Process

- [x] Prep Started [2026-01-05 21:59:53]
    - [x] Identified Skills [2026-01-05 22:00:35]
    - [x] Identified Subagents [2026-01-05 22:00:35]
- [x] Prep complete with 80% context available [2026-01-05 22:00:35]
- [x] Clarify [orchestrator] started [2026-01-05 22:01:00]
    - [x] User asked clarifying questions (human in the loop) [2026-01-05 22:02:15]
    - [x] Requirements have been updated based on user responses [2026-01-05 22:02:30]
- [x] Planning Subagent [agent: **Plan**] started [2026-01-05 22:02:30]
    - [x] subagent skills used: clap, thiserror, sysinfo, editorconfig, serde
    - [x] Planning completed [2026-01-05 22:04:15]
- [x] Module Assessment Subagent [agent: **Explore**] started [2026-01-05 22:02:30]
    - [x] subagent skills used: clap, thiserror, serde
    - [x] Module Assessment completed [2026-01-05 22:04:15]
- [x] All Pre-review Steps are complete
    - 70% of context window is still available
- [x] Review Started [2026-01-05 22:05:00]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: clap, thiserror, sysinfo, editorconfig, serde
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: clap, thiserror
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
        - [x] subagent skills used: clap, thiserror, sysinfo, editorconfig, serde
- [x] Reviews Completed [2026-01-05 22:06:30]
    - 65% of context window is still available
- [x] Plan Finalization [agent: **general-purpose**] started [2026-01-05 22:06:30]
    - [x] subagent skills used: clap, thiserror, sysinfo, editorconfig
- [x] Plan finalized [2026-01-05 22:08:30]
    - 60% of context window is still available
- Final Steps
    - [x] Lessons learned collected from all subagents
    - [x] Researching 1 package [2026-01-05 22:08:30]
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-05.plan-for-sniff-plus-enhancements.md
    - Started: 2026-01-05 21:59:53
    - Completed: 2026-01-05 22:08:30
    - Duration: 9 minutes



## Plan

### Phase 1: Add EditorConfig Support to Filesystem Module

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | editorconfig, serde |
| **Suggested Skills** | thiserror (error handling) |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 2, Phase 5) |

**Objective:** Add a `filesystem.formatting` section that parses `.editorconfig` files and exposes all properties organized by glob section.

**Deliverables:**
- New `formatting.rs` module in `sniff/lib/src/filesystem/`
- `FormattingConfig` struct with section-based EditorConfig properties
- `detect_formatting()` function using `ec4rs` crate
- Integration into `FilesystemInfo` struct

**Acceptance Criteria:**
- [ ] `ec4rs` dependency added to `sniff-lib/Cargo.toml`
- [ ] All EditorConfig properties captured (indent_style, tab_width, charset, etc.)
- [ ] Multiple sections preserved ([*], [*.py], [Makefile])
- [ ] Unit tests cover multi-section parsing
- [ ] Returns `None` when no `.editorconfig` exists

---

### Phase 2: Add Files Property to Language Detection

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | serde |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 1, Phase 5) |

**Objective:** Extend `LanguageStats` to include the list of files detected for each language type.

**Deliverables:**
- Extended `LanguageStats` struct with `files: Vec<PathBuf>` field
- Modified `detect_languages()` to collect file paths per language
- Updated serialization

**Acceptance Criteria:**
- [ ] `LanguageStats.files` contains all detected file paths
- [ ] Paths are relative to scanned root
- [ ] Existing percentage/file_count calculations preserved
- [ ] Unit tests verify collection across multiple languages

---

### Phase 3: Enhance Git Status with Dirty and Untracked Details

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | thiserror, serde |
| **Suggested Skills** | None |
| **Complexity** | High |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 4, Phase 6) |

**Objective:** Add detailed `dirty` and `untracked` arrays to `git.status` with file paths, absolute paths, diffs, and commit hashes.

**Deliverables:**
- New `DirtyFile` struct: filepath, absolute_filepath, diff, last_local_commit, origin_commit
- New `UntrackedFile` struct: filepath, absolute_filepath
- Extended `RepoStatus` with `dirty: Vec<DirtyFile>` and `untracked: Vec<UntrackedFile>`
- Diff generation using `git2::Diff`

**Acceptance Criteria:**
- [ ] `dirty` array contains modified/staged files with full unified diffs
- [ ] `untracked` array contains all untracked files
- [ ] Paths are both relative and absolute
- [ ] `last_local_commit` is HEAD SHA
- [ ] `origin_commit` is remote tracking branch SHA (or None)
- [ ] Unit tests cover staged, unstaged, untracked scenarios

---

### Phase 4: Enhance Monorepo Package Information

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | serde |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 3, Phase 6) |

**Objective:** Add `primary_language`, `languages` array, and `detected_managers` to each monorepo package.

**Deliverables:**
- Extended `PackageLocation` struct with new fields
- Per-package language detection (reuse existing logic)
- Per-package dependency manager detection

**Acceptance Criteria:**
- [ ] Each package has `primary_language` populated
- [ ] Each package has `languages` array
- [ ] Each package has `detected_managers` list
- [ ] Detection scoped to package directory only
- [ ] Unit tests verify per-package detection

---

### Phase 5: Add GPU Detection to Hardware Module

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | sysinfo, serde |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 1, Phase 2) |

**Objective:** Add cross-platform GPU detection as a default feature.

**Deliverables:**
- New `gpu.rs` module in `sniff/lib/src/hardware/`
- `GpuInfo` struct with name, vendor, device_type, backend, memory
- `detect_gpu()` function using `wgpu`
- Extended `HardwareInfo` struct

**Acceptance Criteria:**
- [ ] `wgpu` dependency added
- [ ] GPU detection works on macOS (Metal), Linux (Vulkan), Windows (D3D12)
- [ ] Multiple GPUs detected on multi-adapter systems
- [ ] Graceful fallback when no GPU available

---

### Phase 6: Add SIMD/AVX Instruction Set Detection

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | sysinfo, serde |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 3, Phase 4) |

**Objective:** Detect available SIMD instruction sets (SSE, AVX, AVX2, AVX-512) on the CPU.

**Deliverables:**
- New `SimdCapabilities` struct in `cpu.rs`
- Extended `CpuInfo` struct with `simd: SimdCapabilities`
- Detection using `std::arch::is_x86_feature_detected!` macro

**Acceptance Criteria:**
- [ ] SIMD capabilities detected on x86_64
- [ ] ARM NEON detected on aarch64
- [ ] Graceful handling on unsupported architectures
- [ ] No external dependencies (uses std library)

---

### Phase 7: Implement CLI Include-Only Mode Flags

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | clap, thiserror |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1, Phase 3, Phase 5, Phase 6 |
| **Parallelizable** | No |

**Objective:** Add `--hardware`, `--network`, `--filesystem` flags that enable include-only mode.

**Deliverables:**
- New CLI flags in `sniff/cli/src/main.rs`
- Logic to detect include-only mode
- Modified config building to respect include vs skip semantics

**Acceptance Criteria:**
- [ ] `sniff --hardware` outputs only hardware section
- [ ] `sniff --network --filesystem` outputs those two, skips hardware
- [ ] `sniff --hardware --skip-network` ignores skip flag
- [ ] Default behavior (no flags) preserved
- [ ] Help text explains include-only vs skip behavior

---

### Phase 8: Update Output Formatting and Testing

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | clap, serde |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 1-7 |
| **Parallelizable** | No |

**Objective:** Update CLI text output and ensure comprehensive test coverage.

**Deliverables:**
- Extended `output.rs` to render new fields
- Integration tests for all new functionality
- New test fixtures
- CLI tests for include-only mode

**Acceptance Criteria:**
- [ ] Text output displays EditorConfig, dirty files, GPU, SIMD
- [ ] Verbosity-aware output (diffs at `-v`, full file lists at `-vv`)
- [ ] All new features have integration tests
- [ ] Documentation updated in help text

---

## Execution Order

```
Parallel Group A: Phases 1, 2, 5 (filesystem formatting, language files, GPU)
Parallel Group B: Phases 3, 4, 6 (git status, monorepo, SIMD)
Sequential: Phase 7 (CLI flags) after library changes
Final: Phase 8 (output and testing) after all phases
```


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [SKILL: sysinfo]: Does not provide CPU instruction set detection - must use std::arch macros instead
- [CRATE: wgpu]: Async/Future-based API requires architectural changes; prefer synchronous alternatives like hardware-query for detection tasks
- [CRATE: git2]: Diff::print() is callback-based, not buffer-returning; requires accumulator pattern with closures
- [CRATE: git2]: Use `branch_upstream_remote()` for dynamic remote discovery instead of hardcoding "origin"
- [MACRO: is_x86_feature_detected!]: Requires `#[cfg(target_arch)]` guards to compile on non-x86 targets
- [CRATE: ec4rs]: Must call `use_fallbacks()` after `properties_of()` for spec-compliant tab_width/indent_size behavior
- [ARCHITECTURE: hardware-query]: Already integrated as optional feature with gpu-all; no need for wgpu dependency


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- [ADD]: ec4rs@1 in cargo - EditorConfig parsing with spec compliance
    - "How to parse all sections from .editorconfig including custom properties?"
- [UPDATE]: hardware-query in cargo - Remove optional flag, make GPU detection always available
- [REMOVE]: gpu feature flag in cargo - No longer needed with mandatory hardware-query

