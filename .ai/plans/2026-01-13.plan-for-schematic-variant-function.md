---
status: "done"
started_at: "13:23:00"
finished_at: "13:32:00"
duration: "9 minutes"
tts_gender: male
requirements: |
  ## Refined Requirements (after clarification)

  1. **Generated struct fields** - Add auth configuration storage:
     - env_auth: Vec<String> - env var names for auth credentials
     - auth_strategy: AuthStrategy - authentication method to use
     - env_username: Option<String> - env var for BasicAuth username

  2. **variant() method** - Create API variants with different config:
     - Signature: pub fn variant(base_url: impl Into<String>, env_auth: Vec<String>, strategy: UpdateStrategy) -> Self
     - Creates new instance with specified base_url and env_auth
     - Strategy determines auth: NoChange (inherit) or ChangeTo(AuthStrategy)

  3. **UpdateStrategy enum** (in schematic-define):
     - NoChange - keep current AuthStrategy
     - ChangeTo(AuthStrategy) - switch to specified strategy

  4. **BasicAuth simplification**:
     - Remove env_password from RestApi struct
     - BasicAuth uses env_username for username, env_auth[0] for password

  5. **Client codegen updates**:
     - Auth reads from struct fields (not hardcoded)
     - BasicAuth: self.env_username for username, self.env_auth[0] for password
required_skills:
  - syn
  - prettyplease
  - thiserror
  - rust
important_skills:
  rust-testing: "When updating test suites"
  strum: "For UpdateStrategy enum derives (consistency with RestMethod)"
subagents:
  Plan: "Create phased implementation plan"
  Explore: "Module impact assessment (monorepo)"
  general-purpose: "Reviews (completeness, concurrency, correctness)"
  feature-tester-rust: "Test updates validation"
monorepo_modules_impacted:
  - schematic-define (types.rs, auth.rs, lib.rs, apis/openai.rs)
  - schematic-gen (codegen/client.rs, codegen/api_struct.rs, codegen/request_enum.rs, output.rs, test_utils.rs)
  - schematic-gen/tests (e2e_generation.rs, http_client.rs)
completeness_changes:
  - "Added architectural decision note about auth credential resolution"
concurrency_changes:
  - "Confirmed Phase 4 and 5 can proceed in parallel after Phase 3"
detail_changes:
  - "Clarified BasicAuth intentionally removes env_password"
  - "Noted reqwest::Client implements Clone (no wrapper needed)"
lessons_learned_count: 2
---
# Planning Process

- [x] Prep Started [13:23]
    - [x] Identified Skills [13:24]
    - [x] Identified Subagents [13:24]
- [x] Prep complete with 35% context available [13:24]
- [x] Clarification (orchestrator direct) [13:26]
    - [x] User asked clarifying questions (human in the loop) [13:25]
    - [x] Requirements have been updated based on user responses [13:26]
- [x] Planning Subagent [agent: **Plan**] started [13:26]
    - [x] subagent skills used: syn, prettyplease, thiserror, rust
    - [x] Planning completed [13:29]
- [x] Module Assessment Subagent [agent: **Explore**] started [13:26]
    - [x] subagent skills used: rust
    - [x] Module Assessment completed [13:29]
- [x] All Pre-review Steps are complete
    - 35% of context window is still available
- [x] Review Started [13:29]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: rust
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, syn
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
        - [x] subagent skills used: rust, syn
- [x] Reviews Completed [13:31]
    - 30% of context window is still available
- [x] Plan Finalization (orchestrator direct) [13:31]
    - [x] Incorporated review feedback
- [x] Plan finalized [13:32]
    - 30% of context window is still available
- Final Steps
    - [x] Lessons learned collected from all subagents
    - [x] Researching 0 packages (none required)
- [x] Summarized plan to user via STDOUT
    - Project File: 2026-01-13.plan-for-schematic-variant-function.md
    - Started: 13:23
    - Completed: 13:32
    - Duration: 9 minutes


## Architectural Decision: Auth Credential Resolution

**Struct fields store env var NAMES, not credentials:**
- Generated struct stores `env_auth: Vec<String>` containing environment variable names (e.g., `["OPENAI_API_KEY"]`)
- At request time, credentials are read from these env vars using `std::env::var()`
- This preserves env-only auth (no secrets stored in memory) while enabling runtime configuration of which env vars to check


## Plan

### Phase 1: Add UpdateStrategy Enum to schematic-define

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, thiserror |
| **Suggested Skills** | strum (for derive macros) |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 2) |

**Objective:** Define the `UpdateStrategy` enum in `schematic-define/src/auth.rs`.

**Deliverables:**
- `UpdateStrategy` enum with `NoChange` and `ChangeTo(AuthStrategy)` variants
- Derive `Debug`, `Clone`, `PartialEq`, `Eq`
- Re-export from `lib.rs`

**Acceptance Criteria:**
- [ ] Enum exists in `auth.rs` and re-exported
- [ ] Doc comments explain usage
- [ ] Unit tests verify behavior

---

### Phase 2: Remove env_password from RestApi

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 1) |

**Objective:** Remove `env_password` field from `RestApi` struct (intentional breaking change).

**Deliverables:**
- Remove `env_password: Option<String>` from `RestApi` in `types.rs`
- Update doc comments (BasicAuth uses `env_username` + `env_auth[0]`)
- Update OpenAI API definition
- Update all test helpers

**Note:** BasicAuth now uses:
- Username: env var from `env_username` field
- Password: env var from `env_auth[0]` (first element of env_auth)

**Acceptance Criteria:**
- [ ] `env_password` field removed
- [ ] Documentation updated
- [ ] `cargo check -p schematic-define` passes

---

### Phase 3: Update Generated API Struct Fields

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, rust |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 1, Phase 2 |
| **Parallelizable** | No |

**Objective:** Modify `generate_api_struct()` to add auth configuration fields.

**Deliverables:**
- Add `env_auth: Vec<String>` field
- Add `auth_strategy: schematic_define::AuthStrategy` field
- Add `env_username: Option<String>` field
- Update all 4 constructors: `new()`, `with_base_url()`, `with_client()`, `with_client_and_base_url()`

**Technical Note:** `reqwest::Client` implements `Clone`, so no wrapper type needed.

**Acceptance Criteria:**
- [ ] Generated struct includes new fields
- [ ] All constructors properly initialize
- [ ] Generated code passes `syn::parse2` validation

---

### Phase 4: Add variant() Method

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, rust |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 3 |
| **Parallelizable** | Yes (with Phase 5) |

**Objective:** Generate `variant()` method on API struct.

**Deliverables:**
- `variant(&self, base_url: impl Into<String>, env_auth: Vec<String>, strategy: UpdateStrategy) -> Self`
- `NoChange` preserves current auth_strategy
- `ChangeTo(s)` sets new auth_strategy

**Acceptance Criteria:**
- [ ] Method generated with correct signature
- [ ] Both UpdateStrategy variants work correctly
- [ ] Method clones client, not creates new

---

### Phase 5: Update Client Auth to Use Struct Fields

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, rust |
| **Suggested Skills** | None |
| **Complexity** | High |
| **Dependencies** | Phase 3 |
| **Parallelizable** | Yes (with Phase 4) |

**Objective:** Modify `generate_auth_setup()` to read from struct fields at runtime.

**Deliverables:**
- Generate runtime match on `self.auth_strategy`
- BearerToken/ApiKey read from `self.env_auth`
- BasicAuth: `self.env_username` for username, `self.env_auth[0]` for password
- Proper error handling when env_auth is empty or env var not set

**Acceptance Criteria:**
- [ ] Auth generates runtime match expression
- [ ] All auth strategies work correctly
- [ ] BasicAuth uses env_username + env_auth[0]

---

### Phase 6: Update Tests

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, rust-testing |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 2, Phase 3, Phase 4, Phase 5 |
| **Parallelizable** | No |

**Objective:** Update all test helpers and add new tests.

**Deliverables:**
- Update `make_api()` helpers (remove env_password)
- Update `make_basic_auth_api()` helpers
- Add tests for `variant()` method
- Add tests for runtime auth matching

**Acceptance Criteria:**
- [ ] `cargo test -p schematic-gen` passes
- [ ] E2E tests pass

---

### Phase 7: Add schematic-define Dependency

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 5 |
| **Parallelizable** | Yes (with Phase 6) |

**Objective:** Update generated code to import `schematic-define`.

**Deliverables:**
- Add `schematic-define` to generated `Cargo.toml`
- Add `use schematic_define::{AuthStrategy, UpdateStrategy};` import

**Acceptance Criteria:**
- [ ] Generated Cargo.toml includes dependency
- [ ] Generated code compiles

---

### Phase 8: Integration Testing

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, rust-testing |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 6, Phase 7 |
| **Parallelizable** | No |

**Objective:** Full integration validation.

**Deliverables:**
- All unit tests pass
- E2E compilation tests pass
- Generated code passes clippy
- New E2E test for variant() usage

**Acceptance Criteria:**
- [ ] `just -f schematic/justfile test` passes
- [ ] Generated code passes clippy

---

## Dependency Graph (Updated)

```
Phase 1 ──────┬──────→ Phase 3 ──┬──→ Phase 4 ──────┐
Phase 2 ──────┘                  │                  │
                                 └──→ Phase 5 ──────┼──→ Phase 6 ──→ Phase 8
                                      │             │
                                      └──→ Phase 7 ─┘
```

Key optimizations from review:
- Phase 4 and 5 can run in parallel after Phase 3
- Phase 6 and 7 can run in parallel


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing.

- [ARCHITECTURAL: schematic/]: Removing env_password from RestApi means BasicAuth behavior shifts from two-field (env_username + env_password) to unified approach (env_username + env_auth[0]). This is a breaking change for generated code consumers.
- [TECHNICAL: reqwest::Client]: The correctness reviewer questioned whether reqwest::Client implements Clone. It does - no wrapper type needed for generated structs.


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- No new packages required - existing dependencies sufficient

