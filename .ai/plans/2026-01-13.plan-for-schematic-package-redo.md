---
status: "done"
started_at: "10:45:00"
finished_at: "10:57:00"
duration: "12 minutes"
tts_gender: male
requirements: |
  Implement a meta-programming approach to defining REST APIs and generating user-friendly enumerations.

  ## Package Structure
  - `schematic/define` - Definition Library: Where APIs and SchemaObjects are defined
  - `schematic/schema` - Schema Library: Where generated symbols live after transformation

  ## Clarified Requirements (from user)
  - **Generation approach**: Build-time binary (standalone CLI that reads definitions, writes .rs files)
  - **HTTP execution**: Include reqwest client with generated code (batteries-included)
  - **Output location**: Sibling schema/ directory (schematic/define → schematic/schema)
  - **Existing code**: Full replacement - remove existing implementation, start fresh

  ## Definition Stage Requirements
  - Define APIs with: Authentication/Authorization strategy, Base URL, metadata (name, description, doc URL)
  - Define endpoints with: method (GET, PUT, POST, etc.), path, request type, response type, id (for enum variant)

  ## Generation Stage Requirements
  - Transform `RestApi` definitions into `Api` struct + bespoke enumeration
  - Generate public instance of `Api` struct named after API (PascalCase)
  - Implement `request(enum)` method on Api struct with reqwest integration
  - Generate enum with 1:1 variants to endpoints, each requiring strongly typed request object
  - Copy SchemaObjects for type grounding
  - Include complete HTTP client implementation using reqwest

  ## Key Technical Details
  - Use `syn` crate for Rust AST parsing
  - Use `proc_macro2` and `quote` for code generation
  - Types: RestApi, Endpoint, RestMethod, AuthStrategy, ApiResponse, Schema, SchemaObject trait
  - Generated code should support Default trait for request structs
  - Path parameter substitution (e.g., `/models/{model}`)

  ## Developer Experience Goals
  - Callers can use `OpenAiRequest::RetrieveModel(RetrieveModelRequest::default())`
  - Support `From` impl for automatic conversion
  - `into_parts()` method returns (method, path, body) tuple
  - Single `request()` call executes HTTP and returns typed response
required_skills: [syn, prettyplease, thiserror, rust]
important_skills:
  schemars: "when implementing JSON Schema generation"
  strum: "when implementing generated enums with utilities"
  reqwest: "when implementing HTTP client functionality"
  serde: "when implementing serialization/deserialization"
  rust-testing: "when writing tests for code generation"
subagents:
  Plan: "create phased implementation plan"
  Explore: "assess monorepo module impacts"
  general-purpose: "reviews and finalization"
  feature-tester-rust: "test implementation phases"
monorepo_modules_impacted:
  - root Cargo.toml (add new workspace members)
  - schematic/define (NEW - Definition Library)
  - schematic/schema (NEW - Generated Code Library)
  - schematic/gen (NEW - Build-Time Code Generator)
  - biscuit/shared (pattern reference - codegen utilities)
  - api-macros (document as legacy)
completeness_changes:
  - "HIGH: Add quote crate to Phases 5-7 required skills"
  - "HIGH: Explicitly add From impl generation to Phase 6"
  - "HIGH: Add into_parts() method generation to Phase 6"
  - "MEDIUM: Add validation phase before code generation"
  - "MEDIUM: Clarify --dry-run behavior in Phase 3"
concurrency_changes:
  - "HIGH: Fix Phase 8 contradiction - dependent AND parallelizable"
  - "HIGH: Fix Phase 10 file I/O race with Phase 9"
  - "HIGH: Split Phase 11 into incremental unit tests + E2E"
  - "MEDIUM: Start Phase 12-13 planning earlier"
detail_changes:
  - "HIGH: Add regex + once_cell dependencies for Phase 4"
  - "HIGH: Fix From impl generator bug (Vec vs individual impls)"
  - "HIGH: Add reqwest client initialization to Phase 7"
  - "HIGH: Define SchematicError type"
  - "HIGH: Handle body serialization errors (no unwrap)"
  - "MEDIUM: Handle query parameters in Phase 4"
lessons_learned_count: 7
---
# Planning Process

- [x] Prep Started [10:45am]
    - [x] Identified Skills [10:46am] - syn, prettyplease, thiserror, rust (required); schemars, strum, reqwest, serde, rust-testing (suggested)
    - [x] Identified Subagents [10:46am] - Plan, Explore, general-purpose, feature-tester-rust
- [x] Prep complete [10:46am]
- [x] Clarify (orchestrator direct) [10:47am]
    - [x] User asked clarifying questions (human in the loop) [10:47am]
    - [x] Requirements have been updated based on user responses [10:47am]
- [x] Planning Subagent [agent: **Plan**] started [10:47am]
    - [x] subagent skills used: syn, prettyplease, thiserror, strum, clap, reqwest, serde
    - [x] Planning completed [10:52am]
- [x] Module Assessment Subagent [agent: **Explore**] started [10:47am]
    - [x] subagent skills used: rust
    - [x] Module Assessment completed [10:52am]
- [x] All Pre-review Steps are complete [10:52am]
- [x] Review Started [10:53am]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: syn, prettyplease, thiserror, rust, serde, strum, reqwest
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
        - [x] subagent skills used: syn, rust
- [x] Reviews Completed [10:54am]
- [x] Plan Finalization [agent: **general-purpose**] started [10:55am]
    - [x] subagent skills used: syn, prettyplease, thiserror, strum, clap
- [x] Plan finalized [10:56am]
- Final Steps
    - [x] Lessons learned collected from all subagents
    - [x] Researching 0 packages (none required)
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-13.plan-for-schematic-package-redo.md
    - Started: 10:45am
    - Completed: 10:57am
    - Duration: ~12 minutes



## Plan

### Architecture Overview

```
schematic/
├── define/                      # Definition Library
│   ├── Cargo.toml
│   └── src/
│       ├── lib.rs              # Re-exports
│       ├── types.rs            # RestApi, Endpoint, RestMethod
│       ├── schema.rs           # SchemaObject trait + Schema descriptor
│       ├── auth.rs             # AuthStrategy enum
│       ├── response.rs         # ApiResponse enum
│       └── apis/               # API definitions
│           └── openai.rs       # Example
│
├── gen/                         # Generator Binary
│   ├── Cargo.toml
│   └── src/
│       ├── main.rs             # CLI entry point
│       ├── errors.rs           # Generator errors
│       ├── parser.rs           # Path parameter extraction
│       └── codegen/
│           ├── api_struct.rs   # Generate Api struct
│           ├── request_enum.rs # Generate request enum
│           ├── request_structs.rs
│           └── client.rs       # Generate reqwest client
│
└── schema/                      # Generated Output
    └── src/
        └── lib.rs              # Generated code
```

### Phase 1: Foundation - Definition Library Core Types

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | thiserror, serde, strum |
| **Suggested Skills** | rust (for idioms) |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | No |

**Objective:** Create `schematic/define` library with core type definitions.

**Deliverables:**
- `schematic/define/Cargo.toml` with dependencies
- `types.rs` with `RestApi`, `Endpoint`, `RestMethod`
- `schema.rs` with `SchemaObject` trait and `Schema` descriptor
- `auth.rs` with `AuthStrategy` enum
- `response.rs` with `ApiResponse` enum

**Acceptance Criteria:**
- [x] All types compile and pass `cargo check`
- [x] `RestMethod` supports strum Display/EnumIter/EnumString
- [x] SchemaObject trait has bounds (Serialize, DeserializeOwned, Debug, Clone, Send, Sync, 'static)
- [x] Unit tests verify enum string parsing

---

### Phase 2: Example API Definition

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | serde |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No |

**Objective:** Create example OpenAI API definition to validate type system.

**Deliverables:**
- `apis/openai.rs` with complete OpenAI API definition
- Schema objects (Model, ListModelsResponse)
- `define_openai_api()` function

**Acceptance Criteria:**
- [x] At least 3 endpoints defined
- [x] Path parameters demonstrated (`/models/{model}`)

---

### Phase 3: Generator Binary Scaffold

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | clap, thiserror |
| **Suggested Skills** | rust |
| **Complexity** | Medium |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (with Phase 2) |

**Objective:** Create generator binary scaffold with CLI and error types.

**Deliverables:**
- `schematic/gen/Cargo.toml`
- `main.rs` with clap CLI
- `errors.rs` with GeneratorError enum

**Acceptance Criteria:**
- [x] CLI parses arguments correctly
- [x] `--help` displays usage
- [x] `--dry-run` flag prevents file writes

---

### Phase 4: Path Parameter Extraction

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (with Phases 2, 3) |

**Objective:** Implement path parameter extraction from endpoint paths.

**Deliverables:**
- `parser.rs` with path parameter extraction
- Unit tests for various path patterns

**Acceptance Criteria:**
- [x] Extracts `/models/{model}` → `["model"]`
- [x] Handles multiple params and no params

---

### Phase 5: Request Struct Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, quote |
| **Suggested Skills** | rust |
| **Complexity** | High |
| **Dependencies** | Phase 1, Phase 4 |
| **Parallelizable** | No |

**Objective:** Generate per-endpoint request structs.

**Deliverables:**
- `codegen/request_structs.rs`
- Path params → String fields, body field, Default impl
- `into_parts()` method for path substitution

**Acceptance Criteria:**
- [x] Generates request struct per endpoint
- [x] Default trait implemented
- [x] Generated code passes syn validation

---

### Phase 6: Request Enum Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, quote |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 5 |
| **Parallelizable** | No |

**Objective:** Generate unified request enum with From implementations.

**Deliverables:**
- `codegen/request_enum.rs`
- Enum with one variant per endpoint
- `From` implementations for request structs

**Acceptance Criteria:**
- [x] `into_parts()` returns (method, path, body)
- [x] From impls allow `.into()` conversion

---

### Phase 7: API Struct and Client Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, quote, reqwest |
| **Suggested Skills** | rust |
| **Complexity** | High |
| **Dependencies** | Phase 6 |
| **Parallelizable** | No |

**Objective:** Generate API struct with reqwest HTTP client.

**Deliverables:**
- `codegen/api_struct.rs` and `codegen/client.rs`
- API struct with BASE_URL, `new()`, `request()` method
- Auth header application based on AuthStrategy

**Acceptance Criteria:**
- [x] `request()` handles all HTTP methods
- [x] Authentication headers correctly applied
- [x] Error handling for non-success responses

---

### Phase 8: Error Types for Generated Code

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | thiserror, syn, quote |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 7 |
| **Parallelizable** | Yes (with Phase 7) |

**Objective:** Generate SchematicError enum for runtime errors.

**Deliverables:**
- Error type generation module
- HTTP, JSON, API error variants

**Acceptance Criteria:**
- [x] From impls for reqwest and serde_json errors
- [x] Descriptive error messages

---

### Phase 9: Output Assembly and File Writing

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phases 5-8 |
| **Parallelizable** | No |

**Objective:** Assemble generated code and write to disk.

**Deliverables:**
- `output.rs` for file assembly
- Atomic writes (temp file + rename)
- Generated lib.rs with all modules

**Acceptance Criteria:**
- [x] syn validation before writing
- [x] prettyplease formatting
- [x] Atomic writes prevent corruption

---

### Phase 10: Schema Package Cargo.toml Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 9 |
| **Parallelizable** | Yes (with Phase 9) |

**Objective:** Generate Cargo.toml for schema package.

**Deliverables:**
- Generated Cargo.toml with reqwest, serde, thiserror deps

**Acceptance Criteria:**
- [x] Valid Cargo.toml syntax
- [x] All runtime dependencies included

---

### Phase 11: Integration and E2E Testing

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust |
| **Suggested Skills** | wiremock |
| **Complexity** | High |
| **Dependencies** | All previous phases |
| **Parallelizable** | No |

**Objective:** Create comprehensive tests for generation pipeline.

**Deliverables:**
- Integration tests in `schematic/gen/tests/`
- Mock server tests for HTTP client
- E2E: define → generate → compile → execute

**Acceptance Criteria:**
- [x] Path parameter substitution works
- [x] HTTP client sends correct requests
- [x] Generated code compiles without warnings

---

### Phase 12: Justfile and Workspace Integration

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 10 |
| **Parallelizable** | Yes (with Phase 11) |

**Objective:** Integrate into monorepo workspace.

**Deliverables:**
- Update root Cargo.toml workspace members
- Create schematic/justfile

**Acceptance Criteria:**
- [x] `just -f schematic/justfile build` works
- [x] `just -f schematic/justfile generate` runs generator

---

### Phase 13: Documentation and Examples

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 11 |
| **Parallelizable** | Yes (with Phase 12) |

**Objective:** Create documentation and usage examples.

**Deliverables:**
- Doc comments on all public types
- Usage examples in doc tests

**Acceptance Criteria:**
- [x] All public items have doc comments
- [x] Doc tests compile and pass

---

### Dependency Graph

```
Phase 1 (Foundation)
    |
    +---> Phase 2 (Example API) --+
    +---> Phase 3 (CLI Scaffold)  |
    +---> Phase 4 (Path Params) --+
                                  |
                                  v
                           Phase 5 (Request Structs)
                                  |
                                  v
                           Phase 6 (Request Enum)
                                  |
                                  v
                           Phase 7 (API Struct + Client)
                                  |
    +-----------------------------+-----------------------------+
    |                             |                             |
    v                             v                             v
Phase 8 (Errors)          Phase 9 (Output)           Phase 10 (Cargo.toml)
    |                             |                             |
    +-----------------------------+-----------------------------+
                                  |
                                  v
                           Phase 11 (Testing)
                                  |
                   +--------------+--------------+
                   |                             |
                   v                             v
           Phase 12 (Justfile)         Phase 13 (Docs)
```


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [SKILL: syn]: The existing codebase uses syn 2.x with "full" and "parsing" features - appropriate for file-level parsing
- [PATTERN: codegen]: The biscuit/codegen module demonstrates atomic write pattern (tempfile + rename) that should be replicated
- [PATTERN: cli]: The ai-pipeline/gen CLI structure with verbosity levels and dry-run is the established pattern
- [ARCHITECTURE: edition]: ai-pipeline/lib uses edition 2021, all others use 2024 - minor interop consideration
- [ARCHITECTURE: api-macros]: Crate exists but is not integrated - document as legacy; new design uses build-time binary
- [CODE_GEN_PATTERN: From impl]: Common mistake with quote! - generating `impl From<Vec<T>>` when separate impls needed for each T
- [SKILL: prettyplease]: Only accepts `syn::File` - must wrap single items; no configuration knobs

## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- [ADD(schematic-define)]: serde in cargo - Serialization for definition types
- [ADD(schematic-define)]: strum in cargo - Enum string conversion utilities
- [ADD(schematic-define)]: thiserror in cargo - Error type definitions
- [ADD(schematic-gen)]: syn in cargo - AST parsing and code generation
- [ADD(schematic-gen)]: quote in cargo - TokenStream generation
- [ADD(schematic-gen)]: prettyplease in cargo - Code formatting
- [ADD(schematic-gen)]: clap in cargo - CLI argument parsing
- [ADD(schematic-gen)]: regex in cargo - Path parameter extraction (conditional)
- [ADD(schematic-gen)]: once_cell in cargo - Lazy static patterns (conditional)
- [ADD(schematic-schema)]: reqwest in cargo - HTTP client for generated code
- [ADD(schematic-schema)]: serde_json in cargo - JSON serialization
- [ADD(schematic-schema)]: thiserror in cargo - Runtime error types
- [ADD(schematic-gen/tests)]: wiremock in cargo - HTTP mocking for tests
