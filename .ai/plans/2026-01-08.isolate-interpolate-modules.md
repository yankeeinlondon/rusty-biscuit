---
status: "done"
started_at: 10:23:00
finished_at: 10:28:00
duration: 5 minutes
tts_gender: male
requirements: |
  Implement the `isolate` and `interpolate` modules in the shared library.

  ## Refined Requirements (after D1 clarification)

  **HTML Parser Decision**: Use scraper crate (already a dependency), document trade-offs inline.

  **IsolateAction Enum**:
  - LeaveAsVector - returns Vec<Cow<str>>
  - Concatenate(Option<String>) - joins with optional delimiter (None = no delimiter)

  **MarkdownScope Enum** (expanded):
  - Frontmatter, Prose, CodeBlock, BlockQuote, Heading, Stylized, Italicized, NonItalicized
  - ADD: Links, Images, Lists, Tables, FootnoteDefinitions

  **Zero-copy**: Use Cow<str> for return types where possible to avoid unnecessary allocations.

  ## Original Requirements

  Key requirements:
  - Both modules support markdown and HTML document contexts
  - Use `pulldown-cmark` and `markdown-rs` crates for markdown parsing
  - Use `scraper` crate for HTML DOM parsing
  - Phase `isolate` functions first to enable reuse in `interpolate`

  Isolate module:
  - `md_isolate(content, scope, action)` - isolate markdown document sections
  - `html_isolate(content, scope, action)` - isolate HTML document sections

  Interpolate module:
  - Context unaware: `interpolate(find, replace)`, `interpolate_regex(find, replace)`
  - Context aware: `md_interpolate(scope, find, replace)`, `html_interpolate(scope, find, replace)`
  - `HtmlScope` enum: TagAttributes, InnerHtml, OuterHtml, Selector, Prose
  - `HtmlTag` enum: All, Body, Head, Div, Span, Section, etc.

required_skills:
  - pulldown-cmark
  - markdown-rs
  - scraper
  - thiserror
  - rust
important_skills:
  tree-sitter: when comparing HTML parsing approaches
  gfm: when handling GitHub Flavored Markdown extensions
  regex: for interpolate_regex implementation
  rust-testing: when setting up comprehensive test suites
subagents:
  rust-architect: Architecture, API design, code review (Opus)
  schema-architect: Type design, enum structures (Sonnet)
  research-consolidator: scraper vs tree-sitter analysis (Opus 4.5)
  rust-developer: Module implementation (Sonnet)
  feature-tester-rust: Test coverage (Sonnet)
monorepo_modules_impacted:
  - shared
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 0
---
# Planning Process

- [x] Prep Started [10:23am]
    - [x] Identified Skills [10:24am]
    - [x] Identified Subagents [10:24am]
- [x] Prep complete with 35% context available [10:24am]
- [x] Clarify (orchestrator, D1) [10:25am]
    - [x] User asked clarifying questions (human in the loop) [10:25am]
    - [x] Requirements updated: HTML parser=scraper, IsolateAction=Vector+Concatenate(Option), MarkdownScope expanded, Cow<str> for zero-copy
- [x] Planning Subagent [agent: **Plan**] started [10:25am]
    - [x] subagent skills used: pulldown-cmark, scraper, thiserror, rust
    - [x] Planning completed [10:26am]
- [x] Module Assessment: Only `shared` module impacted (single module)
- [x] All Pre-review Steps complete
    - 35% of context window available
- [x] Review Started [10:26am]
   - [x] Completeness Review [agent: **general-purpose (haiku)**]
       - [x] HIGH: Define error type variants (IsolateError, InterpolateError)
       - [x] HIGH: Clarify MarkdownScope variant semantics (Links, Images, Tables, FootnoteDefinitions)
       - [x] HIGH: Add IsolateResult to Phase 1 deliverables
       - [x] HIGH: Define nested scope behavior
   - [x] Concurrency Review [agent: **general-purpose (haiku)**]
       - [x] HIGH: MD and HTML tracks can parallelize better
       - [x] HIGH: Start test infrastructure early (not wait for Phase 9)
       - [x] MEDIUM: Consider consolidating Phases 1-2
   - [x] Correctness Review [agent: **general-purpose (haiku)**]
       - [x] HIGH: Add UTF-8 byte boundary validation for spans
       - [x] MEDIUM: Cow<str> may require Owned for most operations
       - [x] MEDIUM: Add bounds validation before string slicing
- [x] Reviews Completed [10:27am]
- [x] Plan Finalization (orchestrator, D4) [10:27am]
    - [x] Incorporated high-priority review feedback:
        - Added IsolateError (4 variants) and InterpolateError (2 variants)
        - Added semantic comments to all MarkdownScope variants
        - Documented nested scope behavior
        - Added IsolateResult to Phase 1 deliverables
        - Added UTF-8 byte boundary validation requirement
- [x] Plan finalized [10:28am]
- Final Steps
    - [x] Lessons learned collected (2 entries)
    - [x] No new packages required (all deps already in Cargo.toml)
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-08.isolate-interpolate-modules.md
    - Started: 10:23am
    - Completed: 10:28am
    - Duration: ~5 minutes



## Plan

### Summary

9 phases implementing isolate (phases 1-4) then interpolate (phases 5-8) with testing (phase 9).

| Phase | Name | Subagent | Complexity | Dependencies | Parallelizable |
|-------|------|----------|------------|--------------|----------------|
| 1 | Core Types | rust-architect | Low | None | Yes (with 2) |
| 2 | HTML Enums | rust-architect | Low | None | Yes (with 1) |
| 3 | MD Isolate | rust-developer | High | 1 | No |
| 4 | HTML Isolate | rust-developer | Medium | 2 | Yes (with 3) |
| 5 | Basic Interpolate | rust-developer | Low | None | Yes (with 1-4) |
| 6 | MD Interpolate | rust-developer | High | 3, 5 | No |
| 7 | HTML Interpolate | rust-developer | Medium | 4, 5 | Yes (with 6) |
| 8 | Integration | rust-developer | Low | 6, 7 | No |
| 9 | Test Suite | feature-tester-rust | Medium | 8 | No |

### Phase 1: Core Types and IsolateAction Enum

| Property | Value |
|----------|-------|
| **Subagent** | `rust-architect` |
| **Required Skills** | thiserror, rust |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 2) |

**Objective:** Define core enums and error types shared across both modules.

**Deliverables:**
- `isolate/mod.rs` - Complete `IsolateAction` enum
- `isolate/types.rs` - `IsolateError` type using thiserror
- `isolate/md_isolate.rs` - Complete `MarkdownScope` enum (12 variants)

**Key Types:**
```rust
pub enum IsolateAction {
    LeaveAsVector,
    Concatenate(Option<String>),
}

pub enum MarkdownScope {
    Frontmatter,      // YAML between first --- markers (returns empty if none)
    Prose,            // Text outside code blocks, block quotes, and special elements
    CodeBlock,        // Fenced or indented code blocks (includes info string)
    BlockQuote,       // Block quote content (excluding > markers)
    Heading,          // Heading text (excluding # markers and level)
    Stylized,         // Bold (**), italic (*/_), strikethrough (~~) content
    Italicized,       // Only italic (*/_) content
    NonItalicized,    // Everything except italic content
    Links,            // Link text AND URL (dest_url, title)
    Images,           // Image alt text AND URL
    Lists,            // All list item content (ordered and unordered)
    Tables,           // Table headers and cells (GFM)
    FootnoteDefinitions, // Footnote content (excluding [^marker])
}

pub enum IsolateResult<'a> {
    Vector(Vec<Cow<'a, str>>),
    Concatenated(String), // Note: always Owned when concatenating
}

#[derive(Error, Debug)]
pub enum IsolateError {
    #[error("Invalid CSS selector: {0}")]
    InvalidSelector(String),
    #[error("Markdown parse error: {0}")]
    MarkdownParse(String),
    #[error("HTML parse error: {0}")]
    HtmlParse(String),
    #[error("Invalid byte range: {start}..{end} not on UTF-8 boundary")]
    InvalidByteRange { start: usize, end: usize },
}

#[derive(Error, Debug)]
pub enum InterpolateError {
    #[error("Invalid regex pattern: {0}")]
    InvalidPattern(#[from] regex::Error),
    #[error("Isolate failed: {0}")]
    IsolateError(#[from] IsolateError),
}
```

**Nested Scope Behavior:**
- For overlapping scopes (e.g., bold inside heading), the innermost scope takes precedence
- Each scope match is returned separately; duplicates from nested structures are kept
- UTF-8 byte boundary validation required before returning any byte ranges

**Acceptance Criteria:**
- [ ] `IsolateAction` with both variants
- [ ] `MarkdownScope` with all 12 variants + semantic docs
- [ ] `IsolateResult` enum in deliverables
- [ ] `IsolateError` with 4 variants (selector, md parse, html parse, byte range)
- [ ] `InterpolateError` with 2 variants (regex, isolate wrapper)
- [ ] Unit tests for enum construction

---

### Phase 2: HtmlScope and HtmlTag Enums

| Property | Value |
|----------|-------|
| **Subagent** | `rust-architect` |
| **Required Skills** | thiserror, scraper, rust |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 1) |

**Objective:** Define HTML-specific scope enums.

**Deliverables:**
- `isolate/html_isolate.rs` - `HtmlTag` (18 variants) and `HtmlScope` (5 variants)

**Key Types:**
```rust
pub enum HtmlTag {
    All, Body, Head, Div, Span, Section, Aside, Header,
    H1, H2, H3, H4, H5, H6, Meta, Script, Pre, PreBlock, PreInline,
}

pub enum HtmlScope {
    TagAttributes(HtmlTag), InnerHtml(HtmlTag), OuterHtml(HtmlTag),
    Selector(String), Prose,
}
```

**Acceptance Criteria:**
- [ ] All enums documented with Rustdoc
- [ ] Re-exported from mod.rs

---

### Phase 3: Markdown Isolate Implementation

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | pulldown-cmark, rust |
| **Suggested Skills** | gfm (for tables, footnotes) |
| **Complexity** | High |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No |

**Objective:** Implement `md_isolate()` using pulldown-cmark event stream.

**Function Signature:**
```rust
pub fn md_isolate<'a>(
    content: &'a str,
    scope: MarkdownScope,
    action: IsolateAction,
) -> Result<IsolateResult<'a>, IsolateError>
```

**Implementation:** Use `parser.into_offset_iter()` for byte ranges (reference: `toc/mod.rs:89-191`)

**Acceptance Criteria:**
- [ ] All 12 scope types extract correct content
- [ ] Zero-copy with Cow<str> where possible
- [ ] Frontmatter parsing handles YAML between `---`
- [ ] Unit tests for each scope type

---

### Phase 4: HTML Isolate Implementation

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | scraper, rust |
| **Complexity** | Medium |
| **Dependencies** | Phase 2 |
| **Parallelizable** | Yes (with Phase 3) |

**Objective:** Implement `html_isolate()` using scraper.

**Function Signature:**
```rust
pub fn html_isolate<'a>(
    content: &'a str,
    scope: HtmlScope,
    action: IsolateAction,
) -> Result<IsolateResult<'a>, IsolateError>
```

**Trade-off Note:** Scraper DOM is read-only; no byte offset access - use string-based extraction.

**Acceptance Criteria:**
- [ ] All 5 scope variants work correctly
- [ ] CSS selector validation with meaningful errors
- [ ] Trade-offs documented inline

---

### Phase 5: Context-Unaware Interpolation

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | regex, rust |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phases 1-4) |

**Objective:** Simple string and regex replacement functions.

**Functions:**
```rust
pub fn interpolate<'a>(content: &'a str, find: &str, replace: &str) -> Cow<'a, str>
pub fn interpolate_regex<'a>(content: &'a str, pattern: &str, replace: &str) -> Result<Cow<'a, str>, InterpolateError>
```

**Acceptance Criteria:**
- [ ] Returns `Cow::Borrowed` when no match
- [ ] Regex capture groups work (`$1`, `$2`)

---

### Phase 6: Markdown Context-Aware Interpolation

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | pulldown-cmark, rust |
| **Complexity** | High |
| **Dependencies** | Phase 3, Phase 5 |
| **Parallelizable** | No |

**Objective:** Implement `md_interpolate()` using `md_isolate()` for scoped replacement.

**Strategy:** Track byte ranges during isolation, replace in reverse order to maintain offsets.

**Functions:**
```rust
pub fn md_interpolate<'a>(content: &'a str, scope: MarkdownScope, find: &str, replace: &str) -> Result<Cow<'a, str>, InterpolateError>
pub fn md_interpolate_regex<'a>(content: &'a str, scope: MarkdownScope, pattern: &str, replace: &str) -> Result<Cow<'a, str>, InterpolateError>
```

**Acceptance Criteria:**
- [ ] Only replaces within scoped regions
- [ ] Content outside scope preserved
- [ ] Handles nested scopes correctly

---

### Phase 7: HTML Context-Aware Interpolation

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | scraper, rust |
| **Complexity** | Medium |
| **Dependencies** | Phase 4, Phase 5 |
| **Parallelizable** | Yes (with Phase 6) |

**Objective:** Implement `html_interpolate()` using string-based replacement.

**Strategy:** Parse to identify matches, replace in original string (scraper DOM is read-only).

**Limitation:** Identical content in multiple matching elements will all be replaced.

**Acceptance Criteria:**
- [ ] Replaces within scoped elements only
- [ ] CSS selector scope works
- [ ] Limitation documented

---

### Phase 8: Module Integration and Re-exports

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | rust |
| **Complexity** | Low |
| **Dependencies** | Phase 6, Phase 7 |
| **Parallelizable** | No |

**Objective:** Wire up module re-exports and register in lib.rs.

**Acceptance Criteria:**
- [ ] All types accessible from `shared::isolate::*` and `shared::interpolate::*`
- [ ] `cargo doc` generates without warnings
- [ ] `cargo build` succeeds

---

### Phase 9: Comprehensive Test Suite

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust |
| **Complexity** | Medium |
| **Dependencies** | Phase 8 |
| **Parallelizable** | No |

**Objective:** Create comprehensive test coverage.

**Test Categories:**
- IsolateAction variants
- Each MarkdownScope type
- Each HtmlScope/HtmlTag variant
- Zero-copy verification (Cow::Borrowed vs Cow::Owned)
- Scoped replacement preserves non-scoped content

**Acceptance Criteria:**
- [ ] >90% code coverage for both modules
- [ ] All edge cases tested
- [ ] `cargo test -p shared` passes


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [CRATE: scraper]: DOM is read-only, no byte offset access - requires string-based replacement strategy for interpolation
- [CRATE: pulldown-cmark]: `into_offset_iter()` provides byte ranges essential for in-place modifications


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

