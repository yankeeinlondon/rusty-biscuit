---
status: "done"
started_at: 12:05:49
finished_at: 12:25:36
duration: "~20 minutes"
tts_gender: male
requirements: |
  Add top-level feature to Sniff library for program detection using `which` crate.

  Existing (confirmed via codebase review):
  - `find_program` and `find_programs_parallel` utility commands in `find_program.rs`
  - Six structs with bool fields tracking installed programs:
    1. InstalledEditors (26 editors) - sniff/lib/src/programs/editors.rs
    2. InstalledUtilities (31 utilities) - sniff/lib/src/programs/utilities.rs
    3. InstalledLanguagePackageManagers (18 pkg managers) - sniff/lib/src/programs/pkg_mngrs.rs
    4. InstalledOsPackageManagers (9 pkg managers) - sniff/lib/src/programs/pkg_mngrs.rs
    5. InstalledTtsClients (13 TTS clients) - sniff/lib/src/programs/tts_clients.rs
    6. InstalledTerminalApps (18 terminal apps) - sniff/lib/src/programs/terminal_apps.rs
  - Each struct has `new()` method for concurrent status checking via `find_programs_parallel`

  Add to each struct (keep bool fields, lookups are on-demand):
  - `refresh()` method to re-check program availability
  - `path(Program enum) -> Option<PathBuf>` returns binary path via `which` crate lookup
  - `version(Program enum) -> Result<String>` executes version command and parses output
  - `website(Program enum) -> &'static str` returns program's official website
  - `description(Program enum) -> &'static str` returns one-line description

  Implementation needs:
  - Create enum for each program category (6 enums total, one per struct)
  - Create metadata lookup table for each enum (website, description, version command/parsing)
  - Metadata table must specify how to get version (e.g., `--version`, `-v`, parsing strategy)

  CLI additions (sniff/cli):
  - Add `programs` key to top-level JSON output
  - Sub-keys for each struct: editors, utilities, language_package_managers, os_package_managers, tts_clients, terminal_apps
  - Add top-level filter `--programs` (shows all categories)
  - Add category-specific filters: `--editors`, `--utilities`, `--language-package-managers`, `--os-package-managers`, `--tts-clients`, `--terminal-apps`
required_skills: [rust, clap, which, strum]
important_skills:
  serde: "when implementing JSON serialization for programs key"
  rayon: "when implementing parallel program detection"
  thiserror: "when creating custom error types"
  rust-testing: "when writing tests for new methods"
subagents:
  schema-architect: "Design enum hierarchy, metadata lookup schema, method signatures, JSON output structure"
  rust-developer: "Implement enums, methods, lookup tables, integrate with which crate"
  cli-specialist: "Add CLI flags, modify output serialization, update help docs"
  feature-tester: "Unit tests, integration tests, edge cases, JSON validation"
monorepo_modules_impacted: [sniff/lib, sniff/cli]
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 7
---
# Planning Process

- [x] Prep Started [12:05:49]
    - [x] Identified Skills [12:06:00] - rust, clap, which, strum (required); serde, rayon, thiserror, rust-testing (suggested)
    - [x] Identified Subagents [12:06:00] - schema-architect, rust-developer, cli-specialist, feature-tester
- [x] Prep complete with 35% context available [12:06:15]
- [x] Clarify (orchestrator direct) [12:06:30]
    - [x] User asked clarifying questions (human in the loop) [12:08:00]
    - [x] Requirements have been updated based on user responses [12:09:00]
- [x] Planning Subagent [agent: general-purpose] started [12:10:00]
    - [x] subagent skills used: rust, clap, which, strum, serde, thiserror, rust-testing
    - [x] Planning completed [12:11:00]
- [x] Module Assessment Subagent [agent: general-purpose] started [12:10:00]
    - [x] subagent skills used: rust
    - [x] Module Assessment completed [12:11:00]
- [x] All Pre-review Steps are complete [12:11:30]
    - 35% of context window is still available
- [x] Review Started [12:12:00]
   - [x] Completeness Review [agent: general-purpose]
       - [x] subagent skills used: rust, clap, which, strum, serde, thiserror
   - [x] Concurrency Review [agent: general-purpose]
       - [x] subagent skills used: rust, rayon
   - [x] Details/Knowledge Based Review [agent: general-purpose]
        - [x] subagent skills used: rust, clap, which, strum, serde, thiserror
- [x] Reviews Completed [12:13:00]
    - 35% of context window is still available
- [x] Plan Finalization [agent: general-purpose] started [12:13:30]
    - [x] subagent skills used: rust, clap, which, strum, serde, rayon, thiserror, rust-testing
- [x] Plan finalized [12:25:00]
    - 35% of context window is still available
- Final Steps
    - [x] Lessons learned collected from all subagents (7 total)
    - [x] Package changes: 2 dependencies to add (strum, once_cell) - no research needed
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-16.plan-for-sniff-programs-enhancements.md
    - Started: 12:05:49
    - Completed: 12:25:36
    - Duration: ~20 minutes



## Plan

### Phase 1: Schema Architecture & Design

| Property | Value |
|----------|-------|
| **Subagent** | `schema-architect` |
| **Required Skills** | rust, strum |
| **Suggested Skills** | serde (for JSON schema design) |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | No (foundation for all other phases) |

**Objective:** Design the enum hierarchy, metadata lookup schema, method signatures, and JSON output structure for all six program categories.

**Deliverables:**
- Enum definitions for all six categories (Editors, Utilities, LanguagePackageManagers, OsPackageManagers, TtsClients, TerminalApps)
- Trait design for common program metadata operations (`ProgramMetadata` trait)
- Metadata schema including: website, description, version command, version parsing strategy
- JSON output schema for CLI serialization
- Method signatures for: `refresh()`, `path()`, `version()`, `website()`, `description()`

**Acceptance Criteria:**
- [ ] All 115 programs categorized into appropriate enums with `strum` derives
- [ ] `ProgramMetadata` trait defines common interface for all enums
- [ ] Version parsing strategy enum defined (Regex, SemVer, FirstLine, Custom)
- [ ] JSON schema supports nested program categories with optional fields
- [ ] Design document includes rationale for metadata lookup approach (const arrays vs trait methods)

---

### Phase 2: Metadata Lookup Tables

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | High |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No (requires Phase 1 schema) |

**Objective:** Implement metadata lookup tables for all 115 programs across six categories, including website URLs, descriptions, version commands, and parsing strategies.

**Deliverables:**
- Const array or match-based lookup for each enum implementing `ProgramMetadata` trait
- Website URLs (official sites) for all 115 programs
- One-line descriptions for all 115 programs
- Version command specifications (flag + parsing strategy) for all 115 programs
- Helper functions for common version parsing patterns (semver, first line, regex)

**Acceptance Criteria:**
- [ ] All programs have accurate website URLs (verified manually or via web search)
- [ ] All descriptions are concise (< 100 chars) and informative
- [ ] Version commands tested for at least 20 representative programs
- [ ] Parsing strategies handle edge cases (missing versions, non-standard formats)
- [ ] Code is well-documented with examples in doc comments

---

### Phase 3: Core Method Implementation

| Property | Value |
|----------|-------|
| **Subagent** | `rust-developer` |
| **Required Skills** | rust, which |
| **Suggested Skills** | thiserror (for error types), rayon (if parallelizing version checks) |
| **Complexity** | Medium |
| **Dependencies** | Phase 1, Phase 2 |
| **Parallelizable** | No (requires Phase 1 & 2) |

**Objective:** Implement `refresh()`, `path()`, `version()`, `website()`, and `description()` methods for all six structs, integrating `which` crate and metadata lookups.

**Deliverables:**
- `refresh()` method re-checking all programs via `find_programs_parallel`
- `path(enum) -> Option<PathBuf>` using `which::which()` lookup
- `version(enum) -> Result<String>` executing version command and parsing output
- `website(enum) -> &'static str` returning metadata lookup result
- `description(enum) -> &'static str` returning metadata lookup result
- Custom error type for version detection failures

**Acceptance Criteria:**
- [ ] `refresh()` updates all bool fields based on current PATH state
- [ ] `path()` returns canonical paths when programs exist
- [ ] `version()` handles missing programs, failed commands, and parse errors gracefully
- [ ] All methods have comprehensive doc comments with examples
- [ ] Error types use `thiserror` for clear error messages
- [ ] No panics in production code paths

---

### Phase 4: CLI Integration - Output Schema

| Property | Value |
|----------|-------|
| **Subagent** | `cli-specialist` |
| **Required Skills** | rust, serde, clap |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1, Phase 3 |
| **Parallelizable** | Yes (with Phase 5) |

**Objective:** Add `programs` key to top-level JSON output with nested category sub-keys, integrating with existing CLI serialization.

**Deliverables:**
- `ProgramsOutput` struct with fields for all six categories
- Serialization logic to populate `programs` key in top-level JSON
- Conditional serialization based on active filters
- Integration with existing `sniff/cli/src/main.rs` output logic

**Acceptance Criteria:**
- [ ] JSON output includes `programs` key when `--programs` or category flags active
- [ ] Each category serialized as object with program names as keys, metadata as values
- [ ] Missing programs excluded from output (not serialized as null)
- [ ] Output validates against JSON schema from Phase 1
- [ ] Minimal impact on existing output structure (non-breaking change)

---

### Phase 5: CLI Integration - Filter Flags

| Property | Value |
|----------|-------|
| **Subagent** | `cli-specialist` |
| **Required Skills** | rust, clap |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (with Phase 4) |

**Objective:** Add CLI filter flags for program detection: top-level `--programs` and six category-specific flags.

**Deliverables:**
- `--programs` flag to show all program categories
- `--editors`, `--utilities`, `--language-package-managers`, `--os-package-managers`, `--tts-clients`, `--terminal-apps` flags
- Help text documentation for all new flags
- Flag validation logic (category flags imply `--programs`)

**Acceptance Criteria:**
- [ ] `--programs` flag activates all six categories
- [ ] Category-specific flags work independently and in combination
- [ ] Help text follows existing Sniff CLI conventions
- [ ] Flags integrate with existing filter system (e.g., `--all` interaction)
- [ ] No conflicts with existing CLI flags

---

### Phase 6: Unit Testing - Library

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester` |
| **Required Skills** | rust, rust-testing |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 2, Phase 3 |
| **Parallelizable** | Yes (with Phase 7) |

**Objective:** Write comprehensive unit tests for enum metadata, `ProgramMetadata` trait implementations, and struct methods.

**Deliverables:**
- Tests for metadata lookup accuracy (website, description, version command)
- Tests for `path()` method (existing programs, missing programs, PATH manipulation)
- Tests for `version()` method (successful parsing, parse failures, missing binaries)
- Tests for `refresh()` method (state updates, concurrent safety)
- Mock tests for edge cases (empty PATH, permission errors)

**Acceptance Criteria:**
- [ ] All public methods have test coverage
- [ ] Tests use representative programs from each category
- [ ] Edge cases covered: missing programs, malformed version output, permission errors
- [ ] Tests are hermetic (no reliance on specific system state)
- [ ] Tests run in parallel without race conditions

---

### Phase 7: Integration Testing - CLI

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester` |
| **Required Skills** | rust, rust-testing, clap |
| **Suggested Skills** | serde (for JSON validation) |
| **Complexity** | Medium |
| **Dependencies** | Phase 4, Phase 5 |
| **Parallelizable** | Yes (with Phase 6) |

**Objective:** Write integration tests for CLI output, filter flags, and JSON schema validation.

**Deliverables:**
- Tests for `--programs` flag output structure
- Tests for category-specific filter flags (individual and combined)
- JSON schema validation tests
- Tests for filter interaction with existing flags (`--all`, `--json`)
- Snapshot tests for expected output formats

**Acceptance Criteria:**
- [ ] All flag combinations tested
- [ ] JSON output validated against schema from Phase 1
- [ ] Tests verify presence of expected keys/fields
- [ ] Tests handle systems with varying program availability
- [ ] Integration tests runnable via `just test`

---

### Phase 8: Documentation & Examples

| Property | Value |
|----------|-------|
| **Subagent** | `cli-specialist` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 3, Phase 4, Phase 5 |
| **Parallelizable** | No (requires feature completion) |

**Objective:** Document the program detection feature in code, README files, and provide usage examples.

**Deliverables:**
- Module-level documentation for `programs/` module
- Usage examples in doc comments (library API)
- CLI examples in `sniff/cli/README.md` or main README
- CHANGELOG entries for new feature
- Code examples demonstrating `path()`, `version()`, `website()`, `description()` usage

**Acceptance Criteria:**
- [ ] All public APIs have doc comments with examples
- [ ] CLI README includes example commands for all new flags
- [ ] Examples demonstrate real-world use cases
- [ ] Documentation follows Rust documentation best practices (H2 for sections, no H1)
- [ ] Code examples compile and run successfully


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [CODE: sniff/lib/src/programs/find_program.rs:10]: Critical compilation bug - undefined variable `exe_name` should be `program`
- [CODE: sniff/lib/src/programs/find_program.rs:8]: Wrong trait bound `AsRef<Path>` should be `AsRef<str>` or `AsRef<OsStr>`
- [CODE: sniff/lib/src/programs/find_program.rs]: Missing imports for `std::env` and `std::path::Path`
- [CODE: sniff/lib/src/programs/find_program.rs]: Unused public function `find_program()` - all callers use `find_programs_parallel()` instead
- [CODEBASE: sniff/lib/src/programs/]: All six structs use consistent pattern - bool fields + `new()` method with `find_programs_parallel`
- [CODEBASE: sniff/cli/src/main.rs]: CLI uses `clap` derive API with nested filter flags
- [FILE: .ai/code-reviews/20251230.provider-base-implementation.md]: Code duplication in provider module noted (not applicable to this feature)

## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- [ADD]: `strum = { version = "0.26", features = ["derive"] }` in sniff/lib/Cargo.toml - Enum metadata (Display, EnumIter, EnumString) for Program enum
- [ADD]: `once_cell = "1.19"` in sniff/lib/Cargo.toml - Lazy-loaded static metadata tables (website, description, version commands)

Note: No research needed - these are standard Rust utility crates with extensive documentation.


