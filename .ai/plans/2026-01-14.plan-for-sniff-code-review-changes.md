---
status: "done"
started_at: 23:12:58
finished_at:
duration:
tts_gender: male
requirements: |
  Implement ALL changes from the sniff package code review dated 2026-01-14:

  1. Module size and structure - Split large modules:
     - os/mod.rs → distro.rs, locale.rs, time.rs, package_manager.rs
     - package/mod.rs → os.rs, language.rs, manager.rs
     - filesystem/git.rs → smaller focused files
     - cli/output.rs → extract formatting helpers

  2. DRY and data-driven mappings:
     - Consolidate duplicated monorepo detection between monorepo.rs and repo.rs
     - Create shared metadata table/macro for LanguagePackageManager and OsPackageManager
     - Extract SIMD/GPU capability formatting into helpers

  3. Idiomatic Rust / performance:
     - Fix enrich_dependencies to use futures::future::join_all (currently awaits sequentially)
     - Use HashSet<PathBuf> for dirty_paths in get_repo_status (avoid O(n^2))
     - POPULATE mac_address field from getifaddrs link-layer data
     - Consider glob/globset for pattern matching

  4. sysinfo/getifaddrs considerations:
     - Split OS concerns for independent unit testing of parsers
     - Handle MAC extraction with deterministic merge for multiple address records

  5. Testing strategy:
     - Add wiremock for network registry tests (no conditional NETWORK_TESTS)
     - Factor CLI test helpers to reduce boilerplate

  6. Optional follow-ups:
     - Add sniff_lib::util module for shared formatting helpers
     - Add unit tests for OS parsing helpers
required_skills:
  - rust
  - thiserror
  - tokio
  - serde
important_skills:
  wiremock: "When implementing network test mocking for package registry tests"
  tracing: "If adding instrumentation during refactoring"
subagents:
  Plan: "Design module split strategy and implementation order"
  Explore: "Find duplicated code, test patterns, and migration scope"
  general-purpose: "Execute refactoring, consolidation, and async fixes"
  feature-tester-rust: "Add wiremock integration, conditional tests, test helpers"
  Bash: "Run tests, clippy, and build verification"
monorepo_modules_impacted:
  - sniff/lib/src/os/ (4,619 lines → 4 files)
  - sniff/lib/src/package/ (1,011 lines → 3 files)
  - sniff/lib/src/filesystem/monorepo.rs (DRY consolidation)
  - sniff/lib/src/filesystem/repo.rs (DRY consolidation)
  - sniff/lib/src/filesystem/git.rs (HashSet performance fix)
  - sniff/lib/src/package/network.rs (parallel futures fix)
  - sniff/lib/src/network/mod.rs (MAC address population)
  - sniff/cli/src/output.rs (extract helpers)
completeness_changes:
  - "Phase 3 should precede Phase 2 to consolidate duplication first"
  - "Add futures crate as prerequisite for Phase 5"
  - "Add wiremock to dev-deps as prerequisite for Phase 9"
  - "Phase 8 scope needs clarification on which formatters to extract"
concurrency_changes:
  - "Reorder: Phase 3 (consolidate) before Phase 2 (split package)"
  - "Split Phase 9 into 9a (CLI helpers tests) and 9b (wiremock network tests)"
  - "Phases 7-8 can run fully in parallel (separate file hierarchies)"
detail_changes:
  - "edition = 2024 in Cargo.toml is unusual - verify intentional"
  - "Phase 9 requires Client injection refactor for wiremock testing"
  - "futures v0.3 already in biscuit, add to sniff/lib for consistency"
lessons_learned_count: 0
---
# Planning Process

- [x] Prep Started [2026-01-14 23:12]
    - [x] Identified Skills [23:14] - rust, thiserror, tokio, serde (suggested: wiremock, tracing)
    - [x] Identified Subagents [23:14] - Plan, Explore, general-purpose, feature-tester-rust, Bash
- [x] Prep complete with 35% context available [23:14]
- [x] Clarify [orchestrator] started [23:14]
    - [x] User asked clarifying questions (human in the loop) [23:15]
    - [x] Requirements have been updated based on user responses [23:15]
    - **Decisions:**
      - Priority: Full implementation (all 6 categories)
      - MAC Address: Populate it from link-layer data
      - Testing: Wiremock only (no NETWORK_TESTS conditional)
- [x] Planning Subagent [agent: **Plan**] started [23:15]
    - [x] subagent skills used: rust, thiserror, tokio, serde
    - [x] Planning completed [23:17] - 12 phases created (9 core + 3 optional)
- [x] Module Assessment Subagent [agent: **Explore**] started [23:15]
    - [x] subagent skills used: rust
    - [x] Module Assessment completed [23:17] - 8 modules impacted, no external deps
- [x] All Pre-review Steps are complete
    - 35% of context window is still available
- [x] Review Started [23:17]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, serde, tokio
       - Found: futures/wiremock missing from Cargo.toml, Phase 3 should precede Phase 2
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, tokio
       - Found: Reorder Phase 3 before Phase 2, split Phase 9 into 9a/9b
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, serde, tokio
       - Found: edition = "2024" unusual (verify), Client injection needed for wiremock
- [x] Reviews Completed [23:19]
    - 35% of context window is still available
- [ ] Plan Finalization [agent: **NAME**] started [{datetime}]
    - [ ] subagent skills used: **LIST**
- [ ] Plan finalized [{datetime}]
    - {%} of context window is still available
- Final Steps
    - [ ] Lessons learned collected from all subagents
    - [ ] Researching {#} packages [{datetime}]
- [ ] Summarized plan to user via STDOUT
    - Project File: {filename}
    - Started: {datetime}
    - Completed: {datetime}
    - Duration: {duration}



## Plan

### Phase 1: Add Dependencies
**Tasks:** Add `futures` crate to sniff/lib for `join_all`, add `wiremock` to dev-deps for HTTP mocking
**Files:** `sniff/lib/Cargo.toml`

### Phase 2: Consolidate Monorepo Detection (DRY)
**Tasks:** Merge duplicated `MonorepoTool` enum and detection logic from `monorepo.rs` and `repo.rs` into single implementation
**Files:** `sniff/lib/src/filesystem/monorepo.rs`, `sniff/lib/src/filesystem/repo.rs`
**Note:** Must complete before module splits to avoid duplicating the duplication

### Phase 3: Split os/mod.rs (4,619 lines → 4 files)
**Tasks:** Extract into focused modules:
- `os/distro.rs` - Distribution detection and parsing
- `os/locale.rs` - Locale detection
- `os/time.rs` - Timezone detection
- `os/package_manager.rs` - OS package manager detection
**Files:** `sniff/lib/src/os/mod.rs`, new files

### Phase 4: Split package/mod.rs (1,011 lines → 3 files)
**Tasks:** Extract into focused modules:
- `package/os.rs` - OS package manager enums/traits
- `package/language.rs` - Language package manager enums/traits
- `package/manager.rs` - Shared manager traits and metadata
**Files:** `sniff/lib/src/package/mod.rs`, new files

### Phase 5: Fix Parallel Futures in enrich_dependencies
**Tasks:** Replace sequential `await` loop with `futures::future::join_all` for parallel execution
**Files:** `sniff/lib/src/package/network.rs`

### Phase 6: Fix HashSet Performance in git.rs
**Tasks:** Replace `Vec::contains` O(n²) pattern with `HashSet<PathBuf>` for dirty path deduplication
**Files:** `sniff/lib/src/filesystem/git.rs`

### Phase 7: Populate MAC Address from getifaddrs
**Tasks:** Extract link-layer addresses from `getifaddrs::Address::Link` variant, implement deterministic merge for multiple address records
**Files:** `sniff/lib/src/network/mod.rs`, `sniff/lib/src/network/interface.rs`

### Phase 8: Extract CLI Formatting Helpers
**Tasks:** Create shared helpers for SIMD/GPU capability formatting, consolidate repeated formatting logic
**Files:** `sniff/cli/src/output.rs`, new helper module

### Phase 9: Add Wiremock Network Tests
**Tasks:**
- 9a: Factor CLI test helpers to reduce boilerplate
- 9b: Add wiremock-based HTTP mocking for package registry tests, inject `reqwest::Client`
**Files:** `sniff/cli/tests/cli.rs`, `sniff/lib/src/package/network.rs`

### Optional Phases (if time permits)

### Phase 10 (Optional): Add sniff_lib::util module
**Tasks:** Create shared formatting helpers for CLI and future TUI

### Phase 11 (Optional): Add OS parsing unit tests
**Tasks:** Add tests for `parse_os_release_content`, `parse_lsb_release_content`, `parse_system_release_content`

### Phase 12 (Optional): Consider globset for pattern matching
**Tasks:** Evaluate replacing simple `*` pattern matching with `glob`/`globset`


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [FILE: sniff/lib/src/package/network.rs]: enrich_dependencies claims parallel execution but awaits futures sequentially in loop
- [FILE: sniff/lib/src/filesystem/git.rs]: get_repo_status uses Vec::contains for O(n^2) dirty path deduplication
- [FILE: sniff/lib/src/network/mod.rs]: getifaddrs::Address::Link variant ignored, MAC addresses never populated
- [DUPLICATION: monorepo.rs vs repo.rs]: Identical MonorepoTool enum and detection functions duplicated across both files
- [CODE_SIZE: os/mod.rs]: 4,619 lines violates single responsibility - contains OS detection, distro parsing, locale, timezone, AND package manager detection


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- [ADD(sniff/lib)]: futures in cargo - Required for join_all to fix parallel dependency enrichment
    - "What is the idiomatic async pattern for concurrent futures in Rust 2024?"
- [ADD(sniff/lib dev-deps)]: wiremock in cargo - Required for mocked HTTP tests
    - "How does wiremock integrate with reqwest for testing async HTTP clients?"
- [CONSIDER(sniff/lib)]: globset in cargo - For proper glob pattern matching in workspace detection
    - "What is the recommended globbing library for Rust monorepo tooling?"

