# SoYouSay CLI Implementation Plan

**Created:** 2025-12-29
**Status:** Reviewed - Ready for Implementation

## Executive Summary

Create a simple CLI client in the `so-you-say` area that converts command-line text arguments into speech using the TTS functionality provided in the shared library (`shared::tts::speak`). The binary will be named `speak` and will play audio on the host device.

## Review Summary

**Reviews Completed:** 2025-12-29

**Reviewers:**

- Rust Developer: Approve with Changes
- Rust Architect: Approve with Changes
- Feature Tester (Rust): Approve with Changes

**Key Changes from Review:**

1. Fixed package name vs binary name distinction (`name = "so-you-say"` with `[[bin]]` section)
2. Added explicit error handling strategy (Result return type, buffer limits)
3. Clarified stdin implementation (read all lines until EOF, 10,000 char limit)
4. Expanded test scenarios (15+ tests including unicode, edge cases, doc tests)
5. Added clippy validation to acceptance criteria
6. Added doc comments requirement for clap struct
7. Extracted testable helper functions (join_args, read_from_stdin)
8. Specified exit code conventions

**Resolved Concerns:**

- **Package naming** â†’ Package name is `so-you-say`, binary name is `speak` via `[[bin]]`
- **Stdin handling** â†’ Read all lines until EOF, join with spaces, 10,000 char limit
- **Empty stdin** â†’ Print helpful usage message, exit with code 1
- **Test organization** â†’ Unit tests in `#[cfg(test)]`, integration tests in `tests/cli_test.rs`
- **Buffer safety** â†’ Explicit character limit to prevent memory exhaustion

## Requirements

### Functional Requirements

| ID | Requirement | Priority | Owner |
|----|-------------|----------|-------|
| FR-1 | Accept text as command-line arguments and speak it | High | Rust Developer |
| FR-2 | Support reading text from stdin (pipe support) | High | Rust Developer |
| FR-3 | Use `shared::tts::speak()` for TTS functionality | High | Rust Developer |
| FR-4 | Provide helpful error messages for edge cases | Medium | Rust Developer |
| FR-5 | Support multi-word phrases via positional arguments | High | Rust Developer |

### Non-Functional Requirements

| ID | Requirement | Target | Owner |
|----|-------------|--------|-------|
| NFR-1 | Binary name must be `speak` | Exact | Rust Developer |
| NFR-2 | Follow existing monorepo patterns (clap, workspace member) | Must match | Rust Architect |
| NFR-3 | Minimal dependencies (clap + shared library only) | <5 deps | Rust Developer |
| NFR-4 | Cross-platform (macOS/Linux/Windows via tts crate) | All platforms | Rust Developer |
| NFR-5 | Build time under 5 seconds (incremental) | <5s | Rust Developer |

## Architecture Overview

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  so-you-say CLI (binary: speak)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  main.rs                      â”‚  â”‚
â”‚  â”‚  - Clap argument parsing      â”‚  â”‚
â”‚  â”‚  - Stdin handling             â”‚  â”‚
â”‚  â”‚  - Call shared::tts::speak()  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ depends on
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  shared library                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  tts module                   â”‚  â”‚
â”‚  â”‚  - speak(message: &str)       â”‚  â”‚
â”‚  â”‚  - Uses tts = "0.26.3"        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ uses system TTS
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Host Device Audio                  â”‚
â”‚  (macOS/Linux/Windows native TTS)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

```
1. User invokes: `speak Hello world`
2. Clap parses arguments â†’ Vec<String>
3. Join arguments with spaces â†’ "Hello world"
4. Call shared::tts::speak("Hello world")
5. shared::tts uses tts crate to speak
6. Audio plays on host device
```

Alternative stdin flow:

```
1. User invokes: `echo "Hello world" | speak`
2. Detect no arguments â†’ read from stdin
3. Read line from stdin â†’ "Hello world"
4. Call shared::tts::speak("Hello world")
5. Audio plays on host device
```

## Phases

### Phase 1: Project Setup and Cargo Configuration

**Principal Owner:** Rust Developer

**Goal:** Configure the `so-you-say` area as a workspace member with proper dependencies and binary metadata.

**Dependencies:** None

**Blast Radius:** `cargo build -p so-you-say`

**Deliverables:**

- Updated `so-you-say/Cargo.toml` with:
  - Package name: `so-you-say` (NOT `speak`)
  - Binary configuration: `[[bin]]` section with `name = "speak"`
  - Dependencies: `clap = { version = "4.5.53", features = ["derive"] }`, `shared = { path = "../shared" }`
- Updated root `Cargo.toml` to include `"so-you-say"` in workspace members
- Verify clean build with `cargo build -p so-you-say`

**Technical Details:**

- Package name MUST be `name = "so-you-say"` (matches directory, workspace convention)
- Binary name is `speak` via `[[bin]]` section:

  ```toml
  [[bin]]
  name = "speak"
  path = "src/main.rs"
  ```

- Add `shared` dependency with relative path: `shared = { path = "../shared" }`
- Ensure clap version matches `research/cli` (4.5.53) for consistency
- Remove placeholder "Hello, world!" from `src/main.rs`

**Acceptance Criteria:**

- [ ] File `so-you-say/Cargo.toml` has `name = "so-you-say"` in `[package]` section
- [ ] File `so-you-say/Cargo.toml` contains `shared = { path = "../shared" }`
- [ ] File `so-you-say/Cargo.toml` contains `clap = { version = "4.5.53", features = ["derive"] }`
- [ ] File `so-you-say/Cargo.toml` has `[[bin]]` section with `name = "speak"`
- [ ] Command `grep '^\[\[bin\]\]' so-you-say/Cargo.toml` succeeds
- [ ] File `Cargo.toml` (root) includes `"so-you-say"` in workspace members
- [ ] Command `grep '"so-you-say"' Cargo.toml` succeeds
- [ ] Command `cargo build -p so-you-say` succeeds with exit code 0
- [ ] Binary is created at `target/debug/speak`

---

### Phase 2: Core CLI Implementation

**Principal Owner:** Rust Developer

**Goal:** Implement the core CLI logic with argument parsing and TTS integration.

**Dependencies:** Phase 1 (Cargo setup must be complete)

**Blast Radius:** `cargo test -p so-you-say && cargo build -p so-you-say`

**Deliverables:**

- Implement `src/main.rs` with:
  - Clap struct `Cli` with `#[derive(Parser)]` and doc comments
  - Positional argument `text: Vec<String>` for multi-word input
  - Helper function `join_args(args: Vec<String>) -> String` (testable)
  - Helper function `read_from_stdin() -> io::Result<String>` (testable)
  - Call to `shared::tts::speak()`
  - Stdin detection when no arguments provided
  - Helpful error message when stdin is empty or read fails
  - `main()` returns `Result<(), Box<dyn std::error::Error>>`

**Technical Details:**

- Use `#[derive(Parser)]` from clap
- Add doc comments for help output:

  ```rust
  /// Simple text-to-speech CLI
  #[derive(Parser)]
  #[command(name = "speak")]
  #[command(about = "Convert text to speech using system TTS", long_about = None)]
  #[command(version)]
  struct Cli {
      /// Text to speak (reads from stdin if not provided)
      text: Vec<String>,
  }
  ```

- Positional argument: `text: Vec<String>` allows `speak Hello world`
- Extract to helper: `fn join_args(args: Vec<String>) -> String { args.join(" ") }`
- Stdin detection: `if text.is_empty() { read_from_stdin()? }`
- Stdin implementation reads all lines until EOF with 10,000 character limit:

  ```rust
  fn read_from_stdin() -> io::Result<String> {
      use std::io::Read;
      let mut buffer = String::new();
      let mut handle = io::stdin().take(10_000);
      handle.read_to_string(&mut buffer)?;
      let text = buffer.trim().to_string();
      if text.is_empty() {
          eprintln!("Error: No input provided");
          std::process::exit(1);
      }
      Ok(text)
  }
  ```

- Handle empty input: print to stderr and exit(1)
- Main return type: `fn main() -> Result<(), Box<dyn std::error::Error>>`

**Error Handling Strategy:**

- Use `Result<(), Box<dyn std::error::Error>>` as main return type
- Let clap handle argument parsing errors automatically (shows help)
- Print helpful message to stderr and exit(1) for empty stdin
- Limit stdin read to 10,000 characters to prevent memory exhaustion
- TTS errors are silent (handled by `shared::tts::speak()`)

**Exit Code Conventions:**

- 0: Success (audio played or attempted)
- 1: User error (empty input, invalid arguments)
- Note: TTS failures are silent per `shared::tts`, so no special exit code

**Acceptance Criteria:**

- [ ] File `so-you-say/src/main.rs` exists with >120 lines
- [ ] Command `grep "use clap::Parser" so-you-say/src/main.rs` succeeds
- [ ] Command `grep "shared::tts::speak" so-you-say/src/main.rs` succeeds
- [ ] Command `grep "Vec<String>" so-you-say/src/main.rs` succeeds
- [ ] Command `grep "fn join_args" so-you-say/src/main.rs` succeeds
- [ ] Command `grep "fn read_from_stdin" so-you-say/src/main.rs` succeeds
- [ ] Command `grep "Result<(), Box<dyn" so-you-say/src/main.rs` succeeds
- [ ] Command `grep "take(10_000)" so-you-say/src/main.rs` succeeds (stdin limit)
- [ ] Command `cargo build -p so-you-say` succeeds
- [ ] Binary size is reasonable (<5MB debug, <2MB release with strip)
- [ ] File contains doc comments on `Cli` struct

---

### Phase 3: Testing and Documentation

**Principal Owner:** Feature Tester (Rust)

**Goal:** Add comprehensive tests and usage documentation.

**Dependencies:** Phase 2 (Core implementation must exist)

**Blast Radius:** `cargo test -p so-you-say`

**Deliverables:**

- Unit tests in `src/main.rs` `#[cfg(test)] mod tests`:
  - `test_join_args_multi_word()` - Basic joining
  - `test_join_args_single_word()` - Single argument
  - `test_join_args_empty()` - Empty vector
  - `test_join_args_unicode()` - Unicode characters
  - `test_join_args_with_empty_strings()` - Whitespace preservation
  - `test_join_args_special_chars()` - Punctuation
- Integration tests in `so-you-say/tests/cli_test.rs`:
  - `test_cli_with_arguments()` - Basic execution exits 0
  - `test_cli_help_flag()` - --help shows usage
  - `test_cli_version_flag()` - --version shows version
  - `test_cli_stdin_input()` - Pipe input works
  - `test_cli_no_args_closes_gracefully()` - Handles missing input
- Doc tests:
  - Example in doc comment on `Cli` struct showing basic usage
- Documentation:
  - Doc comments on all public functions (join_args, read_from_stdin if pub)
  - Usage examples in README.md

**Technical Details:**

- Unit tests in `#[cfg(test)] mod tests` within `src/main.rs`
- Test helper functions `join_args()` with various inputs
- Cannot easily test `read_from_stdin()` without mocking (skip or keep internal)
- Integration tests in `so-you-say/tests/cli_test.rs` using `std::process::Command`
- Cannot test actual TTS output (system-dependent), focus on argument processing
- Doc tests demonstrate CLI struct usage
- Test coverage goals:
  - Happy path: 5+ tests
  - Edge cases: 5+ tests
  - Integration: 5+ tests
  - Doc tests: 1+ test
  - **Total: 15+ tests**

**Test Organization:**

- Unit tests for pure functions: In `#[cfg(test)] mod tests` within `src/main.rs`
- Integration tests for binary behavior: In `so-you-say/tests/cli_test.rs`
- Doc tests for examples: In doc comments on `Cli` struct

**Acceptance Criteria:**

- [ ] File `so-you-say/tests/cli_test.rs` exists with >50 lines
- [ ] File `so-you-say/src/main.rs` contains `#[cfg(test)] mod tests`
- [ ] Command `cargo test -p so-you-say` runs at least 15 tests
- [ ] Command `cargo test -p so-you-say` exits with code 0 (all tests pass)
- [ ] Command `grep "fn test_join_args" so-you-say/src/main.rs` finds 5+ tests
- [ ] File `so-you-say/src/main.rs` contains doc comment with usage example
- [ ] File `README.md` mentions `speak` command in SoYouSay section
- [ ] Command `grep "speak Hello world" README.md` succeeds
- [ ] Integration tests verify `--help` and `--version` flags work

**Expanded Test Scenarios:**

**Unit Tests (join_args):**

1. Multi-word: `["Hello", "world"]` â†’ `"Hello world"`
2. Single word: `["Hello"]` â†’ `"Hello"`
3. Empty vector: `[]` â†’ `""`
4. Unicode: `["Hello", "ä¸–ç•Œ", "ðŸš€"]` â†’ `"Hello ä¸–ç•Œ ðŸš€"`
5. Empty strings: `["", "Hello", "", "world"]` â†’ `" Hello  world"`
6. Special chars: `["Hello,", "world!"]` â†’ `"Hello, world!"`

**Integration Tests:**
7. Binary with args: `speak test` â†’ exit 0
8. Help flag: `speak --help` â†’ shows help, exit 0
9. Version flag: `speak --version` â†’ shows version, exit 0
10. Stdin input: `echo "test" | speak` â†’ exit 0
11. Empty stdin: `speak < /dev/null` â†’ shows error, exit 1

**Doc Tests:**
12. Basic usage example in `Cli` doc comment compiles

---

### Phase 4: Workspace Integration and Build Verification

**Principal Owner:** Rust Architect

**Goal:** Ensure the new CLI integrates cleanly with the monorepo build system and follows established patterns.

**Dependencies:** Phase 3 (Tests must be passing)

**Blast Radius:** `cargo test` (full workspace test suite)

**Deliverables:**

- Verify `cargo build` (workspace-level) includes `speak`
- Verify `cargo test` (workspace-level) passes
- Optionally add `speak` to install targets (if a justfile exists)
- Verify binary can be installed via `cargo install --path so-you-say`
- Code review for consistency with `research/cli` patterns

**Technical Details:**

- Workspace build should compile all members including `so-you-say`
- Check for `justfile` at root or in `so-you-say/` for install targets
- Compare CLI structure with `research/cli/src/main.rs` for consistency
- Verify error handling follows monorepo patterns
- Ensure no unnecessary dependencies added

**Acceptance Criteria:**

- [ ] Command `cargo build` (workspace root) succeeds
- [ ] Command `cargo test` (workspace root) succeeds
- [ ] Command `cargo clippy --all-targets -- -D warnings` succeeds
- [ ] Command `cargo clippy -p so-you-say -- -D warnings` succeeds
- [ ] Command `cargo install --path so-you-say` succeeds
- [ ] Binary is installed to `~/.cargo/bin/speak`
- [ ] Command `speak test` runs without panicking
- [ ] Code structure matches patterns in `research/cli` (clap usage, error handling)
- [ ] No extra dependencies beyond `clap` and `shared`
- [ ] If root justfile exists, contains `install-speak` or similar target

---

## Cross-Cutting Concerns

### Testing Strategy

**Unit Tests:**

- Argument joining logic (pure functions)
- Stdin reading logic (using mock stdin)
- Empty input handling

**Integration Tests:**

- Binary execution with various argument patterns
- Exit code verification
- Cannot test actual audio output (system-dependent)

**Test Organization:**

- Helper functions in `#[cfg(test)] mod tests` within `src/main.rs`
- Integration tests in `tests/cli_test.rs` using `std::process::Command`

**Test Data:**

- Sample text inputs (single word, multi-word, special characters)
- Edge cases: empty string, very long text (>1000 chars)

### Security Considerations

- **Input Validation:** No validation needed - TTS library handles all input safely
- **Stdin Reading:** Use buffered reader to prevent memory exhaustion on large inputs
- **No Network Access:** CLI is fully local, no remote dependencies
- **No File System Access:** Only stdin/stdout/stderr, no file operations

### Performance Considerations

- **Argument Parsing:** O(n) where n = number of arguments (negligible overhead)
- **String Joining:** O(m) where m = total character count (single allocation)
- **Stdin Limits:** Hard limit of 10,000 characters to prevent memory exhaustion
- **String Allocation:** Single allocation via `join(" ")` for argument concatenation
- **Binary Size:** Target <2MB release binary with strip=true
- **TTS Blocking:** `shared::tts::speak()` blocks until speech completes (expected behavior)
- **Build Time:** Should be <5s incremental, <30s clean build (minimal dependencies)

### Project-Specific Concerns

**Workspace Integration:**

- Follow existing monorepo "area" pattern (`/research`, `/shared`, `/tui`, `/so-you-say`)
- Use same clap version as `research/cli` for consistency (4.5.53)
- Binary name differs from package name (`speak` vs `so-you-say`) - intentional for UX

**TTS Integration:**

- Rely entirely on `shared::tts::speak()` - no direct `tts` crate dependency
- `shared::tts::speak()` handles voice selection and blocking internally
- Errors are silently ignored (TTS is nice-to-have, per `shared/src/tts.rs:15`)

**CLI UX:**

- Simple invocation: `speak Hello world` (no flags needed)
- Stdin support: `echo "text" | speak` for piping
- No configuration files or environment variables
- Helpful usage message when invoked incorrectly

---

## Parallelization Opportunities

All phases must be executed sequentially due to dependencies:

| Parallel Group | Phases | Reason |
|----------------|--------|--------|
| Sequential | Phase 1 â†’ Phase 2 â†’ Phase 3 â†’ Phase 4 | Each phase depends on previous completion |

**No parallelization possible** - this is a small, linear implementation.

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| TTS library fails on specific platform | Medium | Accept gracefully - `shared::tts::speak()` already handles errors silently |
| Workspace configuration issues | Low | Follow established patterns from `research/cli` |
| Clap API changes | Low | Pin to specific version (4.5.53) matching existing usage |
| Stdin handling edge cases | Low | Comprehensive testing in Phase 3, reference `research/cli` pattern |
| Binary name collision (`speak` exists on system) | Low | Users can alias or use full path; document in README |

---

## Open Questions

- [x] **Should the CLI support any flags?** â†’ No, keep it simple (positional args + stdin only)
- [x] **Should we add rate limiting or caching?** â†’ No, out of scope for v1
- [x] **Should we support file input (`speak -f file.txt`)?** â†’ No, use stdin redirection instead
- [x] **Binary name: `speak` or `so-you-say`?** â†’ `speak` (simpler UX, matches README description)
- [x] **Package name vs binary name?** â†’ Package: `so-you-say`, Binary: `speak` via `[[bin]]`
- [x] **Stdin: single line or multi-line?** â†’ Read all lines until EOF, join with spaces, 10,000 char limit
- [x] **Empty stdin behavior?** â†’ Print helpful usage message, exit with code 1
- [x] **Should we add to a justfile for installation?** â†’ Check if root justfile exists; if so, add target

---

## Implementation Notes

### Key Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `so-you-say/Cargo.toml` | Modify | Add dependencies and binary config |
| `so-you-say/src/main.rs` | Replace | Implement CLI with clap + TTS |
| `so-you-say/tests/cli_test.rs` | Create | Integration tests for binary |
| `Cargo.toml` (root) | Modify | Add `"so-you-say"` to workspace members |
| `README.md` (root) | Modify | Add usage examples for `speak` command |

### Reference Implementation Patterns

Look at `research/cli/src/main.rs` for:

- Clap derive usage (`#[derive(Parser)]`)
- Stdin reading pattern (lines 78-83)
- Subcommand structure (not needed for `speak`, but shows clap patterns)
- Tracing initialization (not needed for `speak` - too simple)

### Expected Usage Examples

```bash
# Basic usage
speak Hello world

# Pipe from echo
echo "Hello world" | speak

# Pipe from file
cat announcement.txt | speak

# Multi-word with punctuation
speak "Good morning, team!"

# Install globally
cargo install --path so-you-say
```

---

## Verification Checklist

After implementation, verify:

**Build & Test:**

- [ ] `cargo build` (workspace root) succeeds
- [ ] `cargo test` (workspace root) succeeds
- [ ] `cargo build -p so-you-say` succeeds
- [ ] `cargo test -p so-you-say` succeeds (15+ tests)
- [ ] `cargo clippy --all-targets -- -D warnings` succeeds
- [ ] `cargo clippy -p so-you-say -- -D warnings` succeeds

**Installation:**

- [ ] `cargo install --path so-you-say` succeeds
- [ ] Binary exists at `~/.cargo/bin/speak`

**Functional Testing (Manual):**

- [ ] `speak Hello world` produces audio
- [ ] `echo "test" | speak` produces audio
- [ ] `cat file.txt | speak` produces audio
- [ ] `speak --help` shows usage information
- [ ] `speak --version` shows version
- [ ] `speak` with no args and closed stdin shows helpful error message

**Documentation:**

- [ ] README.md documents the `speak` command
- [ ] Doc comments on `Cli` struct with usage example
- [ ] Code structure matches `research/cli` patterns

**Code Quality:**

- [ ] Code follows Rust idioms (clippy passes)
- [ ] No unnecessary dependencies in `Cargo.toml`
- [ ] Package name is `so-you-say`, binary name is `speak`
- [ ] Stdin limit of 10,000 chars is enforced
- [ ] Exit codes follow conventions (0 = success, 1 = user error)
