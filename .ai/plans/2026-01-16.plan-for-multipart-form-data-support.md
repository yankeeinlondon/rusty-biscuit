---
status: "done"
started_at: 12:47:00
finished_at: 12:55:00
duration: 8 minutes
tts_gender: male
requirements: |
  Add multipart form-data endpoint support to the schematic/define package.
  The package currently supports JSON and WebSocket endpoints but needs
  to support multipart form-data for file uploads and mixed file/JSON payloads.

  Technical spec: schematic/docs/multipart-form-data.md
  - Add FormField, FormFieldKind, and ApiRequest types
  - Update Endpoint struct to use Option<ApiRequest> instead of Option<Schema>
  - Provide builder helpers for ergonomic API definition
  - Maintain consistency with existing REST and WebSocket primitives

  Clarified decisions:
  - Direct breaking change: Replace Option<Schema> with Option<ApiRequest> immediately (no phased migration)
  - Full scope: Include all ApiRequest variants (Json, FormData, UrlEncoded, Text, Binary)
  - Security in generator: Definition types are pure data; security (size limits, sanitization) handled by code generator
required_skills:
  - rust (repo)
  - serde (user)
  - strum (user)
  - thiserror (repo)
important_skills:
  reqwest: "when reviewing client-side implementation examples"
  axum: "if server-side handler generation is discussed"
  prettyplease: "if code generator needs to format generated Rust code"
  syn: "if code generator performs AST manipulation"
subagents:
  Plan: "Create phased implementation plan"
  Explore: "Module assessment for monorepo impact"
  general-purpose: "Reviews (completeness, concurrency, correctness)"
  feature-tester-rust: "Test implementation phases"
monorepo_modules_impacted:
  - schematic/define (PRIMARY - add new types, update Endpoint struct)
  - schematic/definitions (migrate existing endpoints to ApiRequest)
  - schematic/gen (update code generator for new request types)
  - schematic/schema (auto-generated, will need reqwest multipart feature)
completeness_changes:
  - Add Serialize/Deserialize derives to all new types
  - Add text() and binary() builder methods to ApiRequest
  - Clarify Phase 3 scope (migrate existing vs add new)
  - Add explicit module organization requirements to Phase 1
  - Add test categories specification to Phase 4
concurrency_changes:
  - Split Phase 4 into Phase 4a (unit tests, parallel with 2-3) and Phase 4b (integration tests)
  - Enable concurrent test execution with cargo test --workspace
  - Add compile-time barrier after Phase 2 to prevent race conditions
detail_changes:
  - Add From<Schema> for ApiRequest impl for backward compatibility
  - Add FormField::files() builder method
  - Specify exact file paths in Phase 1
lessons_learned_count: 0
---
# Planning Process

- [x] Prep Started [12:47pm]
    - [x] Identified Skills [12:48pm]
    - [x] Identified Subagents [12:48pm]
- [x] Prep complete [12:48pm]
- [x] Clarification (orchestrator) [12:49pm]
    - [x] User answered clarifying questions (human in the loop) [12:49pm]
    - [x] Requirements updated: direct breaking change, full scope, security in generator [12:49pm]
- [x] Planning Subagent [agent: **Plan**] started [12:49pm]
    - [x] subagent skills used: rust, serde, strum, thiserror
    - [x] Planning completed [12:51pm]
- [x] Module Assessment Subagent [agent: **Explore**] started [12:49pm]
    - [x] subagent skills used: rust
    - [x] Module Assessment completed [12:51pm]
- [x] All Pre-review Steps are complete [12:51pm]
- [x] Review Started [12:52pm]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, serde, strum
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, serde, strum
- [x] Reviews Completed [12:53pm]
- [x] Plan Finalization [agent: **general-purpose**] started [12:54pm]
    - [x] subagent skills used: rust, serde, strum
- [x] Plan finalized [12:55pm]
- Final Steps
    - [x] Lessons learned collected from all subagents [12:55pm]
    - [x] No new packages to research (existing deps sufficient)
- [x] Summarized plan to user via STDOUT [12:55pm]
    - Project File: `.ai/plans/2026-01-16.plan-for-multipart-form-data-support.md`
    - Started: 12:47pm
    - Completed: 12:55pm
    - Duration: 8 minutes



## Plan

### Phase 1: Add New Types

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, serde, strum |
| **Suggested Skills** | thiserror (if error variants added) |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | No (foundational) |

**Objective:** Create `FormField`, `FormFieldKind`, and `ApiRequest` types in a new `request.rs` module following existing patterns.

**Tasks:**

1. Create `/Volumes/coding/personal/dockhand/schematic/define/src/request.rs` with:
   - `FormFieldKind` enum: `Text`, `File { accept }`, `Files { accept, min, max }`, `Json(Schema)`
   - `FormField` struct: `name`, `kind`, `required`, `description`
   - `ApiRequest` enum: `Json(Schema)`, `FormData { fields }`, `UrlEncoded { fields }`, `Text { content_type }`, `Binary { content_type }`

2. Add derives to all new types:
   ```rust
   #[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
   ```

3. Implement builder helpers on `FormField`:
   - `text(name)`, `file(name)`, `file_accept(name, accept)`, `files(name)`, `files_with_constraints(name, accept, min, max)`, `json(name, schema)`
   - `optional(self)`, `with_description(self, desc)`

4. Implement builder helpers on `ApiRequest`:
   - `json(schema)`, `json_type(type_name)`, `form_data(fields)`, `url_encoded(fields)`, `text(content_type)`, `binary(content_type)`

5. Implement backward compatibility:
   ```rust
   impl From<Schema> for ApiRequest {
       fn from(schema: Schema) -> Self { ApiRequest::Json(schema) }
   }
   ```

6. Update module exports in `lib.rs` and `prelude.rs`

**Acceptance Criteria:**
- [ ] All types compile with required derives
- [ ] Builder methods chain correctly
- [ ] `From<Schema>` conversion works
- [ ] Module exports visible from crate root and prelude

---

### Phase 2: Update Endpoint Struct

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (with Phase 4a) |

**Objective:** Change `Endpoint.request` from `Option<Schema>` to `Option<ApiRequest>`.

**Tasks:**
1. Update `Endpoint` struct in `types.rs`: `pub request: Option<ApiRequest>`
2. Update imports in `types.rs`
3. Update docstring examples to use `ApiRequest::json_type()`

**Compile-Time Barrier:** After Phase 2, run `cargo check -p schematic-define` before Phase 3.

**Acceptance Criteria:**
- [ ] `Endpoint.request` field accepts `Option<ApiRequest>`
- [ ] All doctests pass
- [ ] Module compiles without errors

---

### Phase 3: Update API Definitions

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 2 (compile-time barrier) |
| **Parallelizable** | Yes (with Phase 4b) |

**Scope:** Migrate **existing** endpoints only. Does NOT add new multipart endpoints (that is Phase 5).

**Tasks:**
1. Update each endpoint's `request` field: `Some(Schema::new("..."))` → `Some(ApiRequest::json_type("..."))`
2. Update imports in definition files

**Acceptance Criteria:**
- [ ] All existing definitions compile
- [ ] No functional changes to endpoint behavior
- [ ] `cargo test -p schematic-definitions` passes

---

### Phase 4a: Unit Tests for New Types

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, serde |
| **Suggested Skills** | strum (for enum iteration tests) |
| **Complexity** | Medium |
| **Dependencies** | Phase 1 only |
| **Parallelizable** | Yes (with Phase 2, Phase 3) |

**Objective:** Unit tests for all new types and builders.

**Test Categories:**
- **Serde Roundtrip Tests:** All variants serialize/deserialize correctly
- **Builder Chaining Tests:** `FormField::text("name").optional().with_description("desc")`
- **Enum Variant Equality Tests:** Variant equality/inequality
- **From Trait Tests:** `ApiRequest::from(Schema::new("Foo"))`

**Acceptance Criteria:**
- [ ] All tests pass with `cargo test -p schematic-define --lib`
- [ ] Coverage for all public methods and enum variants

---

### Phase 4b: Integration Tests

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, serde |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 3 |
| **Parallelizable** | Yes (with Phase 5 after Phase 3) |

**Objective:** Integration tests demonstrating realistic usage patterns.

**Test Categories:**
- Create complete `RestApi` with mixed endpoint types (JSON, FormData)
- Serialize entire API definition to JSON and back
- Compatibility tests for migrated definitions

**Acceptance Criteria:**
- [ ] `cargo test -p schematic-define` passes all tests

---

### Phase 5: Add Example Multipart Endpoint

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 3, Phase 4b |
| **Parallelizable** | No |

**Objective:** Add real multipart form-data endpoint to ElevenLabs definition.

**Example:**
```rust
Endpoint {
    id: "AddVoiceSample".to_string(),
    method: RestMethod::Post,
    path: "/v1/voices/{voice_id}/samples".to_string(),
    description: "Upload audio sample for voice cloning".to_string(),
    request: Some(ApiRequest::form_data(vec![
        FormField::file_accept("audio", vec!["audio/*".into()])
            .with_description("Audio file (mp3, wav, ogg)"),
        FormField::text("name").optional().with_description("Sample name"),
    ])),
    response: ApiResponse::json_type("AddSampleResponse"),
    headers: vec![],
}
```

**Acceptance Criteria:**
- [ ] At least one endpoint uses `ApiRequest::form_data()`
- [ ] Demonstrates realistic file upload pattern
- [ ] All tests pass

---

### Phase 6: Update README Documentation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 5 |
| **Parallelizable** | No (final phase) |

**Objective:** Document new types and usage patterns in package README.

**Tasks:**
1. Update `schematic/define/README.md`: Document `ApiRequest`, `FormField`, `FormFieldKind`
2. Add migration notes: `Option<Schema>` to `Option<ApiRequest>` change

**Acceptance Criteria:**
- [ ] Documentation covers all new public types
- [ ] Examples are copy-pasteable and compile
- [ ] Migration path clearly documented

---

## Dependency Graph

```
Phase 1 (New Types)
    │
    ├────────────────┬────────────────┐
    │                │                │
    ▼                ▼                │
Phase 2          Phase 4a         (parallel)
(Update Endpoint)  (Unit Tests)
    │
    ▼
[compile-time barrier]
    │
    ├────────────────┐
    │                │
    ▼                ▼
Phase 3          Phase 4b
(Migrate Defs)   (Integration Tests)
    │                │
    └────────────────┘
            │
            ▼
        Phase 5 (Example Multipart)
            │
            ▼
        Phase 6 (Update README)
```

## Modules Impacted

| Module | Impact | Files Changed |
|--------|--------|---------------|
| schematic/define | PRIMARY | +1 new, ~4 modified |
| schematic/definitions | MIGRATION | ~2 modified |
| schematic/gen | OUT OF SCOPE | (future work) |
| schematic/schema | OUT OF SCOPE | (auto-generated) |

## Out-of-Scope Notes

1. **Codegen `into_parts()` expansion**: The code generator will need updates to handle `ApiRequest` variants. Tracked separately.
2. **OpenAPI generation**: Mapping `FormFieldKind` to OpenAPI 3.x is documented but not implemented here.
3. **Server-side parsing**: `multer` integration patterns are documented but not implemented.


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing.

- [CODEBASE: schematic-define]: Well-structured with consistent patterns across modules (response.rs, websocket.rs) that make extending the type system straightforward
- [SPEC: multipart-form-data.md]: Comprehensive technical spec with clear guidance; RFC compliance well documented
- [ARCHITECTURE: ApiResponse pattern]: Existing enum pattern for multiple content types provides perfect template for ApiRequest design
- [PLANNING: Phase scope clarity]: Mixing "migrate existing" and "add new" in same phase causes ambiguity; keep separate

## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation.

- **No new dependencies required** - existing serde and strum are sufficient for schematic-define
- **Future (out of scope)**: schematic-gen may need reqwest multipart feature enabled when code generator is updated


