# Implementation Plan: Anthropic Skills API Client

**Date**: 2026-01-13
**Status**: Planning

## Critical Finding: Expected Behavior NOT Implemented

**After source code review**, the expected behavior described by the user (method-based parameter routing) is **NOT currently implemented**:

1. **Current implementation** only supports:
   - Path parameters (from `{param}` syntax)
   - Request body (for POST/PUT/PATCH/OPTIONS)
   - NO query parameters at all

2. **Expected behavior** (NOT implemented):
   - **GET/HEAD/DELETE/TRACE**: path params → query params (no body)
   - **POST/PUT/PATCH/OPTIONS**: path params → JSON body

3. **Documentation gap**:
   - Neither README documents query parameters
   - Neither README documents method-based routing
   - Static headers not supported (needed for `anthropic-beta`, `anthropic-version`)

**This plan implements the full expected behavior to support Anthropic Skills API.**

## Overview

Generate a strongly-typed Rust client for Anthropic Skills API using Schematic code generator. The Skills API enables programmatic creation, listing, retrieval, and deletion of custom Claude skills.

## Current State Analysis

### Existing Schematic Behavior

**After source code review**, current implementation does NOT support query parameters:

1. **Request structs** (`schematic/gen/src/codegen/request_structs.rs`):
   - Only include path parameters extracted from `{param}` syntax
   - Optional `body` field for request schema
   - NO query parameter fields

2. **into_parts() method**:
   - Returns `(method, path, Option<body>)`
   - Path is built by substituting path parameters
   - NO query string construction

3. **Client request() method** (`schematic/gen/src/codegen/client.rs`):
   - Builds URL: `format!("{}{}", base_url, path)`
   - Applies authentication
   - Adds body if present
   - NO query parameter handling

### Documentation Gap

**Neither** `schematic/README.md` nor `schematic/define/README.md` documents:
- Query parameter support
- Method-based parameter routing (GET→query vs POST→body)

The documentation only mentions:
- Path parameters (`{param}` syntax)
- Request body for POST/PUT/PATCH
- Response types

### Conclusion

The user's expected behavior (query parameters for GET/HEAD/DELETE/TRACE, body for others) is **NOT currently implemented**. This plan implements that behavior.

## API Specification

### Base Configuration

- **Base URL**: `https://api.anthropic.com/v1`
- **Authentication**: X-API-Key header (API key from environment)
- **Beta Header**: `anthropic-beta: skills-2025-10-02` (required)
- **Version Header**: `anthropic-version: 2023-06-01` (required)

### Endpoints

| Endpoint | Method | Path | Description | Request | Response |
|----------|---------|-------|-------------|----------|
| Create Skill | POST | `/v1/skills` | Create a new skill from uploaded files | `CreateSkillResponse` |
| List Skills | GET | `/v1/skills` | List all skills with pagination | `ListSkillsResponse` |
| Get Skill | GET | `/v1/skills/{skill_id}` | Retrieve a specific skill | `Skill` |
| Delete Skill | DELETE | `/v1/skills/{skill_id}` | Delete a skill | `DeleteSkillResponse` |

## Phase 1: Extend Schematic Type System

### 1.1 Add Query Parameter Support to Endpoint

**Problem**: Schematic currently only supports path parameters, but the expected design is that GET/HEAD/DELETE/TRACE methods should use query parameters while other methods use body JSON. This behavior is documented but NOT implemented.

**Solution**: Extend `Endpoint` type and request generation to support:
- Query parameter definitions
- Method-based routing (GET/HEAD/DELETE/TRACE → query params, others → body)
- Query string construction in `into_parts()`

#### Changes Required

**File**: `schematic/define/src/types.rs`

```rust
#[derive(Debug, Clone, PartialEq, Eq)]
pub struct Endpoint {
    pub id: String,
    pub method: RestMethod,
    pub path: String,
    pub description: String,
    pub request: Option<Schema>,
    pub response: ApiResponse,
    // NEW: Optional query parameters for GET requests
    pub query_params: Vec<QueryParam>,
}
```

**File**: `schematic/define/src/types.rs` (new type)

```rust
#[derive(Debug, Clone, PartialEq, Eq)]
pub struct QueryParam {
    pub name: String,
    pub param_type: QueryParamType,
    pub required: bool,
    pub description: String,
}

#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum QueryParamType {
    String,
    Number,
    Boolean,
}
```

#### Rationale

- Query parameters are distinct from path parameters
- They appear in URL as `?key=value` pairs
- GET requests commonly use filtering/pagination via query params
- Type safety for query params prevents runtime errors

### 1.2 Add Static Headers Support to RestApi

**Problem**: Anthropic requires custom headers beyond authentication (`anthropic-beta`, `anthropic-version`).

**Solution**: Extend `RestApi` to include static headers array that are sent with every request.

**Note**: Anthropic can use existing `AuthStrategy::ApiKey { header: "X-API-Key".to_string() }` variant - no new auth type needed. Static headers will handle `anthropic-beta` and `anthropic-version`.

#### Changes Required

**File**: `schematic/define/src/types.rs`

```rust
#[derive(Debug, Clone, PartialEq, Eq)]
pub struct RestApi {
    pub name: String,
    pub description: String,
    pub base_url: String,
    pub docs_url: Option<String>,
    pub auth: AuthStrategy,
    pub env_auth: Vec<String>,
    pub env_username: Option<String>,
    pub env_password: Option<String>,
    pub endpoints: Vec<Endpoint>,
    // NEW: Static headers added to all requests
    pub headers: Vec<Header>,
}
```

**File**: `schematic/define/src/types.rs` (new type)

```rust
#[derive(Debug, Clone, PartialEq, Eq)]
pub struct Header {
    pub name: String,
    pub value: String,
}
```

#### Rationale

- Beta APIs often require versioning headers
- Some APIs need custom metadata headers
- Headers are consistent across all requests
- Values are static (not per-request dynamic)

### 1.3 Authentication for Anthropic

**Analysis**: Anthropic requires `X-API-Key` header for authentication.

**Solution**: Use existing `AuthStrategy::ApiKey { header: "X-API-Key".to_string() }` variant. No new auth type needed.

**Note**: Static headers feature (Phase 1.2) will handle `anthropic-beta` and `anthropic-version` headers required by Anthropic API.

## Phase 2: Create Anthropic Skills API Definition

### 2.1 Define Response Types

**File**: `schematic/define/src/apis/anthropic.rs` (new file)

```rust
use serde::{Deserialize, Serialize};

/// A skill object returned from the API.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Skill {
    pub id: String,
    pub created_at: String,  // ISO 8601 timestamp
    pub display_title: String,
    pub latest_version: String,
    pub source: String,  // "custom" or "anthropic"
    #[serde(rename = "type")]
    pub object_type: String,  // "skill"
    pub updated_at: String,  // ISO 8601 timestamp
}

/// Response from Create Skill endpoint.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CreateSkillResponse {
    pub id: String,
    pub created_at: String,
    pub display_title: String,
    pub latest_version: String,
    pub source: String,
    pub object_type: String,
    pub updated_at: String,
}

/// Response from List Skills endpoint.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ListSkillsResponse {
    pub data: Vec<Skill>,
    pub has_more: bool,
    pub next_page: Option<String>,
}

/// Response from Delete Skill endpoint.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeleteSkillResponse {
    pub id: String,
    pub object_type: String,  // "skill_deleted"
}
```

### 2.2 Define Create Skill Request

**Note**: Files upload requires multipart/form-data, which is a more complex case. For MVP, support `display_title` only (files can be added later).

```rust
/// Request to create a new skill.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CreateSkillRequest {
    pub display_title: Option<String>,
    // TODO: Add file upload support (multipart/form-data)
}
```

### 2.3 Define Complete API

```rust
use crate::{
    ApiResponse, AuthStrategy, Endpoint, Header, QueryParam, QueryParamType,
    RestApi, RestMethod,
};

/// Creates the Anthropic Skills API definition.
///
/// ## Endpoints
///
/// - `CreateSkill` - POST /skills
/// - `ListSkills` - GET /skills (with query params)
/// - `GetSkill` - GET /skills/{skill_id}
/// - `DeleteSkill` - DELETE /skills/{skill_id}
///
/// ## Authentication
///
/// Uses X-API-Key header for authentication (ANTHROPIC_API_KEY env var).
///
/// ## Beta Header
///
/// All requests include `anthropic-beta: skills-2025-10-02`.
///
/// ## Example
///
/// ```rust
/// use schematic_define::apis::define_anthropic_skills_api;
///
/// let api = define_anthropic_skills_api();
/// assert_eq!(api.name, "AnthropicSkills");
/// ```
pub fn define_anthropic_skills_api() -> RestApi {
    RestApi {
        name: "AnthropicSkills".to_string(),
        description: "Anthropic Skills API for skill management".to_string(),
        base_url: "https://api.anthropic.com/v1".to_string(),
        docs_url: Some("https://platform.claude.com/docs/en/api/beta/skills".to_string()),
        auth: AuthStrategy::ApiKeyHeader {
            header: "X-API-Key".to_string(),
        },
        env_auth: vec!["ANTHROPIC_API_KEY".to_string()],
        env_username: None,
        env_password: None,
        headers: vec![
            Header {
                name: "anthropic-beta".to_string(),
                value: "skills-2025-10-02".to_string(),
            },
            Header {
                name: "anthropic-version".to_string(),
                value: "2023-06-01".to_string(),
            },
        ],
        endpoints: vec![
            // Create Skill
            Endpoint {
                id: "CreateSkill".to_string(),
                method: RestMethod::Post,
                path: "/skills".to_string(),
                description: "Create a new skill".to_string(),
                request: Some(Schema::with_path(
                    "CreateSkillRequest",
                    "crate::apis::anthropic",
                )),
                response: ApiResponse::json_type("CreateSkillResponse"),
                query_params: vec![],
            },
            // List Skills
            Endpoint {
                id: "ListSkills".to_string(),
                method: RestMethod::Get,
                path: "/skills".to_string(),
                description: "List all skills".to_string(),
                request: None,
                response: ApiResponse::json_type("ListSkillsResponse"),
                query_params: vec![
                    QueryParam {
                        name: "limit".to_string(),
                        param_type: QueryParamType::Number,
                        required: false,
                        description: "Number of results (max 100, default 20)".to_string(),
                    },
                    QueryParam {
                        name: "page".to_string(),
                        param_type: QueryParamType::String,
                        required: false,
                        description: "Pagination token from previous response".to_string(),
                    },
                    QueryParam {
                        name: "source".to_string(),
                        param_type: QueryParamType::String,
                        required: false,
                        description: "Filter by source: 'custom' or 'anthropic'".to_string(),
                    },
                ],
            },
            // Get Skill
            Endpoint {
                id: "GetSkill".to_string(),
                method: RestMethod::Get,
                path: "/skills/{skill_id}".to_string(),
                description: "Retrieve a skill by ID".to_string(),
                request: None,
                response: ApiResponse::json_type("Skill"),
                query_params: vec![],
            },
            // Delete Skill
            Endpoint {
                id: "DeleteSkill".to_string(),
                method: RestMethod::Delete,
                path: "/skills/{skill_id}".to_string(),
                description: "Delete a skill".to_string(),
                request: None,
                response: ApiResponse::json_type("DeleteSkillResponse"),
                query_params: vec![],
            },
        ],
    }
}
```

### 2.4 Add Module Export

**File**: `schematic/define/src/apis/mod.rs`

```rust
pub mod anthropic;
pub mod openai;

pub use anthropic::define_anthropic_skills_api;
pub use openai::define_openai_api;
```

## Phase 3: Extend Code Generator

### 3.1 Update Request Struct Generation for Method-Based Routing

**Problem**: Request structs need to include query parameters for GET/HEAD/DELETE/TRACE methods, but current generator only includes path parameters.

**Solution**: Modify `generate_request_struct()` in `request_structs.rs` to:

1. Check endpoint's HTTP method type
2. For GET/HEAD/DELETE/TRACE:
   - Generate query parameter fields (from `endpoint.query_params`)
   - Exclude `body` field (these methods don't use body)
3. For POST/PUT/PATCH/OPTIONS:
   - Generate body field (from `endpoint.request`)
   - Exclude query parameters (these use body instead)

**Expected Behavior**:
```rust
// GET endpoint with query params (ListSkills)
pub struct ListSkillsRequest {
    pub limit: Option<u32>,
    pub page: Option<String>,
    pub source: Option<String>,
}

// POST endpoint with body (CreateSkill)
pub struct CreateSkillRequest {
    pub body: CreateSkillRequest,
}
```

### 3.2 Update into_parts() for Query String Construction

**Problem**: Current `into_parts()` only returns `(method, path, body)`, but query parameters need to be returned too.

**Solution**: Modify `generate_into_parts()` to:

1. Return 4-tuple: `(method, path, body, query_string)`
2. For GET/HEAD/DELETE/TRACE with query params:
   - Build query string from field values
   - URL-encode parameter values
   - Return `Some(query_string)`
3. For POST/PUT/PATCH/OPTIONS:
   - Return `None` for query_string (body used instead)

**Expected Signature**:
```rust
pub fn into_parts(self) -> Result<(&'static str, String, Option<String>, Option<String>), SchematicError> {
    // ... path substitution ...
    // ... query string construction ...
    Ok((method_str, path, body_expr, query_string_expr))
}
```

### 3.3 Update Client request() Method

**Problem**: Current client method only handles `(method, path, body)`, needs to append query string to URL.

**Solution**: Modify `generate_request_method()` in `client.rs` to:

1. Accept 4-tuple from `into_parts()`: `(method, path, body, query_string)`
2. Append query string to URL if present:
```rust
let url = if let Some(query) = query_string {
    format!("{}{}?{}", self.base_url, path, query)
} else {
    format!("{}{}", self.base_url, path)
};
```

#### Changes Required

**File**: `schematic/gen/src/output.rs`

For each endpoint with query parameters, generate:

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ListSkillsQueryParams {
    #[serde(skip_serializing_if = "Option::is_none")]
    pub limit: Option<u32>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub page: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub source: Option<String>,
}

impl ListSkillsQueryParams {
    pub fn to_url_string(&self) -> String {
        let mut params = Vec::new();
        if let Some(limit) = &self.limit {
            params.push(format!("limit={}", limit));
        }
        if let Some(page) = &self.page {
            params.push(format!("page={}", urlencoding::encode(page)));
        }
        if let Some(source) = &self.source {
            params.push(format!("source={}", source));
        }
        if params.is_empty() {
            String::new()
        } else {
            format!("?{}", params.join("&"))
        }
    }
}
```

Update request struct to include query params:

```rust
pub struct ListSkillsRequest {
    pub query_params: ListSkillsQueryParams,
}
```

Update HTTP client method to append query string:

```rust
fn build_url(&self, endpoint_id: &str) -> Result<String, SchematicError> {
    // ... existing path substitution ...
    let query_string = self.query_params.to_url_string();
    Ok(format!("{}{}{}", self.base_url, path, query_string))
}
```

### 3.2 Custom Headers in Generated Client

**Problem**: Generator must add static headers to all requests.

**Solution**: Store headers in client struct and add to each request.

#### Changes Required

**File**: `schematic/gen/src/output.rs`

Generate client with headers field:

```rust
pub struct AnthropicSkills {
    base_url: String,
    api_key: String,
    http_client: reqwest::Client,
    headers: Vec<(String, String)>,
}

impl AnthropicSkills {
    pub fn new() -> Result<Self, SchematicError> {
        let api_key = std::env::var("ANTHROPIC_API_KEY")
            .map_err(|_| SchematicError::MissingCredential("ANTHROPIC_API_KEY".to_string()))?;

        let mut headers = Vec::new();
        headers.push(("anthropic-beta".to_string(), "skills-2025-10-02".to_string()));
        headers.push(("anthropic-version".to_string(), "2023-06-01".to_string()));

        Ok(Self {
            base_url: "https://api.anthropic.com/v1".to_string(),
            api_key,
            http_client: reqwest::Client::new(),
            headers,
        })
    }

    fn add_headers(&self, builder: reqwest::RequestBuilder) -> reqwest::RequestBuilder {
        let mut builder = builder.header("X-API-Key", &self.api_key);
        for (name, value) in &self.headers {
            builder = builder.header(name, value);
        }
        builder
    }
}
```

### 3.3 Remove Redundant API Key Header Section

**Action**: Section 1.3 already covers using existing `AuthStrategy::ApiKey` for Anthropic. No separate section needed for handling ApiKeyHeader.

## Phase 4: Implementation Steps

### Step 1: Extend Type System
- [ ] Add `QueryParam` and `QueryParamType` to `types.rs`
- [ ] Add `Header` to `types.rs`
- [ ] Extend `Endpoint` with `query_params` field
- [ ] Extend `RestApi` with `headers` field
- [ ] Update tests for new types

**Note**: No new auth type needed - Anthropic uses existing `AuthStrategy::ApiKey { header: "X-API-Key" }`

### Step 2: Create Anthropic API Definition

- [ ] Create `schematic/define/src/apis/anthropic.rs`
- [ ] Define response types (`Skill`, `CreateSkillResponse`, `ListSkillsResponse`, `DeleteSkillResponse`)
- [ ] Define request types (`CreateSkillRequest`)
- [ ] Implement `define_anthropic_skills_api()` function
- [ ] Add comprehensive tests for API definition
- [ ] Update `schematic/define/src/apis/mod.rs` to export

### Step 3: Extend Code Generator
- [ ] Modify `generate_request_struct()` to add query param fields for GET/HEAD/DELETE/TRACE methods
- [ ] Modify `generate_into_parts()` to return 4-tuple with query string
- [ ] Modify `generate_request_method()` to append query string to URL
- [ ] Add static headers support in `generate_api_struct()` and `generate_request_method()`
- [ ] Handle `AuthStrategy::ApiKey` variant for X-API-Key header
- [ ] Add `urlencoding` dependency to generated Cargo.toml

### Step 4: Generate and Test Client

- [ ] Run `schematic-gen --api anthropic-skills --output schematic/schema/src`
- [ ] Verify generated code compiles: `cargo check -p schematic-schema`
- [ ] Write integration tests for each endpoint
- [ ] Test with real API (if API key available)
- [ ] Document usage examples

### Step 5: Documentation

- [ ] Update `schematic/README.md` with new features (query params, headers, api key header)
- [ ] Create example in `schematic/define/src/apis/anthropic.rs` usage section
- [ ] Add to `schematic/README.md` examples section

## Phase 5: Testing Strategy

### Unit Tests

**Definition Tests** (`schematic/define/src/apis/anthropic.rs`):

- API metadata correctness (name, base URL, docs URL)
- All four endpoints defined
- Query parameters for ListSkills (limit, page, source)
- Path parameters for GetSkill/DeleteSkill (skill_id)
- Custom headers set correctly (beta, version)
- Auth strategy is ApiKeyHeader

**Type Tests** (`schematic/define/src/apis/anthropic.rs`):

- `Skill` type serialization/deserialization
- `ListSkillsResponse` type with pagination fields
- `CreateSkillRequest` optional fields

### Integration Tests

**Generated Client Tests** (`schematic/gen/tests/e2e_generation.rs`):

- Client initialization with API key
- Missing API key error handling
- `CreateSkill` request construction
- `ListSkills` with query parameters
- `ListSkills` pagination (using `next_page` token)
- `GetSkill` with path parameter
- `DeleteSkill` with path parameter
- Custom headers present in all requests

### Mock Tests

**HTTP Mock Tests** (using `wiremock`):

- Mock successful CreateSkill response
- Mock ListSkills with pagination
- Mock GetSkill response
- Mock DeleteSkill response
- Verify correct headers sent (X-API-Key, anthropic-beta, anthropic-version)
- Verify query string construction
- Verify path parameter substitution

## Phase 6: Dependencies

### Dependencies for Generated Code

**File**: `schematic/gen/src/cargo_gen.rs`

```rust
dependencies = vec![
    "reqwest = { version = \"0.12\", features = [\"json\"] }",
    "serde = { version = \"1.0\", features = [\"derive\"] }",
    "serde_json = \"1.0\"",
    "thiserror = \"2.0\"",
    "urlencoding = \"2.1\"",  // NEW: For query parameter encoding
]
```

### Existing Dependencies Used

- `serde`/`serde_json`: Request/response serialization
- `reqwest`: HTTP client
- `thiserror`: Error types
- `tokio`: Async runtime (from workspace)

## Phase 7: Known Limitations and Future Work

### MVP Limitations

1. **File Upload Not Supported**
   - Create Skill requires file upload (multipart/form-data)
   - MVP will support only `display_title` field
   - Future: Add `multipart/form-data` request type support

2. **Streaming Responses Not Supported**
   - Anthropic may add streaming for skill creation
   - Current design assumes request/response pattern
   - Future: Add `Stream` variant to `ApiResponse`

3. **Error Details Not Captured**
   - API may return detailed error messages
   - Generated client uses generic error types
   - Future: Add API-specific error schemas

### Future Enhancements

1. **Pagination Helper Methods**
   - Auto-fetch all pages with `fetch_all_skills()`
   - Iterator-based pagination interface

2. **Retry Logic**
   - Exponential backoff for rate limits
   - Configurable retry counts

3. **Type-Safe Enums for Query Params**
   - `source` should be enum: `Source::Custom | Source::Anthropic`
   - Prevent invalid values at compile time

4. **Webhook Support**
   - If API adds skill update webhooks
   - Generate webhook validation structs

## Success Criteria

- [ ] All type system extensions compile without errors
- [ ] Anthropic Skills API definition passes all tests
- [ ] Generated code compiles successfully
- [ ] All four endpoints work correctly in tests
- [ ] Query parameters properly encoded in URLs
- [ ] Custom headers sent with all requests
- [ ] API key header authentication works
- [ ] Documentation is complete and accurate

## Estimated Timeline

- **Phase 1**: 2 hours (type system extensions)
- **Phase 2**: 1 hour (API definition)
- **Phase 3**: 3 hours (generator extensions)
- **Phase 4**: 2 hours (generation and testing)
- **Phase 5**: 2 hours (test suite)
- **Phase 7**: 1 hour (documentation)

**Total**: ~11 hours

## References

- [Schematic README](../schematic/README.md)
- [OpenAI Example](../schematic/define/src/apis/openai.rs)
- [Anthropic Skills API - List](https://platform.claude.com/docs/en/api/beta/skills/list)
- [Anthropic Skills API - Retrieve](https://platform.claude.com/docs/en/api/beta/skills/retrieve)
- [Anthropic Skills API - Delete](https://platform.claude.com/docs/en/api/beta/skills/delete)
- [Anthropic Skills API - Create (Go SDK)](https://platform.claude.com/docs/en/api/go/beta/skills/create)
