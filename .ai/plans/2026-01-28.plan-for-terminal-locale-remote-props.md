---
status: "done"
started_at: "now"
finished_at:
duration:
tts_gender: male
requirements: |
  Add "remote", "locale", and "char_encoding" properties to the Terminal struct.
  Types have been partially added but have compilation errors that need fixing.
context_budget:
  estimated_pct: 15
  complexity: simple
  checkpoints: {}
required_skills: []
important_skills: {}
subagents: {}
monorepo_modules_impacted: ["biscuit-terminal"]
risks:
  high: 0
  medium: 0
  low: 0
lessons_learned_count: 0
---

# Planning Process

- [x] Pre-flight Check
    - [x] Directories ready
    - [x] Budget estimated: simple (~15%)
- [x] Analysis Complete
    - [x] Identified 4 compilation errors
    - [x] Identified fix strategy

## Current Compilation Errors

1. **E0252**: Duplicate `use std::env;` in `locale.rs` (line 1 and 5)
2. **E0726/E0261**: Incorrect `Deserialize` impl for `CharEncoding` - needs proper lifetime handling
3. **E0063**: Missing `remote` field initialization in `new_terminal()`

## Plan

### Phase 1: Fix locale.rs Issues
**Agent:** self | **Skills:** rust | **Complexity:** Low

**Goal:** Fix compilation errors in locale.rs

**Deliver:**
- Remove duplicate `use std::env;`
- Fix `Deserialize` impl using derive macro instead of manual impl
- Implement `Default` for `CharEncoding` (detect from env)
- Implement `Default` for `TerminalLocale` (detect from env)

**Pass when:**
- [ ] No compilation errors in locale.rs

### Phase 2: Fix terminal.rs Initialization
**Agent:** self | **Skills:** rust | **Complexity:** Low

**Goal:** Add remote field initialization and connection detection

**Deliver:**
- Add `detect_connection()` function to detection.rs
- Initialize `remote` field in `new_terminal()`

**Pass when:**
- [ ] Terminal struct initializes without errors
- [ ] `cargo check -p biscuit-terminal` passes

### Phase 3: Verify Tests Pass
**Agent:** self | **Skills:** rust | **Complexity:** Low

**Goal:** Ensure all tests pass

**Pass when:**
- [ ] `cargo test -p biscuit-terminal` passes

## Implementation Details

### CharEncoding Detection Strategy
- Check `LC_CTYPE` / `LC_ALL` / `LANG` for encoding suffix (`.UTF-8`, etc.)
- Default to `Utf8` on modern systems

### TerminalLocale Detection Strategy
- Use existing `effective_locale_tag()` function
- Wrap result in `TerminalLocale(Option<String>)`

### Connection Detection Strategy
- Check `SSH_CLIENT` env var for SSH connections (format: "client_ip client_port server_port")
- Check `SSH_TTY` for TTY path
- Check `MOSH_CONNECTION` for Mosh
- Default to `Connection::Local` if no remote indicators
