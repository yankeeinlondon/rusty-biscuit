---
status: "done"
started_at: 15:23:18
finished_at: 15:33:09
duration: ~10 minutes
tts_gender: male
requirements:
  The biscuit-hash package has been created to replace the hashing functionality found in the biscuit package. This plan should NOT remove this functionality from biscuit but rather ensure that all the tests and functionality is usable in this new library. Unlike in the biscuit package, however, we will provide feature flags for each of the hashing algorithms and by default only turn on the xx_hash algorithm.
required_skills: [rust, thiserror, blake3, xx-hash]
important_skills:
  monorepos: "Understanding workspace structure and feature flag propagation"
  nextest: "Running tests during validation"
subagents:
  Plan: "Creating the phased implementation plan"
  Explore: "Module assessment for monorepo impact"
  general-purpose: "Reviews and finalization"
  feature-tester-rust: "Test validation"
monorepo_modules_impacted:
  - biscuit (internal hashing usage in markdown/toc, markdown/delta, mermaid)
  - biscuit-hash (new package - primary target)
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 7
---
# Planning Process

- [x] Prep Started [15:23:18]
    - [x] Identified Skills [15:24]: rust, thiserror, blake3, xx-hash
    - [x] Identified Subagents [15:24]: Plan, Explore, general-purpose, feature-tester-rust
- [x] Prep complete [15:24]
- [x] Clarify with user (human in the loop) [15:26]
    - [x] Requirements updated based on user responses [15:26]
        - Default feature: xx_hash only
        - Structure: HashVariant integrated into xx module
        - Error handling: Use thiserror for Argon2idError
- [x] Planning Subagent [agent: Plan] started [15:26]
    - [x] subagent skills used: rust, thiserror, blake3, xx-hash
    - [x] Planning completed [15:27]
- [x] Module Assessment Subagent [agent: Explore] started [15:26]
    - [x] subagent skills used: rust, monorepos
    - [x] Module Assessment completed [15:27]
    - Impact: Minimal - hashing only used internally within biscuit
- [x] All Pre-review Steps are complete [15:27]
- [x] Review Started [15:28]
   - [x] Completeness Review
       - [x] subagent skills used: rust
       - Issues found: edition clarity, dependency strategy, re-export pattern
   - [x] Concurrency Review
       - [x] subagent skills used: rust, monorepos
       - Opportunities: Phase 4+5 parallel, split Phase 6 validation
   - [x] Details/Knowledge Based Review
       - [x] subagent skills used: rust
       - Issues: HashMap import, invalid crate path, thiserror optional conflict
- [x] Reviews Completed [15:29]
- [x] Plan Finalization started [15:29]
    - [x] subagent skills used: rust, thiserror, blake3, xx-hash
- [x] Plan finalized [15:30]
- Final Steps
    - [x] Lessons learned collected from all subagents (4 items)
    - [x] No new packages to research (all deps exist, restructuring only)
- [x] Summarized plan to user via STDOUT [15:33]
    - Project File: .ai/plans/2026-01-15.plan-for-biscuit-hash-migration.md
    - Started: 15:23:18
    - Completed: 15:33:09
    - Duration: ~10 minutes

## Plan

### Phase 1: Update Cargo.toml with Feature Flags

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | monorepos (workspace patterns) |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | No (other phases depend on this) |

**Objective:** Configure proper feature flags with `xx_hash` as the only default feature.

**Deliverables:**
- Updated `biscuit-hash/Cargo.toml` with feature flags
- Dependencies marked as optional where appropriate
- `rand` dependency added for argon2

**Acceptance Criteria:**
- [ ] `cargo build -p biscuit-hash` compiles with only xxHash enabled
- [ ] `cargo build -p biscuit-hash --features blake3` compiles
- [ ] `cargo build -p biscuit-hash --features argon2id` compiles
- [ ] `cargo build -p biscuit-hash --all-features` compiles

---

### Phase 2: Update lib.rs with Conditional Compilation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No |

**Objective:** Configure conditional module compilation and re-exports.

**Deliverables:**
- Updated `src/lib.rs` with conditional compilation
- Module documentation
- Re-exports at crate root

**Acceptance Criteria:**
- [ ] `cargo doc -p biscuit-hash` generates correct documentation
- [ ] Re-exports work for each feature combination
- [ ] No compilation warnings

---

### Phase 3: Migrate HashVariant into xx.rs

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, xx-hash |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 2 |
| **Parallelizable** | Yes (with Phases 4, 5) |

**Objective:** Move `HashVariant` enum into `xx.rs`, fix imports and documentation.

**Deliverables:**
- Updated `src/xx.rs` with integrated `HashVariant`
- Deleted `src/hash_variant.rs`
- Fixed doc examples to use `biscuit_hash::`

**Acceptance Criteria:**
- [ ] `cargo test -p biscuit-hash --features xx_hash` passes
- [ ] `cargo test --doc -p biscuit-hash --features xx_hash` passes
- [ ] `src/hash_variant.rs` is deleted

---

### Phase 4: Fix blake.rs Documentation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, blake3 |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 2 |
| **Parallelizable** | Yes (with Phases 3, 5) |

**Objective:** Update documentation examples to use `biscuit_hash::` imports.

**Deliverables:**
- Updated `src/blake.rs` with correct import paths

**Acceptance Criteria:**
- [ ] `cargo test -p biscuit-hash --features blake3` passes
- [ ] `cargo test --doc -p biscuit-hash --features blake3` passes

---

### Phase 5: Fix argon.rs Documentation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, thiserror |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 2 |
| **Parallelizable** | Yes (with Phases 3, 4) |

**Objective:** Update documentation examples to use `biscuit_hash::` imports.

**Deliverables:**
- Updated `src/argon.rs` with correct import paths

**Acceptance Criteria:**
- [ ] `cargo test -p biscuit-hash --features argon2id` passes
- [ ] `cargo test --doc -p biscuit-hash --features argon2id` passes

---

### Phase 6: Final Validation

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, nextest |
| **Suggested Skills** | monorepos (workspace testing) |
| **Complexity** | Low |
| **Dependencies** | Phase 3, Phase 4, Phase 5 |
| **Parallelizable** | No |

**Objective:** Validate all functionality across feature combinations.

**Deliverables:**
- Test report for all feature combinations
- Clippy lint check

**Acceptance Criteria:**
- [ ] All feature combinations compile without errors
- [ ] All tests pass for each feature combination
- [ ] All doc tests pass
- [ ] `cargo clippy` reports no warnings
- [ ] Original `biscuit` package still compiles and tests pass


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing.

- [FILE: biscuit-hash/src/hash_variant.rs]: Missing `use std::collections::HashMap;` import for `ReplacementMap` variant
- [FILE: biscuit-hash/src/xx.rs]: References non-existent `crate::hashing::HashVariant` path - must be removed
- [FILE: biscuit-hash/Cargo.toml]: Missing `rand` dependency, xxhash-rust has unused `xxh32` feature
- [ARCHITECTURE]: biscuit-hash migration has minimal impact - hashing only used internally within biscuit
- [SKILL: thiserror]: When a feature-gated module uses thiserror derives, thiserror must be tied to that feature
- [CODEBASE: dockhand]: Edition 2024 is valid and consistently used (Rust 1.85+)
- [PARALLELIZATION]: Phases 3, 4, 5 can all run in parallel after Phase 2 completes

## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation.

- [MODIFY]: xxhash-rust - remove unused "xxh32" feature, keep only "xxh64"
- [ADD]: rand - make explicit dependency for argon2id feature (clarity over implicit transitive)
- [GATE]: thiserror - tie to argon2id feature flag, not independently optional

## Dependency Graph (Finalized)

```
Phase 1 ──► Phase 2 ──┬──► Phase 3 ──┐
                      ├──► Phase 4 ──┼──► Phase 6
                      └──► Phase 5 ──┘
```

Phases 3, 4, and 5 can all run in parallel after Phase 2 completes.

