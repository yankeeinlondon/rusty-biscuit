---
status: "implemented"
started_at: 15:47:00
finished_at: 2026-01-05
duration: ~1 day
requirements: |
  Add icon pack support to Mermaid rendering using BOTH approaches:

  1. **Terminal rendering**: Switch from mermaid.ink to local mmdc CLI with --iconPacks
  2. **HTML rendering**: Add CDN-based icon pack lazy-loading via mermaid.registerIconPacks()

  Target icon packs (hardcoded, not configurable):
  - @iconify-json/fa7-brands
  - @iconify-json/lucide
  - @iconify-json/carbon
  - @iconify-json/system-uicons

  npm dependencies: System global installation (no package.json in repo)
  - User responsible for: npm install -g @mermaid-js/mermaid-cli @iconify-json/fa7-brands @iconify-json/lucide @iconify-json/carbon @iconify-json/system-uicons

  Implementation scope:
  - shared/src/mermaid/render_terminal.rs: Replace mermaid.ink with mmdc CLI invocation
  - shared/src/mermaid/render_html.rs: Add CDN icon pack registration script
  - Documentation: Update mermaid-icons.md with usage examples

  Sources:
  - https://github.com/mermaid-js/mermaid-cli/pull/827
  - https://github.com/mermaid-js/mermaid-cli/issues/764
required_skills:
  - clap
important_skills:
  rig: When implementing LLM-based research/documentation of Mermaid iconsets
  color-eyre: When building CLI tool with rich error reporting
  thiserror: When creating custom error types for icon pack validation
  monorepos: When coordinating changes across dockhand workspace areas
subagents:
  rust-designer: Implementing icon pack integration into shared library mermaid module
  backend-typescript-developer: Setting up npm icon pack installations
  feature-tester-rust: Creating integration tests for icon pack support
monorepo_modules_impacted:
  - shared/src/mermaid/render_terminal.rs (PRIMARY - complete rewrite)
  - shared/src/mermaid/render_html.rs (icon pack registration)
  - shared/src/mermaid/mod.rs (API signature async→sync)
  - shared/src/markdown/output/html.rs (consumer)
  - shared/src/markdown/output/terminal.rs (consumer)
  - shared/tests/mermaid_integration.rs (test updates)
  - shared/docs/md/mermaid-icons.md (documentation)
completeness_changes:
  - name: error-type-coverage
    priority: high
    description: Phase 2 needs detailed error classification for mmdc subprocess failures
  - name: icon-pack-validation
    priority: high
    description: Both phases need fallback strategy if packs unavailable
  - name: temp-file-cleanup
    priority: high
    description: Phase 2 needs explicit cleanup for error/interrupt cases
  - name: mmdc-availability-detection
    priority: medium
    description: Specify when to check for mmdc availability (startup vs first render)
concurrency_changes:
  - name: pre-phase-audit
    priority: high
    description: Audit shared state before parallelizing Phases 1 & 2
  - name: theme-resolution-precompute
    priority: medium
    description: Pre-compute themes before starting parallel phases
  - name: async-deprecation-path
    priority: high
    description: Phase 3 should add deprecation path rather than hard break
detail_changes:
  - name: fix-mmdc-cli-syntax
    priority: high
    description: CRITICAL - --iconPacks requires full package names (@iconify-json/lucide), not shortened names
  - name: verify-async-context
    priority: high
    description: Determine if render_for_terminal() called from async (research CLI) or sync (md binary) contexts
  - name: test-mermaid-cli-version
    priority: medium
    description: Verify PR #827 is released in stable mermaid-cli
tts_gender: male
---
# Planning Process

- [x] Identified Skills
- [x] Identified Subagents
- [x] User asked clarifying questions (human in the loop)
- [x] Requirements have been updated based on user responses to clarifying questions
- [x] All requirements have been made into a Phased Plan
- [x] Module Assessment has been completed
- [x] Review
    - [x] Completeness Review
    - [x] Concurrency Review
    - [x] Details/Knowledge Based Review
- [x] Plan finalized based on review feedback
- [x] Summarized plan to user via STDOUT

## Plan

### Phase 1: HTML Icon Pack Registration (LOW complexity) ⚡ PARALLEL START

**Objective**: Add CDN-based icon pack lazy-loading via `mermaid.registerIconPacks()`

**Files**:

- `shared/src/markdown/output/html.rs` (line ~334-338)
- `shared/src/mermaid/render_html.rs`

**Deliverables**:

1. Modify `has_mermaid` block to insert `registerIconPacks()` before `initialize()`
2. Add 4 icon pack registrations with unpkg CDN URLs
3. Update tests to verify icon pack registration script

**Implementation**:

```javascript
mermaid.registerIconPacks([
  { name: 'fa7-brands', loader: () => fetch('https://unpkg.com/@iconify-json/fa7-brands@1/icons.json').then(r => r.json()) },
  { name: 'lucide', loader: () => fetch('https://unpkg.com/@iconify-json/lucide@1/icons.json').then(r => r.json()) },
  { name: 'carbon', loader: () => fetch('https://unpkg.com/@iconify-json/carbon@1/icons.json').then(r => r.json()) },
  { name: 'system-uicons', loader: () => fetch('https://unpkg.com/@iconify-json/system-uicons@1/icons.json').then(r => r.json()) }
]);
```

---

### Phase 2: Terminal mmdc CLI Integration (HIGH complexity) ⚡ PARALLEL START

**Objective**: Replace mermaid.ink service with local Mermaid Diagram Compiler (mmdc) CLI execution

**Files**:

- `shared/src/mermaid/render_terminal.rs` (COMPLETE REWRITE)

**Deliverables**:

1. Remove HTTP request to mermaid.ink, base64 encoding, URL construction
2. Add `Command::new("mmdc")` invocation with temp file I/O
3. Add `--iconPacks` flag with **FULL npm package names** (per PR #827)
4. Add error types with detailed classification
5. Implement graceful fallback with helpful error messages
6. Use `tempfile` crate for RAII cleanup (already a dependency)

**Error Type Design**:

```rust
pub enum MermaidRenderError {
    MmdcNotFound,           // exit code 127 or NotFound
    MmdcExecutionFailed {   // mmdc ran but returned non-zero
        exit_code: i32,
        stderr: String,
    },
    ContentTooLarge,        // input exceeds size limit
    RenderFailed(String),   // viuer display failure
    IoError(std::io::Error),
}
```

**Key Implementation** (CORRECTED SYNTAX):

```rust
pub fn render_for_terminal(instructions: &str) -> Result<(), MermaidRenderError> {
    // 1. Create temp input file with instructions
    let input = tempfile::Builder::new().suffix(".mmd").tempfile()?;
    let output_path = input.path().with_extension("png");

    // 2. Build mmdc command with CORRECT flag syntax:
    let status = Command::new("mmdc")
        .args(["-i", input.path().to_str().unwrap()])
        .args(["-o", output_path.to_str().unwrap()])
        .args(["--theme", "dark"])
        .args(["--iconPacks",
            "@iconify-json/fa7-brands",
            "@iconify-json/lucide",
            "@iconify-json/carbon",
            "@iconify-json/system-uicons"])
        .output()?;

    // 3. Handle errors
    if !status.status.success() {
        return Err(MermaidRenderError::MmdcExecutionFailed {
            exit_code: status.status.code().unwrap_or(-1),
            stderr: String::from_utf8_lossy(&status.stderr).to_string(),
        });
    }

    // 4. Display with viuer
    viuer::print_from_file(&output_path, &Default::default())?;

    // 5. Cleanup automatic via Drop (tempfile RAII)
    Ok(())
}
```

**Fallback Behavior**:

- If `mmdc` not found → Display helpful installation message
- If icon packs missing → mmdc may still render (icons become placeholders)
- If render fails → Fall back to code block display

---

### Phase 3: API Signature Migration (MEDIUM complexity)

**Depends on**: Phase 2

**Objective**: Update all call sites for async→sync API change

**Files**:

- `shared/src/mermaid/mod.rs` (line 346)
- `shared/src/markdown/output/terminal.rs`
- Any binary consumers (md, research-cli)

**Pre-requisite**: Verify async context usage

- `md` binary: Appears to be sync main() - OK for sync API
- `research-cli`: Uses tokio runtime - may need `spawn_blocking()` wrapper

**Deliverables**:

1. Change `pub async fn render_for_terminal()` to `pub fn`
2. Remove `.await` from all call sites
3. Update test attributes from `#[tokio::test]` to `#[test]`
4. Add migration note to module docs for external consumers

**Migration Strategy** (based on review feedback):

- Keep sync signature (subprocess blocking is acceptable for terminal rendering)
- If async context needs this, wrap in `tokio::task::spawn_blocking()`
- Document breaking change clearly

---

### Phase 4: Integration Tests (MEDIUM complexity)

**Depends on**: Phases 1, 2, 3

**Files**:

- `shared/tests/mermaid_integration.rs`
- `shared/tests/fixtures/mermaid/valid/with_icons.mmd` (NEW)

**Deliverables**:

1. Add `test_terminal_render_with_icons()`
2. Add `test_mmdc_not_installed_error()`
3. Add `test_html_has_icon_pack_registration()`
4. Update existing tests for sync API
5. Create fixture diagram using all 4 icon packs

---

### Phase 5: Documentation (LOW complexity)

**Depends on**: Phases 1, 2

**Files**:

- `shared/docs/md/mermaid-icons.md`

**Deliverables**:

1. Add "Installation" section with npm commands
2. Add "Terminal Usage" section with mmdc examples
3. Add "HTML Usage" section explaining lazy loading
4. Add "Troubleshooting" section for mmdc errors
5. Add complete diagram examples using icons

---

## Execution Strategy

```
┌──────────────────────────────────────────────────────────────┐
│ Time → │ Phase 1 (HTML)   │ Phase 2 (Terminal)               │
│        │ LOW complexity   │ HIGH complexity                  │
│        └──────────────────┴──────────────────────────────────│
│                           │ Phase 3 (API Migration)          │
│                           │ MEDIUM complexity                │
│                           └──────────────────────────────────│
│                                     │ Phase 4 (Tests)        │
│                                     │ Phase 5 (Docs)         │
└──────────────────────────────────────────────────────────────┘
```

**Critical Path**: Phase 2 → Phase 3 → Phase 4

**Parallel Opportunities**:

- Phases 1 & 2 can run in parallel (independent)
- Phases 4 & 5 can run in parallel after Phase 3

---

## Risk Assessment

| Phase | Risk Level | Key Risks | Mitigation |
|-------|------------|-----------|------------|
| 1 | LOW | CDN unavailable | Icons fail gracefully |
| 2 | HIGH | mmdc not installed, wrong version | Clear error messages, version docs |
| 3 | MEDIUM | Breaking API change | Migration docs, spawn_blocking wrapper |
| 4 | MEDIUM | Test isolation for subprocess | Use tempfile, mock mmdc |
| 5 | LOW | None | - |

---

## Prerequisites (User Action Required)

```bash
# Install mermaid-cli and icon packs globally
npm install -g @mermaid-js/mermaid-cli \
  @iconify-json/fa7-brands \
  @iconify-json/lucide \
  @iconify-json/carbon \
  @iconify-json/system-uicons

# Verify installation
mmdc --version  # Should be v10.9+ with icon pack support
```

---

## Summary

This plan adds **Iconify icon pack support** to both HTML and terminal Mermaid rendering:

1. **HTML** (Phase 1): CDN lazy-loading via `mermaid.registerIconPacks()` - zero dependencies
2. **Terminal** (Phase 2): Local `mmdc` CLI with `--iconPacks` flag - requires npm packages
3. **API** (Phase 3): Sync signature change for subprocess execution
4. **Testing** (Phase 4): New tests for icons and error paths
5. **Docs** (Phase 5): Installation and usage guide

**Total Complexity**: Medium-High (Phase 2 drives complexity)
**Estimated Files Changed**: 7
