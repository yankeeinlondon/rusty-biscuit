---
plan_file: .ai/plans/2026-01-05.plan-for-sniff-plus-enhancements.md
phases: 8
status: "done"
stop_reason: ""
started: 5 January 2026 at 00:00:00
completed: 5 January 2026
duration: ""
---
# Plan Execution

## Progress

- [x] Plan execution started [5 January 2026 at 00:00:00]
- [x] Snapshot Complete [5 January 2026]
    - [x] 1 lint error (fixed: `.filter_map(|name| name)` â†’ `.flatten()` in git.rs:279)
    - [x] 0 test errors (79 tests passing)
    - [x] Build check: PASS
    - [x] Git check: PASS (no dirty files in blast radius)
- [x] Parallel Group A completed [5 January 2026]
    - Phases 1, 2, 5 ran concurrently:
        - [x] Phase 1: EditorConfig Support (agent: general-purpose, skills: editorconfig, serde, thiserror)
            - Created formatting.rs with FormattingConfig and EditorConfigSection structs
            - Added ec4rs dependency
            - Integrated into FilesystemInfo
        - [x] Phase 2: Language Files Property (agent: general-purpose, skills: serde)
            - Extended LanguageStats with files: Vec<PathBuf>
            - Modified detect_languages() to collect relative file paths
            - Updated calculate_stats() to handle file lists
        - [x] Phase 5: GPU Detection (agent: general-purpose, skills: serde)
            - Created gpu.rs with GpuInfo and GpuDeviceType
            - Used metal crate for macOS GPU detection (hardware-query had upstream bugs)
            - Integrated into HardwareInfo
    - Build: PASS, Tests: 106 passing, Clippy: PASS
- [x] Parallel Group B completed [5 January 2026]
    - Phases 3, 4, 6 ran concurrently:
        - [x] Phase 3: Git Dirty/Untracked Details (agent: general-purpose, skills: thiserror, serde)
            - Created DirtyFile and UntrackedFile structs
            - Extended RepoStatus with dirty and untracked arrays
            - Added unified diff generation with accumulator pattern
            - Dynamic remote discovery via branch.upstream()
        - [x] Phase 4: Monorepo Package Info (agent: general-purpose, skills: serde)
            - Extended PackageLocation with primary_language, languages, detected_managers
            - Added detect_package_languages() and detect_package_managers() helpers
            - Detection scoped to package directories
        - [x] Phase 6: SIMD/AVX Detection (agent: general-purpose, skills: serde)
            - Created SimdCapabilities struct with x86_64 and aarch64 fields
            - Uses std::arch macros with cfg guards
            - Integrated into CpuInfo
    - Build: PASS, Tests: all passing, Clippy: PASS
- [x] Phase 7 completed [5 January 2026]
    - [x] CLI Include-Only Mode Flags (orchestrator implementation)
        - Added --hardware, --network, --filesystem include-only flags
        - Implemented include-only mode logic (skip flags ignored when include flags present)
        - Added AFTER_HELP documentation explaining behavior
        - Added 6 new CLI tests for include-only mode
- [x] Phase 8 completed [5 January 2026]
    - [x] Output formatting updated for new features
        - GPU info displayed at default verbosity
        - SIMD capabilities at -v level
        - EditorConfig at -vv level
        - Language file lists at -vv level
        - Dirty file paths at -v, diffs at -vv
        - Untracked files at -v
        - Monorepo package details (managers, languages) at -v/-vv
    - [x] All tests passing: 16 CLI tests, 100+ lib tests
    - [x] Clippy: PASS
    - [x] Release build: PASS
- [x] All Phases completed [5 January 2026]

## Final Test Summary

| Package | Unit Tests | Integration Tests | Doc Tests | Total |
|---------|-----------|-------------------|-----------|-------|
| sniff-lib | 77 | 9 | 25 | 111 |
| sniff-cli | 0 | 16 | 0 | 16 |
| **Total** | 77 | 25 | 25 | **127** |

## Lessons Learned

- [CRATE: hardware-query]: v0.2.1 has upstream compilation bug (missing `use std::process::Command` in npu.rs). Used metal crate directly for macOS GPU detection instead.
- [CRATE: git2]: Diff::print() is callback-based - requires accumulator pattern to collect diff output
- [CRATE: git2]: Use branch.upstream() for dynamic remote discovery instead of hardcoding "origin"
- [SKILL: sysinfo]: Does not provide CPU instruction set detection - must use std::arch macros instead

## Package Changes

- [ADD]: ec4rs = "1" - EditorConfig parsing
- [ADD]: metal = "0.30" (macOS only) - GPU detection via Metal API
- [REMOVE]: hardware-query optional dependency (had upstream bugs)
- [REMOVE]: gpu feature flag (GPU detection now always available on macOS)

## Files Created/Modified

### Created
- `sniff/lib/src/filesystem/formatting.rs` - EditorConfig parsing
- `sniff/lib/src/hardware/gpu.rs` - GPU detection via Metal

### Modified
- `sniff/lib/Cargo.toml` - Added ec4rs, metal dependencies
- `sniff/lib/src/filesystem/mod.rs` - Added formatting module, extended FilesystemInfo
- `sniff/lib/src/filesystem/languages.rs` - Added files field to LanguageStats
- `sniff/lib/src/filesystem/git.rs` - Added DirtyFile, UntrackedFile, extended RepoStatus
- `sniff/lib/src/filesystem/monorepo.rs` - Extended PackageLocation with language/manager info
- `sniff/lib/src/hardware/mod.rs` - Added gpu module, extended HardwareInfo with gpus
- `sniff/lib/src/hardware/cpu.rs` - Added SimdCapabilities struct and detect_simd()
- `sniff/cli/src/main.rs` - Added include-only mode flags
- `sniff/cli/src/output.rs` - Updated text output for new features with verbosity levels
- `sniff/cli/tests/cli.rs` - Added 6 new tests for include-only mode

