---
status: "done"
started_at: "16:55:16"
finished_at: "17:05:30"
duration: "10m 14s"
tts_gender: male
requirements: |
  Add WebSocket support to the schematic/define package using Option A (Parallel Type System).
  This creates new WebSocket primitives alongside existing REST types without modifying existing code.

  Key requirements from the prompt:
  - Create WebSocketApi, WebSocketEndpoint, ConnectionLifecycle, MessageSchema types
  - Support connection parameters, message direction, lifecycle management
  - Maintain backward compatibility with existing REST API definitions
  - Reuse existing AuthStrategy type
  - Focus on Phase 1 (Core Types) only - define types in schematic/define

  Files to create:
  - schematic/define/src/websocket.rs

  Files to modify:
  - schematic/define/src/lib.rs - add pub mod websocket;
  - schematic/define/src/prelude.rs - export WebSocket types

  Clarified requirements (from user):
  - Include comprehensive unit tests for all new WebSocket types
  - All types should derive Serialize/Deserialize (like existing REST types)
  - Use plain struct construction (no builder pattern needed)
required_skills: [rust, thiserror, serde, strum]
important_skills:
  monorepos: "If guidance needed on Cargo workspace structure or cross-package integration"
  rust-testing: "When implementing unit tests for the new WebSocket types"
subagents:
  Plan: "Create phased implementation plan"
  Explore: "Module assessment for monorepo impact"
  general-purpose: "Reviews (completeness, concurrency, correctness) and finalization"
  feature-tester-rust: "Validate test strategy for new types"
monorepo_modules_impacted:
  - schematic/define (4 files: websocket.rs new, schema.rs, lib.rs, prelude.rs modified)
  - schematic-gen (0 files - isolated, future Phase 2)
  - schematic-definitions (0 files - can use new types later)
  - schematic-schema (0 files - generated output unaffected)
completeness_changes:
  - HIGH: Schema type lacks Serialize/Deserialize - MessageSchema.schema field will fail compilation
  - MEDIUM: ParamType/MessageDirection enum serialization format unspecified
  - MEDIUM: Phase 3 missing from_str edge case tests
  - MEDIUM: Phase 3 should include AuthStrategy compatibility test
  - LOW: Missing Default trait implementations
  - LOW: Consider Hash/Copy derives for small enums
concurrency_changes:
  - HIGH: Phase 3 does NOT depend on Phase 2 - tests can start after Phase 1
  - HIGH: Phase 4 documentation can start during Phase 1 (doc comments inline)
  - MEDIUM: Restructure as parallel tracks after Phase 1
detail_changes:
  - HIGH: Schema type missing Serde derives - showstopper for MessageSchema
  - MEDIUM: Missing strum imports for Display/EnumString
  - MEDIUM: MessageDirection needs serde rename_all attribute
  - MEDIUM: Missing prelude.rs export details (all 7 types)
  - MEDIUM: File path should be explicit (schematic/define/src/websocket.rs)
lessons_learned_count: 6
---
# Planning Process

- [x] Prep Started [2026-01-16 16:55:16]
    - [x] Identified Skills [16:55:45] - rust, thiserror, serde, strum (required); monorepos, rust-testing (suggested)
    - [x] Identified Subagents [16:55:45] - Plan, Explore, general-purpose, feature-tester-rust
- [x] Prep complete [16:55:50]
- [x] Clarify (orchestrator) [16:56:00]
    - [x] User asked clarifying questions (human in the loop) [16:56:10]
    - [x] Requirements have been updated based on user responses [16:56:15]
- [x] Planning Subagent [agent: **Plan**] started [16:56:30]
    - [x] subagent skills used: rust, serde, strum, thiserror
    - [x] Planning completed [16:58:00]
- [x] Module Assessment Subagent [agent: **Explore**] started [16:56:30]
    - [x] subagent skills used: rust, monorepos, serde
    - [x] Module Assessment completed [16:58:05]
- [x] All Pre-review Steps are complete [16:58:10]
- [x] Review Started [16:58:30]
    - [x] Completeness Review [agent: **general-purpose**]
        - [x] subagent skills used: rust, serde, strum
    - [x] Concurrency Review [agent: **general-purpose**]
        - [x] subagent skills used: rust
    - [x] Details/Knowledge Based Review [agent: **general-purpose**]
        - [x] subagent skills used: rust, strum
- [x] Reviews Completed [17:00:15]
- [x] Plan Finalization [agent: **general-purpose**] started [17:02:00]
    - [x] subagent skills used: rust, serde, strum, thiserror, monorepos
- [x] Plan finalized [17:05:00]
    - 35% of context window is still available
- Final Steps
    - [x] Lessons learned collected from all subagents
    - [x] No packages require research (existing deps sufficient)
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-16.plan-for-websocket-support-schematic.md
    - Started: 16:55:16
    - Completed: 17:05:30
    - Duration: 10m 14s



## Plan

### Phase 0: Schema Serde Prerequisite

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, serde |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | No (blocker for Phase 1) |

**Objective:** Add missing `Serialize` and `Deserialize` derives to the existing `Schema` type.

**Deliverables:**

- Modify `/Volumes/coding/personal/dockhand/schematic/define/src/schema.rs`:
    - Add `Serialize, Deserialize` derives to `Schema` struct
    - Add `use serde::{Deserialize, Serialize};` if not already present

**Acceptance Criteria:**

- [ ] `Schema` derives `Debug, Clone, PartialEq, Eq, Serialize, Deserialize`
- [ ] `cargo check -p schematic-define` passes
- [ ] Existing tests continue to pass

---

### Phase 1: Core WebSocket Types

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, serde, strum, thiserror |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 0 |
| **Parallelizable** | No (foundational) |

**Objective:** Create the complete `websocket.rs` module with all WebSocket type definitions following existing patterns.

**Deliverables:**

- New file: `/Volumes/coding/personal/dockhand/schematic/define/src/websocket.rs` containing:

  **Imports:**

  ```rust
  use serde::{Deserialize, Serialize};
  use strum::{Display, EnumIter, EnumString};

  use crate::auth::AuthStrategy;
  use crate::schema::Schema;
  ```

  **Types:**
    - `WebSocketApi` struct - Complete WebSocket API definition
    - `WebSocketEndpoint` struct - Single WebSocket endpoint
    - `ConnectionParam` struct - Query/path parameters for connection
    - `ParamType` enum - Parameter types (`String`, `Integer`, `Boolean`, `Float`)
        - Derives: `Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize, Display, EnumIter, EnumString`
        - Attributes: `#[serde(rename_all = "lowercase")]`, `#[strum(serialize_all = "lowercase")]`
    - `ConnectionLifecycle` struct - Open/close/keepalive message schemas
    - `MessageSchema` struct - Single message type with direction and schema
    - `MessageDirection` enum - Direction (`Client`, `Server`, `Bidirectional`)
        - Derives: `Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize, Display, EnumIter, EnumString`
        - Attributes: `#[serde(rename_all = "lowercase")]`, `#[strum(serialize_all = "lowercase")]`

  **Default Implementations:**
    - `Default` for `ConnectionLifecycle` (all fields `None`)
    - `Default` for `WebSocketEndpoint` (sensible empty defaults)

- Module-level documentation with overview and ElevenLabs TTS WebSocket example

**Acceptance Criteria:**

- [ ] All struct types derive `Debug, Clone, PartialEq, Eq, Serialize, Deserialize`
- [ ] `ParamType` and `MessageDirection` enums include: `Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize, Display, EnumIter, EnumString`
- [ ] Enums have `#[serde(rename_all = "lowercase")]` and `#[strum(serialize_all = "lowercase")]` attributes
- [ ] `AuthStrategy` is imported and reused from `crate::auth`
- [ ] `Schema` is imported and reused from `crate::schema`
- [ ] Module documentation includes ElevenLabs-style example
- [ ] `Default` implemented for `ConnectionLifecycle` and `WebSocketEndpoint`
- [ ] Code compiles with `cargo check -p schematic-define`

---

### Phase 2: Module Integration

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | monorepos (workspace context) |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (parallel with Phase 3 and Phase 4 after Phase 1) |

**Objective:** Integrate the new websocket module into the crate's public API.

**Deliverables:**

- Modify `/Volumes/coding/personal/dockhand/schematic/define/src/lib.rs`:
    - Add `pub mod websocket;` declaration after existing modules
    - Add re-exports at crate root:

    ```rust
    pub use websocket::{
        ConnectionLifecycle, ConnectionParam, MessageDirection,
        MessageSchema, ParamType, WebSocketApi, WebSocketEndpoint,
    };
    ```
    - Update module-level documentation to include WebSocket types in Core Types list

- Modify `/Volumes/coding/personal/dockhand/schematic/define/src/prelude.rs`:
    - Export all 7 WebSocket types:

    ```rust
    pub use crate::websocket::{
        ConnectionLifecycle, ConnectionParam, MessageDirection,
        MessageSchema, ParamType, WebSocketApi, WebSocketEndpoint,
    };
    ```
    - Update module documentation example to show WebSocket usage

**Acceptance Criteria:**

- [ ] `pub mod websocket;` added to `lib.rs`
- [ ] All 7 types re-exported at crate root
- [ ] All 7 types exported from prelude
- [ ] Types accessible via `schematic_define::WebSocketApi`, etc.
- [ ] Types accessible via `schematic_define::prelude::*`
- [ ] `cargo doc -p schematic-define --open` shows WebSocket types in documentation

---

### Phase 3: Unit Tests

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, serde |
| **Suggested Skills** | rust-testing |
| **Complexity** | Medium |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (parallel with Phase 2 and Phase 4 after Phase 1) |

**Objective:** Create comprehensive unit tests following existing test patterns in `types.rs` and `auth.rs`.

**Deliverables:**

- Add `#[cfg(test)] mod tests` section to `websocket.rs` containing:

  **Serde Roundtrip Tests:**
    - `websocket_api_serde_roundtrip` - Full `WebSocketApi` serialization/deserialization
    - `websocket_endpoint_serde_roundtrip`
    - `connection_param_serde_roundtrip`
    - `connection_lifecycle_serde_roundtrip`
    - `message_schema_serde_roundtrip`

  **Enum String Conversion Tests:**
    - `param_type_display_lowercase` - Verify `to_string()` returns lowercase
    - `param_type_from_str_lowercase` - Verify `from_str()` parses lowercase
    - `param_type_from_str_invalid` - Verify `from_str()` returns `Err` for invalid input
    - `param_type_from_str_empty` - Verify `from_str("")` returns `Err`
    - `param_type_iter_all_variants` - Verify `EnumIter` covers all variants
    - `message_direction_display_lowercase`
    - `message_direction_from_str_lowercase`
    - `message_direction_from_str_invalid`
    - `message_direction_from_str_empty`
    - `message_direction_iter_all_variants`

  **Trait Tests:**
    - `param_type_copy` - Verify `Copy` trait
    - `message_direction_copy` - Verify `Copy` trait
    - `connection_lifecycle_default` - Verify `Default` implementation
    - `websocket_endpoint_default` - Verify `Default` implementation

  **AuthStrategy Compatibility Test:**
    - `websocket_api_with_auth_strategy` - Verify `WebSocketApi` works with all `AuthStrategy` variants from `crate::auth`

  **Integration Test:**
    - `elevenlabs_tts_websocket_example` - Construct full `WebSocketApi` matching ElevenLabs TTS WebSocket API structure

**Acceptance Criteria:**

- [ ] All tests pass with `cargo test -p schematic-define`
- [ ] Test coverage for every public type
- [ ] Serde roundtrip tests verify JSON format stability
- [ ] Enum tests verify lowercase serialization
- [ ] Edge case tests for invalid/empty `from_str` input
- [ ] At least one comprehensive integration test constructs full WebSocketApi
- [ ] AuthStrategy compatibility verified

---

### Phase 4: Documentation and Examples

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (parallel with Phase 2 and Phase 3 after Phase 1) |

**Objective:** Ensure comprehensive documentation and update README.

**Deliverables:**

- Enhance doc comments in `websocket.rs` (inline during Phase 1, refined here):
    - All public items have doc comments with `## Examples` section
    - Examples demonstrate common usage patterns
    - Cross-references to related types (e.g., `AuthStrategy`, `Schema`)

- Update `/Volumes/coding/personal/dockhand/schematic/define/README.md`:
    - Add WebSocket section after "Response Types" section
    - Add WebSocket types to Core Types table:

    | Type | Purpose |
    |------|---------|
    | `WebSocketApi` | Complete WebSocket API definition with base URL, auth, and endpoints |
    | `WebSocketEndpoint` | Single WebSocket endpoint with path, parameters, and message schemas |
    | `ConnectionParam` | Query/path parameter definition for WebSocket connections |
    | `ParamType` | Parameter types (String, Integer, Boolean, Float) |
    | `ConnectionLifecycle` | Open, close, and keepalive message schemas |
    | `MessageSchema` | Single message type with direction (Client, Server, Bidirectional) |
    | `MessageDirection` | Message flow direction enumeration |
    - Add WebSocket example showing ElevenLabs TTS definition

**Acceptance Criteria:**

- [ ] `cargo doc -p schematic-define` shows no documentation warnings
- [ ] All public items have doc comments
- [ ] README.md includes WebSocket documentation section
- [ ] README.md Core Types table updated with all 7 WebSocket types
- [ ] Doc examples compile (`cargo test --doc -p schematic-define`)

---

## Execution Graph

```
Phase 0 (Schema Serde)
         │
         ▼
     Phase 1 (Core Types)
         │
    ┌────┼────┐
    ▼    ▼    ▼
Phase 2  Phase 3  Phase 4
(Integration) (Tests) (Docs)
    │    │    │
    └────┴────┘
         │
         ▼
       Done
```

**Parallelization Notes:**

- Phase 0 is a quick prerequisite (adds 2 derives to existing type)
- Phases 2, 3, and 4 can all run in parallel after Phase 1 completes
- Total critical path: Phase 0 -> Phase 1 -> (any of 2/3/4)

---

## File Change Summary

| File | Action | Description |
|------|--------|-------------|
| `schematic/define/src/schema.rs` | Modify | Add `Serialize, Deserialize` derives to `Schema` |
| `schematic/define/src/websocket.rs` | Create | All WebSocket type definitions |
| `schematic/define/src/lib.rs` | Modify | Add `pub mod websocket;` and re-exports |
| `schematic/define/src/prelude.rs` | Modify | Export WebSocket types |
| `schematic/define/README.md` | Modify | Add WebSocket documentation |

No changes required to: auth.rs, types.rs, response.rs, Cargo.toml


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [PATTERN: schematic-define]: All types derive at minimum `Debug, Clone, PartialEq, Eq`; enums also get `Serialize, Deserialize` with strum derives
- [PATTERN: schematic-define]: Tests use inline `#[cfg(test)] mod tests` with serde roundtrip verification
- [ARCHITECTURE: codegen isolation]: Generator only processes RestApi/Endpoint types; new WebSocket types won't be auto-discovered
- [TYPE_REUSE: auth and schema]: AuthStrategy and Schema can be safely shared between REST and WebSocket without modification
- [CRATE: schematic-define]: `Schema` type lacks Serialize/Deserialize derives, blocking any type that embeds Schema from being serializable. This is a design gap that needs addressing.
- [PATTERN: strum enums]: When using strum for string conversion, always pair `#[serde(rename_all = "...")]` with `#[strum(serialize_all = "...")]` to ensure consistent behavior between serde and strum conversions.


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- [NONE]: No new dependencies required - serde, strum, and thiserror already present in schematic-define/Cargo.toml
