---
status: "done"
started_at: "12:45:00"
finished_at: "12:51:00"
duration: "6 minutes"
tts_gender: male
requirements: |
  Implement improvements from tree-sitter linting code review (.ai/code-review/2026-01-21.tree-sitter-linting.md):

  **Tree-sitter usage and correctness:**
  - Use tree-sitter comment captures for ignore directives instead of line-based string scanning
  - Add fast path for syntax diagnostics by returning early when root.has_error() is false
  - Improve syntax error messaging with expected node kinds and SourceContext
  - Tighten dead-code detection to recognize common terminal patterns: panic!, unreachable!, todo!, unimplemented!, process::exit, std::process::abort
  - Validate qualifiers in qualified references, report undefined modules as WARNINGS (not errors)

  **Performance and reuse:**
  - Consolidate SourceContext creation into a single helper operating from CodeRange
  - Skip Query::new for empty/comment-only lint files and cache no-op path

  **Diagnostics model:**
  - Add new unified diagnostics() method returning combined results with kind field (Lint | Syntax)
  - Keep existing lint_diagnostics() and syntax_diagnostics() as convenience wrappers
  - Add CLI filters --lint-only and --syntax-only

  **Test coverage (already implemented):**
  - Semantic lint tests added
  - Syntax diagnostics regression tests added

  **Clarified decisions:**
  - API: New unified method + keep existing (non-breaking)
  - Qualified refs: Report as warnings (dynamic resolution possible)
  - Terminal calls: Common Rust patterns hardcoded
required_skills: [tree-sitter, rust, clap, thiserror]
important_skills:
  rust-testing: "when adding test coverage for improved diagnostics"
  color-eyre: "if improving error reporting in CLI for diagnostic display"
subagents:
  Plan: "Create phased implementation plan"
  Explore: "Module assessment for monorepo impact"
  general-purpose: "Reviews (completeness, concurrency, correctness) and finalization"
  feature-tester-rust: "Test implementation validation"
monorepo_modules_impacted:
  - tree-hugger/lib/src/file/tree_file.rs (core changes)
  - tree-hugger/lib/src/dead_code.rs (terminal detection)
  - tree-hugger/lib/src/ignore_directives.rs (comment captures)
  - tree-hugger/lib/src/shared/symbol.rs (diagnostic structs)
  - tree-hugger/lib/src/queries/mod.rs (empty query caching)
  - tree-hugger/cli/src/main.rs (CLI filters)
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 0
---
# Planning Process

- [x] Prep Started [12:45pm]
    - [x] Identified Skills [12:45pm] - tree-sitter, rust, clap, thiserror (required); rust-testing, color-eyre (suggested)
    - [x] Identified Subagents [12:46pm] - Plan, Explore, general-purpose, feature-tester-rust
- [x] Prep complete [12:46pm]
- [x] Clarify (orchestrator) [12:47pm]
    - [x] User asked clarifying questions (human in the loop) [12:47pm]
        - API design: New unified method (non-breaking)
        - Qualified ref severity: Warnings
        - Terminal calls: Common Rust patterns
    - [x] Requirements updated based on user responses [12:47pm]
- [x] Planning Subagent [agent: **Plan**] started [12:47pm]
    - [x] subagent skills used: tree-sitter, rust, clap, thiserror
    - [x] Planning completed [12:48pm] - 10 phases identified
- [x] Module Assessment Subagent [agent: **Explore**] started [12:47pm]
    - [x] subagent skills used: rust
    - [x] Module Assessment completed [12:48pm] - 6 modules impacted, no external deps
- [x] All Pre-review Steps complete [12:48pm]
- [x] Review Started [12:48pm]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: tree-sitter, rust
       - Found: 10 recommendations (2 HIGH, 6 MEDIUM, 2 LOW)
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust
       - Found: Phase 4 can split 8 ways; Phase 8 can decouple from Phase 3
   - [x] Correctness Review [agent: **general-purpose**]
       - [x] subagent skills used: tree-sitter, rust, clap
       - Found: 12 technical issues (4 errors, 4 warnings, 4 info)
- [x] Reviews Completed [12:49pm]
- [x] Plan Finalization [agent: **general-purpose**] started [12:49pm]
    - [x] subagent skills used: tree-sitter, rust, clap, thiserror
- [x] Plan finalized [12:50pm]
- Final Steps
    - [x] Lessons learned collected from all subagents (7 items)
    - [x] No packages require research (all deps exist)
- [x] Summarized plan to user via STDOUT
    - Project File: .ai/plans/2026-01-21.plan-for-tree-hugger-linting-improvements.md
    - Started: 12:45pm
    - Completed: 12:51pm
    - Duration: 6 minutes



## Plan

### Executive Summary

This plan implements 10 phases of improvements to tree-hugger linting, addressing tree-sitter correctness, performance, diagnostics model, and test coverage from the code review.

**Key optimizations from reviews:**
- Phase 8 decoupled from Phase 3 (critical path reduced from 5→4 sequential phases)
- Phase 4 now depends on Phase 6 for safe UTF-8 extraction patterns
- Incremental testing allows unit tests to run after each phase completes

---

### Phase 1: Tree-Sitter Comment Captures for Ignore Directives

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | tree-sitter, rust |
| **Suggested Skills** | rust-testing (for validating comment capture behavior) |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phases 2, 5, 6, 7) |

**Objective:** Replace line-based string scanning with tree-sitter comment captures to avoid false positives (e.g., `//` inside strings).

**Deliverables:**
- Language-specific comment query files in `queries/{language}/comments.scm`
- Updated `IgnoreDirectives::parse_with_tree()` using comment node positions
- Support for block comments (`/* */`, `(* *)`, etc.)

**Query patterns by language:**
- Rust/Go/Java/C/C++/Swift/Scala/JS/TS: `[(line_comment) (block_comment)] @comment`
- Python/Bash/Zsh/Perl: `(comment) @comment`
- Lua: `[(comment) (block_comment)] @comment`
- PHP: `[(comment) (encapsed_string)] @comment`

**Files to Modify:**
- `tree-hugger/lib/src/ignore_directives.rs`
- `tree-hugger/lib/src/file/tree_file.rs:905-920`
- New: `tree-hugger/lib/queries/{language}/comments.scm` (16 files)

**Acceptance Criteria:**
- [ ] `// tree-hugger-ignore` inside a string literal is NOT treated as a directive
- [ ] Block comments are recognized
- [ ] Existing ignore directive tests pass

---

### Phase 2: Fast Path for Syntax Diagnostics

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | tree-sitter, rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phases 1, 5, 6, 7) |

**Objective:** Add early return when `root.has_error()` is false to avoid unnecessary tree traversal.

**Implementation:**
```rust
pub fn syntax_diagnostics(&self) -> Vec<SyntaxDiagnostic> {
    if !self.tree.root_node().has_error() {
        return Vec::new();
    }
    // ... existing traversal logic
}
```

**Files to Modify:**
- `tree-hugger/lib/src/file/tree_file.rs:1324-1351`

**Acceptance Criteria:**
- [ ] Valid files return empty vec without tree traversal
- [ ] Files with syntax errors still report all diagnostics

---

### Phase 3: Improved Syntax Error Messaging with SourceContext

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | tree-sitter, rust, thiserror |
| **Suggested Skills** | rust-testing (for regression tests) |
| **Complexity** | Medium |
| **Dependencies** | Phase 6 |
| **Parallelizable** | No |

**Objective:** Enhance `SyntaxDiagnostic` with expected node kinds and `SourceContext`.

**Deliverables:**
- Add `context: Option<SourceContext>` field to `SyntaxDiagnostic`
- Include expected grammar rule in messages for MISSING nodes
- Use `#[serde(skip_serializing_if = "Option::is_none")]` for backward compatibility

**Files to Modify:**
- `tree-hugger/lib/src/shared/symbol.rs:595-601`
- `tree-hugger/lib/src/file/tree_file.rs:1324-1351`

**Acceptance Criteria:**
- [ ] `SyntaxDiagnostic` includes `SourceContext` with line text and underline
- [ ] Missing node messages include expected node kind
- [ ] JSON output unchanged for fields that are None

---

### Phase 4: Tightened Dead-Code Detection

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | tree-sitter, rust |
| **Suggested Skills** | rust-testing (for cross-language validation) |
| **Complexity** | High |
| **Dependencies** | Phase 6 (for safe UTF-8 extraction pattern) |
| **Parallelizable** | No |

**Objective:** Match specific terminal patterns via node text to reduce false positives.

**Deliverables:**
- Add `source: &str` parameter to `is_terminal_statement()` and helpers
- Rust terminals: `panic!`, `unreachable!`, `todo!`, `unimplemented!`, `process::exit`, `std::process::abort`
- Safe UTF-8 extraction with `if let Ok(text)` pattern

**Implementation:**
```rust
fn is_rust_panic_macro(node: Node, source: &str) -> bool {
    if node.kind() != "macro_invocation" {
        return false;
    }
    if let Some(macro_node) = node.child_by_field_name("macro") {
        if let Ok(text) = macro_node.utf8_text(source.as_bytes()) {
            return RUST_TERMINAL_MACROS.contains(&text);
        }
    }
    false
}
```

**Files to Modify:**
- `tree-hugger/lib/src/dead_code.rs`
- `tree-hugger/lib/src/file/tree_file.rs:1032-1088`

**Acceptance Criteria:**
- [ ] `panic!("message")` detected as terminal
- [ ] Generic macro invocations NOT falsely detected as terminal

---

### Phase 5: Qualified Reference Validation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | tree-sitter, rust |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phases 1, 2, 6, 7) |

**Objective:** Report undefined modules as warnings for qualified references.

**Deliverables:**
- New `check_qualified_references()` method
- Rule ID: `undefined-module`, Severity: `Warning`
- Skip: `self`, `this`, `super`, `Self`, single-letter qualifiers

**Files to Modify:**
- `tree-hugger/lib/src/file/tree_file.rs:1090-1169`
- `tree-hugger/lib/src/queries/mod.rs:238-254`

**Acceptance Criteria:**
- [ ] `unknown_module::function()` reports warning
- [ ] `self.method()` does NOT report warning
- [ ] Severity is Warning, not Error

---

### Phase 6: Consolidated SourceContext Helper

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phases 1, 2, 5, 7) |

**Objective:** Consolidate SourceContext creation into a single helper from `CodeRange`.

**Deliverables:**
- New `build_source_context_from_range(&self, range: &CodeRange) -> SourceContext`
- Refactor existing `build_source_context(Node)` to delegate to new helper
- Remove 5+ duplicate implementations

**Files to Modify:**
- `tree-hugger/lib/src/file/tree_file.rs`

**Acceptance Criteria:**
- [ ] All SourceContext creations use the consolidated helper
- [ ] No duplicate line extraction logic remains

---

### Phase 7: Skip Query::new for Empty Lint Files

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | tree-sitter, rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phases 1, 2, 5, 6) |

**Objective:** Skip query compilation for empty/comment-only lint files.

**Deliverables:**
- Add `is_query_empty()` helper in `resolve_query_text()`
- Return early with empty string for no-op languages

**Files to Modify:**
- `tree-hugger/lib/src/queries/mod.rs:79-104`

**Acceptance Criteria:**
- [ ] Empty lint.scm files don't trigger Query::new errors
- [ ] Comment-only lint.scm files treated as empty

---

### Phase 8: Unified Diagnostics API

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, thiserror |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | None (decoupled from Phase 3) |
| **Parallelizable** | Yes (can start after Group A) |

**Objective:** Add unified `diagnostics()` method combining lint and syntax results.

**Deliverables:**
- `DiagnosticKind` enum: `Lint`, `Semantic`, `Syntax`
- New `Diagnostic` struct with `kind`, `message`, `range`, `severity`, `rule`, `context`
- New `TreeFile::diagnostics()` method
- Existing methods remain as convenience wrappers

**Files to Modify:**
- `tree-hugger/lib/src/shared/symbol.rs`
- `tree-hugger/lib/src/file/tree_file.rs`
- `tree-hugger/lib/src/lib.rs` (exports)

**Acceptance Criteria:**
- [ ] `diagnostics()` returns combined results with `kind` field
- [ ] Existing `lint_diagnostics()` and `syntax_diagnostics()` still work
- [ ] No breaking changes to existing API

---

### Phase 9: CLI Diagnostic Filters

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | clap, rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 8 |
| **Parallelizable** | No |

**Objective:** Add `--lint-only` and `--syntax-only` CLI filters.

**Deliverables:**
- New `LintArgs` struct (separate from `CommonArgs`)
- `--lint-only` and `--syntax-only` flags with `conflicts_with`
- Update `Command::inputs()` to handle `LintArgs`

**Files to Modify:**
- `tree-hugger/cli/src/main.rs`

**Acceptance Criteria:**
- [ ] `hug lint --lint-only` shows only lint diagnostics
- [ ] `hug lint --syntax-only` shows only syntax diagnostics
- [ ] Flags are mutually exclusive

---

### Phase 10: Test Coverage

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, rust-testing |
| **Suggested Skills** | tree-sitter (for comment capture tests) |
| **Complexity** | Medium |
| **Dependencies** | Incremental (after each implementation phase) |
| **Parallelizable** | Incremental |

**Objective:** Comprehensive test coverage for all new features.

**Test Scenarios:**
1. Comment capture: directive in string literal (ignored), block comment directive
2. Fast path: valid file returns empty without traversal
3. Syntax context: missing node with expected kind, underline positioning
4. Dead-code: each terminal pattern, non-terminal macros excluded
5. Qualified refs: unknown module warning, self/this excluded
6. Unified API: both types in combined output, filtering by kind
7. CLI filters: --lint-only, --syntax-only isolation

**Files to Create/Modify:**
- `tree-hugger/lib/tests/ignore_directives.rs` (new)
- `tree-hugger/lib/tests/tree_file.rs`
- `tree-hugger/lib/tests/lint_diagnostics.rs`
- `tree-hugger/lib/tests/dead_code.rs` (new)

**Acceptance Criteria:**
- [ ] All new features have at least 2 test cases
- [ ] `cargo test -p tree-hugger-lib` passes
- [ ] No regressions in existing tests

---

### Dependency Graph

```
Group A (parallel): Phases 1, 2, 5, 6, 7
                         │
                         ▼
              ┌──────────┴──────────┐
              │                     │
         Phase 4              Phase 3
     (depends on 6)       (depends on 6)
              │                     │
              └──────────┬──────────┘
                         │
                    Phase 8
              (decoupled, parallel OK)
                         │
                         ▼
                    Phase 9
                         │
                         ▼
                    Phase 10
              (incremental throughout)
```

**Parallel Execution Groups:**
- **Group A**: Phases 1, 2, 5, 6, 7 (all independent)
- **Group B**: Phases 3, 4 (both depend on Phase 6, can run parallel with each other)
- **Group C**: Phase 8 (decoupled, can start after Group A)
- **Sequential**: Phase 9 → Phase 10

**Critical Path**: 6 → 4 → 8 → 9 (4 sequential phases)

---

### Rejected Recommendations

| Recommendation | Rationale |
|----------------|-----------|
| Split Phase 4 into 8 language-specific sub-phases | Complexity overhead exceeds parallelism benefit; single phase with per-language helpers is cleaner |
| Precomputed line index for SourceContext | Premature optimization; current `lines().nth()` is sufficient for typical file sizes |


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [CODE: dead_code.rs]: Terminal pattern detection functions contain placeholder implementations with TODO comments indicating source text access is needed but not passed
- [CODE: ignore_directives.rs]: Line-based comment extraction handles 5+ comment styles - tree-sitter query approach needs language-specific comment queries
- [CODE: tree_file.rs]: SourceContext construction is duplicated in 4+ locations (~60 lines redundant code)
- [API: symbol.rs]: SyntaxDiagnostic lacks SourceContext field unlike LintDiagnostic, creating API asymmetry
- [SKILL: tree-sitter]: Node methods like `has_error()` and `utf8_text()` require careful error handling - always use `if let Ok()` for UTF-8 extraction
- [SKILL: clap]: When adding command-specific flags, use dedicated Args structs rather than modifying shared CommonArgs
- [ARCHITECTURE: tree_file.rs]: File is 1500+ lines - consider splitting lint_diagnostics() into separate modules for pattern-based vs semantic diagnostics


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- None required - all functionality uses existing dependencies (tree-sitter, serde, clap, thiserror)

