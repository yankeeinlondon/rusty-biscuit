---
status: "done"
started_at: 12:15:00
finished_at: 12:22:00
duration: "7 minutes"
tts_gender: male
requirements: |
  ## Refined Requirements (after clarification)

  ### Keep
  - `xx_hash()` - base string hash function
  - `xx_hash_bytes()` - base byte array hash function

  ### Remove (migrate callers to xx_hash_variant)
  - `xx_hash_trimmed` → `xx_hash_variant(data, vec![HashVariant::BlockTrimming])`
  - `xx_hash_normalized` → `xx_hash_variant(data, vec![HashVariant::BlankLine])`
  - `xx_hash_semantic` → `xx_hash_variant(data, vec![BlockTrimming, BlankLine, LeadingWhitespace, TrailingWhitespace, InteriorWhitespace])`
  - `xx_hash_content_only` - DELETE (0 usages)
  - `xx_hash_alphanumeric` - DELETE (0 production usages after delta fix)

  ### Delta Module Correction
  - DELETE the `xx_hash_alphanumeric` comparison entirely (was never valid)

  ### Callers to Migrate
  - `shared/src/mermaid/mod.rs:158` - xx_hash_normalized (1 usage)
  - `shared/src/markdown/toc/types.rs` - xx_hash_trimmed (4), xx_hash_semantic (1)
  - `shared/src/markdown/toc/mod.rs` - xx_hash_trimmed (3)
  - `shared/src/markdown/delta/mod.rs` - DELETE xx_hash_alphanumeric usage

  ### No New Variants Needed
  - Existing HashVariant enum is sufficient
required_skills: [rust, thiserror, dockhand-library]
important_skills:
  rust-testing: "when adding/updating unit tests"
  nextest: "when running test suite"
subagents: {}
monorepo_modules_impacted: []
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 0
---
# Planning Process

- [x] Prep Started [12:15pm]
    - [x] Identified Skills [12:16pm] - rust, thiserror, dockhand-library
    - [x] Identified Subagents [12:16pm] - Plan, Explore, feature-tester-rust, general-purpose
- [x] Prep complete [12:17pm]
- [x] Clarify (orchestrator) [12:17pm]
    - [x] User asked clarifying questions (human in the loop)
    - [x] Requirements have been updated based on user responses [12:18pm]
- [x] Planning Subagent started [12:18pm]
    - [x] subagent skills used: rust, dockhand-library
    - [x] Planning completed [12:19pm]
- [x] Module Assessment - Not needed (single module refactoring)
- [x] All Pre-review Steps complete
- [x] Review Started [12:20pm]
   - [x] Completeness Review - 14 recommendations (4 high priority)
       - [x] subagent skills used: rust, dockhand-library
   - [x] Concurrency Review - 10 recommendations (3 high priority)
       - [x] subagent skills used: rust, dockhand-library
   - [x] Correctness Review - 5 recommendations (3 high priority, 1 CRITICAL)
        - [x] subagent skills used: rust, dockhand-library
- [x] Reviews Completed [12:21pm]
- [x] Plan Finalization started [12:21pm]
    - [x] subagent skills used: rust, dockhand-library
- [x] Plan finalized [12:22pm]
- Final Steps
    - [x] Lessons learned collected from all subagents (4 items)
    - [x] No package research needed (no new dependencies)
- [x] Summarized plan to user via STDOUT
    - Project File: `.ai/plans/2026-01-08.consolidate-xx-hash-variants.md`
    - Started: 12:15pm
    - Completed: 12:22pm
    - Duration: ~7 minutes


## Plan

### Phase 1: Implement xx_hash_variant Core

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, dockhand-library |
| **Suggested Skills** | N/A |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | No (foundation for all other phases) |

**Objective:** Implement the `xx_hash_variant` function that applies a sequence of `HashVariant` transformations to input data before hashing.

**Deliverables:**
- Fully implemented `xx_hash_variant` function in `shared/src/hashing/xx_hash.rs`
- Handle all variant types: BlockTrimming, BlankLine, LeadingWhitespace, TrailingWhitespace, InteriorWhitespace, ReplacementMap, DropChars

**Variant Application Order** (fixed, regardless of input order):
1. BlockTrimming (entire block first)
2. BlankLine (remove empty lines)
3. LeadingWhitespace (per line)
4. TrailingWhitespace (per line)
5. InteriorWhitespace (per line, after other whitespace ops)
6. ReplacementMap (text substitution)
7. DropChars (character removal)

**Acceptance Criteria:**
- [ ] `xx_hash_variant(data, vec![BlockTrimming])` == `xx_hash_trimmed(data)`
- [ ] `xx_hash_variant(data, vec![BlankLine])` == `xx_hash_normalized(data)`
- [ ] Semantic variant combination matches `xx_hash_semantic(data)`
- [ ] Empty variant vec returns same as `xx_hash(data)`

---

### Phase 2: Add Comprehensive Unit Tests

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, rust-testing |
| **Suggested Skills** | nextest |
| **Complexity** | Medium |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No |

**Objective:** Add thorough unit tests for `xx_hash_variant` validating each variant and backward compatibility.

**Deliverables:**
- Tests for each individual `HashVariant`
- Tests for variant combinations
- **Backward compatibility tests** proving equivalence:
  - `xx_hash_variant(d, vec![BlockTrimming])` == `xx_hash_trimmed(d)`
  - `xx_hash_variant(d, vec![BlankLine])` == `xx_hash_normalized(d)`
  - `xx_hash_variant(d, vec![LeadingWhitespace, TrailingWhitespace, BlankLine])` == `xx_hash_semantic(d)`

**Acceptance Criteria:**
- [ ] All tests pass with `cargo test -p shared --lib xx_hash`
- [ ] Coverage includes each `HashVariant` variant
- [ ] Edge cases (empty input, empty variants) covered
- [ ] Backward compatibility tests pass for all 3 deprecated functions

---

### Phase 3: Fix Delta Module (Remove Invalid Comparison)

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, dockhand-library |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phases 1-2) |

**Objective:** Remove the invalid `xx_hash_alphanumeric` comparison from delta module.

**Deliverables:**
- Remove lines 257-261 in `shared/src/markdown/delta/mod.rs`
- Decide on replacement logic (recommend using semantic variant or simplified approach)

**Acceptance Criteria:**
- [ ] `xx_hash_alphanumeric` no longer called in delta module
- [ ] Existing delta tests pass
- [ ] Compilation succeeds

---

### Phase 4: Migrate Callers to xx_hash_variant

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, dockhand-library |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (after Phase 1) |

**Objective:** Update all call sites to use `xx_hash_variant`.

**Migration Map:**
| Old Call | New Call |
|----------|----------|
| `xx_hash_trimmed(d)` | `xx_hash_variant(d, vec![BlockTrimming])` |
| `xx_hash_normalized(d)` | `xx_hash_variant(d, vec![BlankLine])` |
| `xx_hash_semantic(d)` | `xx_hash_variant(d, vec![LeadingWhitespace, TrailingWhitespace, BlankLine])` |

**IMPORTANT**: The semantic mapping does NOT include `InteriorWhitespace` because `xx_hash_semantic` only uses `line.trim()` which handles leading/trailing whitespace per line, NOT interior whitespace collapsing.

**Files to Modify (can be parallelized - no file conflicts):**
- **Task 4a**: `shared/src/mermaid/mod.rs:158` - 1 change
- **Task 4b**: `shared/src/markdown/toc/types.rs` - 5 changes
- **Task 4c**: `shared/src/markdown/toc/mod.rs` - 3 changes

**Acceptance Criteria:**
- [ ] All call sites migrated
- [ ] All tests pass
- [ ] Compilation succeeds

---

### Phase 5: Delete Deprecated Functions

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, dockhand-library |
| **Complexity** | Low |
| **Dependencies** | Phase 3, Phase 4 |
| **Parallelizable** | No |

**Objective:** Remove deprecated hash functions and update exports.

**Functions to Delete:**
- `xx_hash_trimmed`
- `xx_hash_normalized`
- `xx_hash_semantic`
- `xx_hash_content_only`
- `xx_hash_alphanumeric`

**Files to Modify:**
- `shared/src/hashing/xx_hash.rs` - delete functions and their tests
- `shared/src/hashing/mod.rs` - update re-exports

**Acceptance Criteria:**
- [ ] No deprecated functions exist
- [ ] Re-exports only: `xx_hash`, `xx_hash_bytes`, `xx_hash_variant`, `HashVariant`
- [ ] `cargo build -p shared` succeeds

---

### Phase 6: Update Documentation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, dockhand-library |
| **Complexity** | Low |
| **Dependencies** | Phase 5 |
| **Parallelizable** | No |

**Objective:** Update documentation to reflect the new API.

**Deliverables:**
- **FIX CRITICAL BUG**: `shared/src/hashing/README.md` lines 19-20 have swapped descriptions:
  - LeadingWhitespace = removes whitespace at **beginning** of each line (not end)
  - TrailingWhitespace = removes whitespace at **end** of each line (not beginning)
- Updated module-level docs in `xx_hash.rs`
- Updated examples in `mod.rs`
- Updated `shared/docs/markdown-struct.md` if references exist

**Acceptance Criteria:**
- [ ] README.md documentation bug fixed
- [ ] All documentation uses new API
- [ ] Doc tests pass

---

### Phase 7: Final Verification

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, rust-testing, nextest |
| **Complexity** | Low |
| **Dependencies** | All previous phases |
| **Parallelizable** | No |

**Objective:** Run comprehensive verification.

**Commands:**
```bash
cargo build -p shared
cargo test -p shared
cargo clippy -p shared -- -D warnings
cargo test --doc -p shared
```

**Acceptance Criteria:**
- [ ] All builds succeed with no warnings
- [ ] All tests pass
- [ ] No clippy warnings
- [ ] grep finds no deprecated function usage

---

### Dependency Graph

```
Phase 1 (Core) ──┬──> Phase 2 (Tests) ──> Phase 4 (Migrate) ──┐
                 │                                              │
Phase 3 (Delta) ─┴────────────────────────────────────────────> Phase 5 (Delete) ──> Phase 6 (Docs) ──> Phase 7 (Verify)
```


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing.

- [SKILL: dockhand-library]: The interpolate and isolate modules mentioned in SKILL.md may need updating to reflect current module organization
- [CODE: delta/mod.rs]: The `xx_hash_alphanumeric` comparison at lines 257-260 was a known bug that slipped through initial review
- [DOC: README.md]: Lines 19-20 have LeadingWhitespace and TrailingWhitespace descriptions SWAPPED (critical documentation bug)
- [PLAN: migration mapping]: Original plan included InteriorWhitespace in xx_hash_semantic mapping, but xx_hash_semantic does NOT collapse interior whitespace - this would break backward compatibility


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation.

