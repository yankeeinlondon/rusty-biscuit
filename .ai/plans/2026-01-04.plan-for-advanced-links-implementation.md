---
status: "finalized"
started_at: 17:17:19
finished_at:
duration:
tts_gender: male
requirements: |
  ## Refined Requirements (Post-Clarification + Review)

  ### 1. CSS Style Parsing
  Parse `style` property from raw string into HashMap<String, String>.
  - Add `parsed_style()` method returning `Option<HashMap<String, String>>`
  - Handle edge cases: whitespace, trailing semicolons, empty declarations, quoted values
  - Keep existing `style()` method for raw string access

  ### 2. Terminal Linking (BROKEN - Needs Investigation)
  Current OSC8 code exists but "does not link at all" per user.
  **CONFLICTING FINDINGS:** Correctness review says ST is correct per spec.
  - INVESTIGATE actual issue before changing terminators
  - Test with user's terminal to identify root cause
  - May be terminal detection, escape sequence escaping, or other issue

  ### 3. Modern Popover Integration (Browser)
  Implement native Popover API support per modern-popovers-in-the-browser.md:
  - Use `interestfor="{id}"` for hover/focus triggers (tooltip behavior)
  - Generate companion `<div id="{id}" popover="hint">` with prompt content
  - Add `to_browser_with_popover()` -> returns (anchor_html, popover_html)
  - Note: `interestfor` is experimental; document browser support limitations

  ### 4. Documentation Updates
  Update shared/docs/md/advanced-links.md to reflect implementation status.

required_skills:
  - thiserror
important_skills:
  color-eyre: "Error handling for Link parsing"
  crossterm: "Terminal escape sequence debugging"
subagents:
  rust-designer: "Implementation of all phases"
  feature-tester-rust: "Integration testing (Phase 5)"
monorepo_modules_impacted:
  - shared (primary - Link struct in shared/src/render/link.rs)
---
# Planning Process

- [x] Identified Skills
- [x] Identified Subagents
- [x] User asked clarifying questions (human in the loop)
- [x] Requirements have been updated based on user responses to clarifying questions
- [x] All requirements have been made into a Phased Plan
- [x] Module Assessment has been completed
- [x] Review
   - [x] Completeness Review
   - [x] Concurrency Review
   - [x] Details/Knowledge Based Review
- [x] Plan finalized based on review feedback
- [ ] Summarized plan to user via STDOUT


## Final Plan

### Execution Strategy (Updated per Concurrency Review)

**Sequential execution** to avoid merge conflicts on single file:

```
Phase 1 (Terminal) ──► Phase 2 (CSS) ──► Phase 3 (Popover) ──► Phase 4 (Docs) ──► Phase 5 (Tests)
```

---

### Phase 1: Terminal Linking Investigation & Fix
**Complexity:** Medium | **Subagent:** rust-designer

**Objective:** Diagnose and fix broken terminal linking.

**IMPORTANT:** Do NOT blindly switch ST→BEL. Investigate actual cause first.

**Investigation Steps:**
1. Test current `to_terminal()` output in user's terminal
2. Check if `supports_hyperlinks::on(Stream::Stdout)` returns correct value
3. Verify escape sequences are not double-escaped
4. Test with raw echo of escape codes to terminal

**Possible Fixes (depending on investigation):**
- If ST terminator issue: Add BEL alternative, keep ST as fallback
- If detection issue: Fix `supports_hyperlinks` usage
- If escaping issue: Fix string formatting

**Deliverables:**
- Root cause documentation
- Fix for `to_terminal()` method
- Tests verifying escape sequence format
- Optional: `to_terminal_with_bel()` alternative if needed

---

### Phase 2: CSS Style Parsing
**Complexity:** Low | **Subagent:** rust-designer

**Changes to `shared/src/render/link.rs`:**

1. Add helper function:
```rust
fn parse_css_style(style: &str) -> HashMap<String, String> {
    let mut result = HashMap::new();
    for declaration in style.split(';') {
        let trimmed = declaration.trim();
        if trimmed.is_empty() { continue; }
        if let Some(colon_pos) = trimmed.find(':') {
            let key = trimmed[..colon_pos].trim().to_lowercase();
            let value = trimmed[colon_pos + 1..].trim();
            if !key.is_empty() && !value.is_empty() {
                result.insert(key, value.to_string());
            }
        }
    }
    result
}
```

2. Add getter:
```rust
pub fn parsed_style(&self) -> Option<HashMap<String, String>> {
    self.style.as_ref().map(|s| parse_css_style(s))
}
```

3. Tests: basic, whitespace, trailing semicolon, empty declarations

---

### Phase 3: Modern Popover Integration
**Complexity:** Medium | **Subagent:** rust-designer

**Changes to `shared/src/render/link.rs`:**

1. Add ID generation (use simple hash, prefix `popover-`):
```rust
fn generate_popover_id(url: &str, display: &str) -> String {
    use std::hash::{Hash, Hasher};
    use std::collections::hash_map::DefaultHasher;
    let mut hasher = DefaultHasher::new();
    url.hash(&mut hasher);
    display.hash(&mut hasher);
    format!("popover-{:x}", hasher.finish())
}
```

2. Add popover method:
```rust
pub fn to_browser_with_popover(&self) -> Option<(String, String)> {
    self.prompt.as_ref().map(|prompt_text| {
        let id = generate_popover_id(&self.link_to, &self.display);
        let anchor = format!(
            r#"<a href="{}" interestfor="{}"{}>{}</a>"#,
            html_escape(&self.link_to),
            id,
            self.format_other_attrs(),
            html_escape(&self.display)
        );
        let popover = format!(
            r#"<div id="{}" popover="hint">{}</div>"#,
            id,
            html_escape(prompt_text)
        );
        (anchor, popover)
    })
}
```

3. Tests for HTML structure, ID uniqueness, content escaping

**Browser Support Note:** `interestfor` is experimental. Document that clients should use feature detection.

---

### Phase 4: Documentation Updates
**Complexity:** Low | **Subagent:** rust-designer

**Changes to `shared/docs/md/advanced-links.md`:**
- Add CSS parsing section with `parsed_style()` usage
- Update terminal section with actual fix status
- Add Popover API usage examples
- Link to modern-popovers doc
- Note browser support limitations for `interestfor`

---

### Phase 5: Integration Testing
**Complexity:** Medium | **Subagent:** feature-tester-rust

**Deliverables:**
- Terminal output format verification tests
- CSS parsing roundtrip tests
- Popover HTML structure tests
- HTML escaping verification tests

---

## Review Findings Summary

### High Priority (Incorporated)
| Finding | Resolution |
|---------|------------|
| Investigate ST vs BEL before changing | Phase 1 updated to investigate first |
| CSS edge case handling | Phase 2 includes trimming, empty handling |
| HTML escaping for popover content | Phase 3 uses html_escape() |
| Sequential not parallel execution | Execution strategy updated |

### Medium Priority (Documented)
| Finding | Resolution |
|---------|------------|
| `interestfor` browser support | Documented in Phase 3 and Phase 4 |
| CSS shorthand properties | Accept as-is (don't expand) |
| ID collision risk | Negligible with hash (documented) |

### Deferred (Low Priority)
| Finding | Reason |
|---------|--------|
| CSS property whitelist | Over-engineering for current scope |
| Cached CSS parsing | Premature optimization |
| Migration guide | Not needed unless ST→BEL confirmed |
