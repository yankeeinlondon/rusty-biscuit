---
status: "done"
started_at: 10:49:27
finished_at: 10:55:30
duration: "6 minutes"
tts_gender: male
requirements: |
  Add new features to the "sniff" package under "git" section:

  1. Add a "worktrees" property - key/value dictionary where keys are branch names and values contain:
     { branch: string, filepath: string (fully qualified), sha: hash, dirty: bool }

  2. Add "in_worktree" boolean property indicating if current directory resides within a worktree
     (versus a regular clone/checkout of a repo)

  3. Change `head_commit` property to `recent` property listing last 10 local commits. Each commit
     contains sha, message, author, timestamp fields (from old head_commit) plus optional "remotes"
     field (list of remotes which have this commit). "remotes" is optional because by default we
     will NOT interrogate the remote. Add `--deep` CLI flag to interrogate remotes for this info.

  4. When `--deep` flag is used, also check what branches are available on each remote and include
     that in the `remotes` section as a new field.

  5. Add "is_behind" field to the "status" property in git. Value is either `false` or `Remote[]`
     (the remotes which local is behind on).
required_skills:
  - rust
  - clap
  - thiserror
important_skills:
  rust-testing: "when writing unit and integration tests"
  serde: "when serializing new data structures to JSON"
subagents:
  Plan: "Create detailed implementation plan with phases"
  general-purpose: "Implement Rust code for git features"
  feature-tester-rust: "Create comprehensive tests for all new git features"
  Bash: "CLI modifications and verification"
monorepo_modules_impacted:
  - sniff/lib
  - sniff/cli
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 4
---

# Planning Process

- [x] Prep Started [10:49:27]
    - [x] Identified Skills [10:50:15] - rust, clap, thiserror (suggested: rust-testing, serde)
    - [x] Identified Subagents [10:50:15] - Plan, general-purpose, feature-tester-rust, Bash
- [x] Prep complete [10:50:30]
- [x] Clarification [10:51:00]
    - [x] User asked clarifying questions (human in the loop) [10:51:30]
    - Clarifications:
        - Worktrees keyed by **branch name**
        - `is_behind` only available with **--deep flag**
        - Recent commits from **HEAD history only** (last 10 commits from HEAD)
- [x] Planning Subagent [agent: **Plan**] started [10:51:45]
    - [x] subagent skills used: rust, clap, thiserror
    - [x] Planning completed [10:52:30]
- [x] Module Assessment - sniff/lib, sniff/cli identified [10:52:30]
- [x] All Pre-review Steps complete
- [x] Review Started [10:53:00]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, clap
       - Found: Breaking API change needs strategy, config threading incomplete
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust
       - Found: Phase 6 does NOT depend on Phase 5, more parallelization possible
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, clap, thiserror
       - Found: git2 API corrections needed, worktree access patterns
- [x] Reviews Completed [10:54:00]
- [x] Plan Finalization [agent: **general-purpose**] started [10:54:15]
    - [x] subagent skills used: rust, clap, thiserror, serde
- [x] Plan finalized [10:55:30]
- Final Steps
    - [x] Lessons learned collected from all subagents (3 entries)
    - [x] No new packages to research (git2 already present)
- [x] Summarized plan to user via STDOUT
    - Project File: `.ai/plans/2026-01-14.plan-for-sniff-git-worktrees-deep.md`
    - Started: 10:49:27
    - Completed: 10:55:30
    - Duration: 6 minutes


## Codebase Context (from exploration)

**Key Files:**
- `/Volumes/coding/personal/dockhand/sniff/lib/src/filesystem/git.rs` (902 lines) - Core git detection
- `/Volumes/coding/personal/dockhand/sniff/cli/src/main.rs` - CLI args
- `/Volumes/coding/personal/dockhand/sniff/cli/src/output.rs` - Output formatting
- `/Volumes/coding/personal/dockhand/sniff/lib/src/lib.rs` - Public API & SniffConfig

**Current Structs:**
- `GitInfo` - Main struct with repo_root, current_branch, head_commit, status, remotes
- `CommitInfo` - sha, message, author, timestamp
- `RepoStatus` - is_dirty, staged_count, unstaged_count, untracked_count, dirty, untracked
- `RemoteInfo` - name, url, provider

**Existing Patterns:**
- Uses git2 crate for repository operations
- Dual-mode flag system (include-only vs skip flags)
- Verbose levels for output detail (-v, -vv, -vvv)
- No --deep flag currently exists


## Plan

### Phase 1: Add WorktreeInfo Struct and worktrees Property

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, serde |
| **Suggested Skills** | - |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 2, 4) |

**Objective:** Add `WorktreeInfo` struct and `worktrees: HashMap<String, WorktreeInfo>` to `GitInfo`.

**Deliverables:**
- New `WorktreeInfo` struct in git.rs
- New `worktrees` field on `GitInfo`
- New `get_worktrees()` helper function

**Acceptance Criteria:**
- [ ] `WorktreeInfo` struct defined with `branch`, `filepath`, `sha`, `dirty` fields
- [ ] `GitInfo` has `worktrees: HashMap<String, WorktreeInfo>` field
- [ ] JSON serialization works correctly

---

### Phase 2: Add in_worktree Property

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | - |
| **Complexity** | Low |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 1, 4) |

**Objective:** Add `in_worktree: bool` to `GitInfo` via `repo.is_worktree()`.

**Acceptance Criteria:**
- [ ] `in_worktree` field added to `GitInfo`
- [ ] Returns `false` for normal repositories, `true` when in worktree

---

### Phase 3: Replace head_commit with Recent Commits

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, serde |
| **Suggested Skills** | - |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 4) |

**Objective:** Replace `head_commit: Option<CommitInfo>` with `recent: Vec<CommitInfo>` (last 10 commits).

**Deliverables:**
- Update `CommitInfo` to add optional `remotes` field
- Replace `head_commit` with `recent` on `GitInfo`
- New `get_recent_commits()` function using revwalk

**Acceptance Criteria:**
- [ ] `CommitInfo` has `remotes: Option<Vec<String>>` field
- [ ] `GitInfo.head_commit` removed, replaced with `recent: Vec<CommitInfo>`
- [ ] Returns up to 10 commits in reverse chronological order

---

### Phase 4: Add --deep CLI Flag and Config Threading

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust, clap |
| **Suggested Skills** | - |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | Yes (with Phase 1, 2, 3) |

**Objective:** Add `--deep` flag to CLI and thread through to `detect_git()`.

**Deliverables:**
- Add `deep: bool` to `SniffConfig`
- Add `--deep` flag to CLI
- Update `detect_filesystem()` and `detect_git()` signatures

**Acceptance Criteria:**
- [ ] `--deep` flag added to CLI with help text
- [ ] Config threads through to git detection
- [ ] Default behavior unchanged when not specified

---

### Phase 5: Add Remote Branches (--deep mode)

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | - |
| **Complexity** | High |
| **Dependencies** | Phase 4 |
| **Parallelizable** | No |

**Objective:** Populate `branches: Vec<String>` on each `RemoteInfo` when `--deep` used.

**Deliverables:**
- Add `branches: Option<Vec<String>>` to `RemoteInfo`
- New `get_remote_branches()` function using `remote.connect_auth()`

**Acceptance Criteria:**
- [ ] `RemoteInfo.branches` is `None` without `--deep`
- [ ] `RemoteInfo.branches` populated with `--deep`
- [ ] Network failures handled gracefully

---

### Phase 6: Add is_behind Status (--deep mode)

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | - |
| **Complexity** | High |
| **Dependencies** | Phase 4 |
| **Parallelizable** | Yes (with Phase 5) |

**Objective:** Add `is_behind: Option<Vec<String>>` to `RepoStatus`.

**Deliverables:**
- Add `is_behind` field to `RepoStatus`
- New `check_behind_remotes()` function
- Populate `CommitInfo.remotes` for each commit when `--deep`

**Acceptance Criteria:**
- [ ] `is_behind` is `None` without `--deep`
- [ ] Lists remotes where local is behind when `--deep`
- [ ] `CommitInfo.remotes` populated for recent commits

---

### Phase 7: Update Output Formatting

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | - |
| **Complexity** | Low |
| **Dependencies** | Phase 1-6 |
| **Parallelizable** | No |

**Objective:** Update output.rs to display new git information.

**Acceptance Criteria:**
- [ ] Recent commits displayed (first as HEAD, rest at -v)
- [ ] Worktrees listed at verbose level 1+
- [ ] `in_worktree` indicator shown when true
- [ ] `is_behind` and remote branches shown with `--deep`

---

### Phase 8: Unit Tests

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust, rust-testing |
| **Suggested Skills** | - |
| **Complexity** | Medium |
| **Dependencies** | Phase 1-7 |
| **Parallelizable** | No |

**Objective:** Comprehensive unit tests for all new features.

**Acceptance Criteria:**
- [ ] Worktree detection tests
- [ ] Recent commits tests
- [ ] Deep mode tests (is_behind, remote branches)

---

### Phase 9: CLI Integration Tests

| Property | Value |
|----------|-------|
| **Subagent** | `Bash` |
| **Required Skills** | clap |
| **Suggested Skills** | - |
| **Complexity** | Low |
| **Dependencies** | Phase 4, 7, 8 |
| **Parallelizable** | No |

**Objective:** CLI integration tests for `--deep` flag.

**Acceptance Criteria:**
- [ ] `--deep` flag parses correctly
- [ ] Help text includes `--deep` description
- [ ] JSON output includes new fields

---

### Key Files

| File | Changes |
|------|---------|
| `sniff/lib/src/filesystem/git.rs` | All new structs, fields, functions |
| `sniff/lib/src/lib.rs` | `SniffConfig.deep` field |
| `sniff/cli/src/main.rs` | `--deep` CLI flag |
| `sniff/cli/src/output.rs` | Text output formatting |
| `sniff/lib/src/filesystem/mod.rs` | `detect_filesystem()` signature |

### Breaking Changes

1. `GitInfo.head_commit` removed â†’ use `recent.first()`
2. `detect_git()` signature now requires `deep: bool` parameter
3. `detect_filesystem()` signature now requires `deep: bool` parameter


## Lessons Learned

> Discoveries from planning that may improve skills or documentation.

- [SKILL: git2]: The `connect_auth()` method returns a `RemoteConnection` object; `list()` must be called on the connection, not chained directly on Remote
- [SKILL: git2]: Worktree objects do not expose HEAD/branch info directly; must open as Repository via `Repository::open(worktree.path())`
- [SKILL: git2]: Anonymous worktrees have no name and return None from StringArray iteration; filter these out when building HashMap
- [CODEBASE: sniff]: Config threading pattern (SniffConfig -> detect_with_config -> detect_filesystem) needs extension to support deep flag passthrough to detect_git

## Package Changes in Execution

> No new packages required - git2 v0.20.3 already supports all needed APIs.

## Optimized Execution Wave Structure

```
Wave 1 (All Parallel):  Phase 1 | Phase 2 | Phase 3 | Phase 4
                        structs   bool      commits   config

Wave 2 (Parallel):      Phase 5 | Phase 6
                        branches  is_behind

Wave 3 (Parallel):      Phase 7 | Phase 8
                        output    unit tests

Wave 4 (Sequential):    Phase 9
                        CLI tests
```

