---
plan_file: .ai/plans/2026-01-13.plan-for-schematic-package-redo.md
phases: 13
status: done
stop_reason: ""
started: 13 January 2026 at 10:55:28
completed: 13 January 2026 at 11:43:55
duration: 48 minutes 27 seconds
---
# Plan Execution: Schematic Package Redo

## Progress

- [x] Plan execution started [13 January 2026 at 10:55:28]
- [x] Snapshot Complete [13 January 2026 at 10:55:28]
    - [x] Lint check - PASS (26 pre-existing warnings in tests)
    - [x] Test check - PASS (27 test executables compile)
    - [x] Build check - PASS
    - [x] Git check - PASS (2 untracked .ai/ files - acceptable)

---

## Phase 1: Foundation - Definition Library Core Types

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | thiserror, serde, strum |
| **Suggested Skills** | rust |
| **Complexity** | Medium |
| **Dependencies** | None |
| **Parallelizable** | No |

**Objective:** Create `schematic/define` library with core type definitions.

**Deliverables:**
- [x] `schematic/define/Cargo.toml` with dependencies
- [x] `types.rs` with `RestApi`, `Endpoint`, `RestMethod`
- [x] `schema.rs` with `SchemaObject` trait and `Schema` descriptor
- [x] `auth.rs` with `AuthStrategy` enum
- [x] `response.rs` with `ApiResponse` enum
- [x] `lib.rs` with re-exports

**Acceptance Criteria:**
- [x] All types compile and pass `cargo check`
- [x] `RestMethod` supports strum Display/EnumIter/EnumString
- [x] SchemaObject trait has bounds (Serialize, DeserializeOwned, Debug, Clone, Send, Sync, 'static)
- [x] Unit tests verify enum string parsing (5 tests added)

**Status:** [x] Complete [13 January 2026 at 11:04:30]

**Notes:** Phase 1 was already implemented. Added 5 unit tests for RestMethod enum string parsing and serde roundtrip. Added `#[serde(rename_all = "UPPERCASE")]` to RestMethod.

---

## Phase 2: Example API Definition

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | serde |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | No |

**Objective:** Create example OpenAI API definition to validate type system.

**Deliverables:**
- [x] `apis/openai.rs` with complete OpenAI API definition
- [x] Schema objects (Model, ListModelsResponse, DeleteModelResponse)
- [x] `define_openai_api()` function

**Acceptance Criteria:**
- [x] At least 3 endpoints defined (ListModels, RetrieveModel, DeleteModel)
- [x] Path parameters demonstrated (`/models/{model}`)

**Status:** [x] Complete [13 January 2026 at 11:07:44]

---

## Phase 3: Generator Binary Scaffold

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | clap, thiserror |
| **Suggested Skills** | rust |
| **Complexity** | Medium |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (with Phase 2) |

**Objective:** Create generator binary scaffold with CLI and error types.

**Deliverables:**
- [x] `schematic/gen/Cargo.toml`
- [x] `main.rs` with clap CLI
- [x] `errors.rs` with GeneratorError enum

**Acceptance Criteria:**
- [x] CLI parses arguments correctly
- [x] `--help` displays usage
- [x] `--dry-run` flag prevents file writes

**Status:** [x] Complete [13 January 2026 at 11:07:44]

---

## Phase 4: Path Parameter Extraction

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 1 |
| **Parallelizable** | Yes (with Phases 2, 3) |

**Objective:** Implement path parameter extraction from endpoint paths.

**Deliverables:**
- [x] `parser.rs` with path parameter extraction
- [x] Unit tests for various path patterns (8 tests)

**Acceptance Criteria:**
- [x] Extracts `/models/{model}` → `["model"]`
- [x] Handles multiple params and no params

**Status:** [x] Complete [13 January 2026 at 11:07:44]

---

## Phase 5: Request Struct Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, quote |
| **Suggested Skills** | rust |
| **Complexity** | High |
| **Dependencies** | Phase 1, Phase 4 |
| **Parallelizable** | No |

**Objective:** Generate per-endpoint request structs.

**Deliverables:**
- [x] `codegen/request_structs.rs` (422 lines)
- [x] Path params → String fields, body field, Default impl
- [x] `into_parts()` method for path substitution
- [x] `validate_generated_code()` function using syn
- [x] `format_generated_code()` function using prettyplease

**Acceptance Criteria:**
- [x] Generates request struct per endpoint
- [x] Default trait implemented
- [x] Generated code passes syn validation

**Status:** [x] Complete [13 January 2026 at 11:12:52]

**Notes:** 18 tests total (8 parser + 10 codegen). All HTTP methods generate correct method strings. Path parameter substitution works for single and multiple params.

---

## Phase 6: Request Enum Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, quote |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phase 5 |
| **Parallelizable** | No |

**Objective:** Generate unified request enum with From implementations.

**Deliverables:**
- [x] `codegen/request_enum.rs`
- [x] Enum with one variant per endpoint
- [x] `From` implementations for each request struct (individual impls, not Vec)

**Acceptance Criteria:**
- [x] `into_parts()` returns (method, path, body)
- [x] From impls allow `.into()` conversion

**Status:** [x] Complete [13 January 2026 at 11:15:34]

**Notes:** 8 new tests added (26 total). Explicit test verifying individual From impls are generated (not combined Vec).

---

## Phase 7: API Struct and Client Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease, quote, reqwest |
| **Suggested Skills** | rust |
| **Complexity** | High |
| **Dependencies** | Phase 6 |
| **Parallelizable** | No |

**Objective:** Generate API struct with reqwest HTTP client.

**Deliverables:**
- [x] `codegen/api_struct.rs` and `codegen/client.rs`
- [x] API struct with BASE_URL, `new()`, `request()` method
- [x] Auth header application based on AuthStrategy (all 4 variants)
- [x] Reqwest client initialization

**Acceptance Criteria:**
- [x] `request()` handles all HTTP methods (GET, POST, PUT, PATCH, DELETE, HEAD, OPTIONS)
- [x] Authentication headers correctly applied
- [x] Error handling for non-success responses (no unwrap in control flow)

**Status:** [x] Complete [13 January 2026 at 11:19:05]

**Notes:** 43 tests total. Generated async request() method with proper error handling. Auth setup covers None, BearerToken, ApiKey, Basic strategies.

---

## Phase 8: Error Types for Generated Code

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | thiserror, syn, quote |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 7 |
| **Parallelizable** | No (was incorrectly marked parallelizable in plan) |

**Objective:** Generate SchematicError enum for runtime errors.

**Deliverables:**
- [x] Error type generation module (`codegen/error.rs`)
- [x] HTTP, JSON, API error variants (5 total)
- [x] Body serialization error handling

**Acceptance Criteria:**
- [x] From impls for reqwest and serde_json errors (via `#[from]` attribute)
- [x] Descriptive error messages (all variants have `#[error("...")]`)

**Status:** [x] Complete [13 January 2026 at 11:22:48]

**Notes:** 52 tests total (9 new). SchematicError has 5 variants: Http, Json, ApiError, UnsupportedMethod, SerializationError.

---

## Phase 9: Output Assembly and File Writing

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | syn, prettyplease |
| **Suggested Skills** | None |
| **Complexity** | Medium |
| **Dependencies** | Phases 5-8 |
| **Parallelizable** | No |

**Objective:** Assemble generated code and write to disk.

**Deliverables:**
- [x] `output.rs` for file assembly
- [x] Atomic writes (temp file + rename)
- [x] Generated lib.rs with all modules

**Acceptance Criteria:**
- [x] syn validation before writing
- [x] prettyplease formatting
- [x] Atomic writes prevent corruption

**Status:** [x] Complete [13 January 2026 at 11:28:17]

**Notes:** 76 tests total. Dry-run produces fully formatted Rust code. Main CLI now functional with `--api openai --dry-run`.

---

## Phase 10: Schema Package Cargo.toml Generation

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 9 |
| **Parallelizable** | No (file I/O race with Phase 9) |

**Objective:** Generate Cargo.toml for schema package.

**Deliverables:**
- [x] Generated Cargo.toml with reqwest, serde, serde_json, thiserror, tokio deps

**Acceptance Criteria:**
- [x] Valid Cargo.toml syntax (verified with toml crate)
- [x] All runtime dependencies included

**Status:** [x] Complete [13 January 2026 at 11:31:35]

**Notes:** 92 tests total. Edition 2024, license AGPL-3.0-only. CLI now generates both lib.rs and Cargo.toml.

---

## Phase 11: Integration and E2E Testing

| Property | Value |
|----------|-------|
| **Subagent** | `feature-tester-rust` |
| **Required Skills** | rust |
| **Suggested Skills** | wiremock |
| **Complexity** | High |
| **Dependencies** | All previous phases |
| **Parallelizable** | No |

**Objective:** Create comprehensive tests for generation pipeline.

**Deliverables:**
- [x] Integration tests in `schematic/gen/tests/` (3 test files)
- [x] HTTP client tests (24 tests in `http_client.rs`)
- [x] E2E: define → generate → compile → execute (`e2e_generation.rs`)
- [x] Path substitution tests (12 tests in `path_substitution.rs`)

**Acceptance Criteria:**
- [x] Path parameter substitution works (12 tests)
- [x] HTTP client sends correct requests (24 tests)
- [x] Generated code compiles without warnings (E2E test with clippy -D warnings)

**Status:** [x] Complete [13 January 2026 at 11:37:25]

**Notes:** 130 tests total (38 new). E2E tests marked `#[ignore]` for CI performance (run with `--ignored`). All auth strategies tested.

---

## Phase 12: Justfile and Workspace Integration

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 10 |
| **Parallelizable** | Yes (with Phase 11) |

**Objective:** Integrate into monorepo workspace.

**Deliverables:**
- [x] Workspace members already included (schematic/define, schematic/gen)
- [x] Create schematic/justfile with 9 recipes

**Acceptance Criteria:**
- [x] `just -f schematic/justfile build` works
- [x] `just -f schematic/justfile generate` runs generator

**Status:** [x] Complete [13 January 2026 at 11:43:24]

**Notes:** Justfile includes: build, test, lint, generate, generate-dry-run, clean-generated, full, test-e2e. Schema package built separately (generated, not in workspace).

---

## Phase 13: Documentation and Examples

| Property | Value |
|----------|-------|
| **Subagent** | `general-purpose` |
| **Required Skills** | rust |
| **Suggested Skills** | None |
| **Complexity** | Low |
| **Dependencies** | Phase 11 |
| **Parallelizable** | Yes (with Phase 12) |

**Objective:** Create documentation and usage examples.

**Deliverables:**
- [x] Doc comments on all public types (8 files enhanced)
- [x] Usage examples in doc tests (29 doc tests)

**Acceptance Criteria:**
- [x] All public items have doc comments
- [x] Doc tests compile and pass (24 + 5 passing)

**Status:** [x] Complete [13 January 2026 at 11:43:24]

**Notes:** Enhanced docs for types.rs, schema.rs, auth.rs, response.rs, lib.rs (both packages), codegen/mod.rs. Fixed bare URL rustdoc warning.

---

## Dependency Graph

```
Phase 1 (Foundation)
    |
    +---> Phase 2 (Example API) --+
    +---> Phase 3 (CLI Scaffold)  |
    +---> Phase 4 (Path Params) --+
                                  |
                                  v
                           Phase 5 (Request Structs)
                                  |
                                  v
                           Phase 6 (Request Enum)
                                  |
                                  v
                           Phase 7 (API Struct + Client)
                                  |
                                  v
                           Phase 8 (Errors)
                                  |
                                  v
                           Phase 9 (Output)
                                  |
                                  v
                           Phase 10 (Cargo.toml)
                                  |
                                  v
                           Phase 11 (Testing)
                                  |
                   +--------------+--------------+
                   |                             |
                   v                             v
           Phase 12 (Justfile)         Phase 13 (Docs)
```

---

## Lessons Learned

> Things learned about the plan, a skill, or some other "memory" resource which ended up being either wrong in some fashion or missing important details.

- [PLAN]: Phase 1 was already implemented - plans should check for existing partial implementations before starting
- [PLAN]: Phase 8 was marked "parallelizable with Phase 7" but actually depends on Phase 7's error type usage - correctly identified in plan review but worth reinforcing
- [PATTERN: generated-packages]: Generated packages (like schematic/schema) should NOT be added to workspace members since they may not exist; build separately with `--manifest-path`
- [SKILL: quote]: The `format_ident!` macro is essential for constructing identifiers dynamically in quote! blocks
- [SKILL: prettyplease]: Only accepts `syn::File` - must validate with `syn::parse2` first before formatting
- [SKILL: clap]: The `action = clap::ArgAction::Count` pattern works well for `-v`, `-vv`, `-vvv` verbosity levels
- [TESTING]: E2E tests that compile generated code should be marked `#[ignore]` for CI performance - run with `--ignored` flag
- [ARCHITECTURE]: Atomic writes (temp file + rename) prevent partial file corruption - pattern from biscuit/codegen works well

## Package Changes

> The dependencies which changed (add, updated, or removed)

### schematic-define
- [ADD] serde = { version = "1.0", features = ["derive"] }
- [ADD] strum = { version = "0.26", features = ["derive"] }
- [ADD] thiserror = "2.0"
- [ADD] serde_json = "1.0" (dev-dependency for tests)

### schematic-gen
- [ADD] clap = { version = "4.5", features = ["derive"] }
- [ADD] thiserror = "2.0"
- [ADD] syn = { version = "2.0", features = ["full", "parsing"] }
- [ADD] quote = "1.0"
- [ADD] proc-macro2 = "1.0"
- [ADD] prettyplease = "0.2"
- [ADD] tempfile = "3.15" (dev-dependency)
- [ADD] toml = "0.8" (dev-dependency)

### schematic-schema (generated)
- [ADD] reqwest = { version = "0.12", features = ["json", "rustls-tls"] }
- [ADD] serde = { version = "1.0", features = ["derive"] }
- [ADD] serde_json = "1.0"
- [ADD] thiserror = "2.0"
- [ADD] tokio = { version = "1.43", features = ["rt", "macros"] }

