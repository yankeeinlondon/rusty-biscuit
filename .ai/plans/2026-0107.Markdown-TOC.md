# Markdown TOC, Delta, Normalization, and Re-leveling Implementation Plan

**Created**: 2026-01-07
**Source**: `.ai/prompts/markdown-toc-and-delta.md`

## Overview

This plan implements four major features for the `Markdown` struct in the shared library:

1. **Hashing Module Reorganization** (Preamble)
2. **Table of Contents (TOC)** - Hierarchical heading extraction with hashes
3. **Delta Comparison** - Detailed change analysis between two markdown documents
4. **Normalization/Re-leveling** - Heading level validation and adjustment

## Phase 1: Preamble - Hashing Module

### 1.1 Create xx_hash.rs

**Location**: `shared/src/hashing/xx_hash.rs`

- Move implementation from `shared/src/mermaid/hash.rs`
- Rename function to `xx_hash()` for consistency
- Add additional hash variants:
  - `xx_hash(data: &str) -> u64` - Standard hash
  - `xx_hash_trimmed(data: &str) -> u64` - Hash after trimming whitespace
  - `xx_hash_normalized(data: &str) -> u64` - Hash with blank lines removed (current behavior)

### 1.2 Create blake3.rs

**Location**: `shared/src/hashing/blake3.rs`

- Add `blake3` crate to `Cargo.toml`
- Create `blake3(data: &str) -> String` function (returns hex string)
- Create `blake3_bytes(data: &[u8]) -> [u8; 32]` function

### 1.3 Update mod.rs

**Location**: `shared/src/hashing/mod.rs`

- Export both modules publicly
- Re-export commonly used functions at module level

### 1.4 Update Mermaid Module

**Location**: `shared/src/mermaid/`

- Update `mod.rs` to remove `pub mod hash`
- Update `Mermaid::hash()` to use `shared::hashing::xx_hash_normalized()`
- Remove `shared/src/mermaid/hash.rs`

### 1.5 Update lib.rs

**Location**: `shared/src/lib.rs`

- Add `pub mod hashing;`

## Phase 2: TOC Types

### 2.1 Create toc/types.rs

**Location**: `shared/src/markdown/toc/types.rs`

Types to create (in order):

1. `MarkdownTocNode` - Heading node with content, hashes, and children
2. `CodeBlockInfo` - Code block metadata for change tracking
3. `InternalLinkInfo` - Internal anchor link tracking
4. `MarkdownToc` - Top-level TOC structure

Key fields for `MarkdownTocNode`:
- `level: u8` - Heading level (1-6)
- `title: String` - Heading text
- `title_hash: u64` / `title_hash_trimmed: u64`
- `slug: String` - Anchor slug
- `source_span: (usize, usize)` - Byte offsets
- `line_range: (usize, usize)` - Line numbers (1-indexed)
- `own_content: Option<String>` - Section content only
- `own_content_hash: u64` / `own_content_hash_trimmed: u64`
- `subtree_hash: u64` / `subtree_hash_trimmed: u64`
- `children: Vec<MarkdownTocNode>`

### 2.2 Create toc/mod.rs

**Location**: `shared/src/markdown/toc/mod.rs`

- Module declarations
- Public exports
- `impl From<&Markdown> for MarkdownToc`
- `impl From<Markdown> for MarkdownToc`

### 2.3 Implement TOC Extraction

Using `pulldown_cmark` for streaming parsing:

1. Track heading events with byte offsets
2. Build hierarchical structure based on levels
3. Compute hashes for each section
4. Extract code blocks and internal links

### 2.4 Add toc() Method to Markdown

**Location**: `shared/src/markdown/mod.rs`

```rust
impl Markdown {
    pub fn toc(&self) -> MarkdownToc {
        MarkdownToc::from(self)
    }
}
```

## Phase 3: Delta Types

### 3.1 Create delta/types.rs

**Location**: `shared/src/markdown/delta/types.rs`

Types to create (in order):

1. `SectionPath` - Type alias for `Vec<String>`
2. `SectionId` - Unique section identifier
3. `ChangeAction` - Enum of all change types
4. `FrontmatterChange` - Frontmatter property change
5. `ContentChange` - Section content change
6. `MovedSection` - Moved section tracking
7. `BrokenLink` - Broken internal link
8. `CodeBlockChange` - Code block change
9. `DeltaStatistics` - Change metrics
10. `DocumentChange` - High-level classification
11. `MarkdownDelta` - Complete delta result

### 3.2 Create delta/mod.rs

**Location**: `shared/src/markdown/delta/mod.rs`

- Module declarations
- Public exports
- Helper functions for section matching

### 3.3 Implement Delta Algorithm

**Section Matching Priority**:
1. Exact match: Same path AND same content hash
2. Content match: Same content hash, different path (move detection)
3. Title match: Same path, different content hash (edit detection)
4. Fuzzy match: Similar title, similar content position

### 3.4 Add delta() Method to Markdown

**Location**: `shared/src/markdown/mod.rs`

```rust
impl Markdown {
    pub fn delta(&self, other: &Markdown) -> MarkdownDelta {
        // Implementation
    }
}
```

## Phase 4: Normalization Types

### 4.1 Create normalize/types.rs

**Location**: `shared/src/markdown/normalize/types.rs`

Types to create:

1. `HeadingLevel` - Type-safe heading level (1-6)
2. `StructureIssueKind` - Types of structural issues
3. `StructureIssue` - Issue with location info
4. `StructureValidation` - Validation result
5. `HeadingAdjustment` - Individual adjustment record
6. `ViolationCorrection` - Correction details
7. `NormalizationReport` - Full report
8. `NormalizationError` - Error enum

### 4.2 Create normalize/mod.rs

**Location**: `shared/src/markdown/normalize/mod.rs`

- Module declarations
- Public exports
- Implementation helpers

### 4.3 Implement Normalization

**Heading Detection**: Use `pulldown_cmark` events

**Replacement Strategy**:
1. Collect all heading positions with byte ranges
2. Sort by position (descending) to avoid offset invalidation
3. Replace each heading's `#` prefix
4. Preserve rest of line (title, trailing hashes, attributes)

**Violation Correction**:
1. Identify violating heading
2. Find child headings (until heading at or shallower than root)
3. Apply same delta to children
4. Record correction

### 4.4 Add Methods to Markdown

**Location**: `shared/src/markdown/mod.rs`

```rust
impl Markdown {
    pub fn validate_structure(&self) -> StructureValidation;

    pub fn normalize(
        &self,
        target: Option<HeadingLevel>,
    ) -> Result<(Markdown, NormalizationReport), NormalizationError>;

    pub fn normalize_mut(
        &mut self,
        target: Option<HeadingLevel>,
    ) -> Result<NormalizationReport, NormalizationError>;

    pub fn relevel(
        &self,
        target: HeadingLevel,
    ) -> Result<(Markdown, i8), NormalizationError>;
}
```

## Phase 5: Testing

### 5.1 Unit Tests

**Location**: `shared/src/markdown/toc/tests.rs`, etc.

Test categories:
- TOC extraction from various document structures
- Hash computation correctness
- Delta detection (additions, removals, modifications, moves)
- Normalization with promotion/demotion
- Violation correction with children
- Edge cases (empty docs, no headings, etc.)

### 5.2 Integration Tests

**Location**: `shared/tests/markdown_toc.rs`

- End-to-end workflows
- Large document handling
- Performance benchmarks

## Phase 6: Documentation Update

### 6.1 Update markdown-struct.md

**Location**: `shared/docs/markdown-struct.md`

Add sections:
- Table of Contents (`toc()` method)
- Document Delta (`delta()` method)
- Structure Validation (`validate_structure()`)
- Normalization (`normalize()`, `normalize_mut()`)
- Re-leveling (`relevel()`)
- Hashing utilities reference

## File Structure Summary

```
shared/
├── Cargo.toml (add blake3)
├── src/
│   ├── lib.rs (add pub mod hashing)
│   ├── hashing/
│   │   ├── mod.rs
│   │   ├── xx_hash.rs (new - moved from mermaid)
│   │   └── blake3.rs (new)
│   ├── mermaid/
│   │   ├── mod.rs (update - remove hash module)
│   │   └── hash.rs (DELETE)
│   └── markdown/
│       ├── mod.rs (add methods)
│       ├── types.rs (add NormalizationError variant)
│       ├── toc/
│       │   ├── mod.rs (new)
│       │   └── types.rs (new)
│       ├── delta/
│       │   ├── mod.rs (new)
│       │   └── types.rs (new)
│       └── normalize/
│           ├── mod.rs (new)
│           └── types.rs (new)
└── docs/
    └── markdown-struct.md (update)
```

## Dependencies to Add

```toml
# In shared/Cargo.toml
blake3 = "1.5"
```

## Implementation Order

1. **Hashing module** (foundational - other modules depend on it)
2. **TOC types and implementation** (delta depends on TOC)
3. **Normalization types** (can be done in parallel with delta)
4. **Delta types and implementation** (needs TOC)
5. **Tests** (throughout)
6. **Documentation** (final)

## Risk Mitigation

- Run `cargo test` after each phase
- Keep mermaid/hash.rs until new hashing module is verified
- Use feature flags if needed for incremental rollout
