---
status: "planning"
started_at: 12:43:00
finished_at:
duration:
tts_gender: male
requirements: |
  Refactor the biscuit-speaks package to remove the `tts` crate dependency and instead:
  1. Use InstalledTtsClients from the sniff library for host TTS discovery
  2. Add ElevenLabs cloud TTS support via schematic/schema API client
  3. Implement TTS prioritization based on OS with environment variable overrides
  4. Create the Speak struct with builder pattern API for async TTS operations
  5. Support volume, gender, language, and voice configuration
  6. Update all client packages (so-you-say, research/lib, research/cli)

  Clarified requirements:
  - API: Async-only (no blocking wrappers needed)
  - Failover: Auto-failover to next provider on failure
  - Detection: Lazy singleton pattern (detect once, cache globally)
required_skills:
  - rust
  - thiserror
  - tokio
  - serde
  - reqwest
  - strum
important_skills:
  anyhow: "For application-level error handling in client packages"
  color-eyre: "For enhanced error context in CLI applications"
  rust-testing: "When writing tests for TTS abstraction layer"
  monorepos: "When coordinating changes across workspace packages"
subagents:
  Plan: "Create phased implementation plan"
  Explore: "Module assessment for monorepo impact"
  general-purpose: "Reviews (completeness, concurrency, correctness) and finalization"
  feature-tester-rust: "Test implementation"
monorepo_modules_impacted:
  - biscuit-speaks (core refactor)
  - so-you-say (client update)
  - research/lib (client update)
  - research/cli (client update)
completeness_changes: []
concurrency_changes: []
detail_changes: []
lessons_learned_count: 0
---
# Planning Process

- [x] Prep Started [12:43pm]
    - [x] Identified Skills [12:44pm]
    - [x] Identified Subagents [12:44pm]
- [x] Prep complete with 35% context available [12:44pm]
- [x] Clarify (orchestrator) [12:45pm]
    - [x] User asked clarifying questions (human in the loop) [12:45pm]
    - [x] Requirements updated: async-only, auto-failover, lazy singleton [12:45pm]
- [x] Planning Subagent [agent: **Plan**] started [12:45pm]
    - [x] subagent skills used: rust, thiserror, tokio, serde, strum
    - [x] Planning completed [12:47pm]
- [x] Module Assessment Subagent [agent: **Explore**] started [12:45pm]
    - [x] subagent skills used: rust
    - [x] Module Assessment completed [12:47pm]
- [x] All Pre-review Steps are complete
    - 35% of context window is still available
- [x] Review Started [12:48pm]
   - [x] Completeness Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, thiserror, tokio, serde, reqwest, strum
   - [x] Concurrency Review [agent: **general-purpose**]
       - [x] subagent skills used: rust, tokio
   - [x] Details/Knowledge Based Review [agent: **general-purpose**]
        - [x] subagent skills used: rust, tokio, thiserror
- [x] Reviews Completed [12:49pm]
    - 35% of context window is still available
- [ ] Plan Finalization [agent: **NAME**] started [TODO]
    - [ ] subagent skills used: **LIST**
- [ ] Plan finalized [TODO]
    - {%} of context window is still available
- Final Steps
    - [ ] Lessons learned collected from all subagents
    - [ ] Researching {#} packages [TODO]
- [ ] Summarized plan to user via STDOUT
    - Project File: {filename}
    - Started: {datetime}
    - Completed: {datetime}
    - Duration: {duration}



## Plan

{ fill in when ready }


## Lessons Learned

> Capture discoveries about skills or memory resources (CLAUDE.md, README.md, etc.) that were inaccurate, incomplete, or missing. These insights help improve future planning sessions.

- [CRATE: tts]: The tts crate provides native bindings but has platform-specific compilation challenges; CLI-based approach offers more flexibility
- [API: schematic-schema]: Generated API clients provide `into_parts()` method returning tuple of (method, path, body, headers) - useful for custom HTTP execution
- [CODE: biscuit-speaks/old.rs]: Functions `speak_when_able()` and `available_system_voices()` defined here but not re-exported from lib.rs - potential broken state
- [CODE: biscuit-speaks/types.rs]: `HostTtsProvider::is_available()` at line 204 contains only `todo!()` - blocker for provider selection
- [API: macOS say]: The `-v` flag selects VOICE (e.g., `-v Alex`), NOT volume. macOS `say` has no direct volume flag
- [PATTERN: stdin EOF]: Process stdin must be explicitly closed (dropped) to send EOF signal; omission causes hangs
- [PATTERN: error accumulation]: Collecting only last_error loses debug info; should collect all failures in Vec
- [DEPENDENCY: futures]: May be needed for concurrent task coordination in Phase 3/4 parallel execution


## Package Changes in Execution

> Dependencies to be added, updated, or removed during implementation. Research for ADD actions produces skill files.

- [ADD(biscuit-speaks)]: schematic-schema in cargo - ElevenLabs cloud TTS API client
    - "How does schematic-schema handle binary response bodies for audio streaming?"
- [ADD(biscuit-speaks)]: tokio in cargo - Async runtime for process spawning and HTTP requests
    - "What tokio features are needed for async Command execution?"
- [ADD(biscuit-speaks)]: async-trait in cargo - Async trait support for TtsExecutor trait
    - "Is async-trait still necessary with Rust 2024 edition async trait support?"
- [ADD(biscuit-speaks)]: tempfile in cargo - Temporary file management for audio playback
    - "Does tempfile automatically clean up on drop in async contexts?"
- [ADD(biscuit-speaks)]: reqwest in cargo - HTTP client for ElevenLabs API
    - "What features needed: json, stream?"
- [ADD(biscuit-speaks)]: futures in cargo - Concurrent task coordination
- [REMOVE(biscuit-speaks)]: tts in cargo - Replaced by CLI-based host TTS and cloud TTS
- [DO_NOT_ADD]: async-trait - May not be needed with Rust 2024 edition native async traits

