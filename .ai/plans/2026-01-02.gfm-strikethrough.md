# GFM Strikethrough Support

**Created:** 2026-01-02
**Status:** Reviewed - Ready for Implementation

## Review Summary

**Reviews Completed:** 2026-01-02

**Reviewers:**
- Rust Developer: Approve with Changes
- Rust Architect: Approve with Changes
- Feature Tester (Rust): Approve with Changes

**Key Changes from Review:**
1. Clarified that syntect's `FontStyle` doesn't have STRIKETHROUGH - must use direct ANSI codes
2. Expanded testing to include negative tests, edge cases, and regression tests (15-18 tests total)
3. Added recommendation to centralize parser options in future
4. Updated Phase 2 technical details for ANSI code application pattern

## Executive Summary

Implement GFM strikethrough (`~~text~~`) support for both Terminal and HTML rendering. This requires enabling the `ENABLE_STRIKETHROUGH` parser option and handling the `Tag::Strikethrough` events in both rendering pipelines.

## Requirements

### Functional Requirements

| ID | Requirement | Priority | Owner |
|----|-------------|----------|-------|
| FR-1 | Parse `~~text~~` syntax as strikethrough | High | Rust Developer |
| FR-2 | Render strikethrough in terminal with ANSI escape code `\x1b[9m` | High | Rust Developer |
| FR-3 | Render strikethrough in HTML with `<del>` tag | High | Rust Developer |
| FR-4 | Support nested styling (e.g., `**~~bold strikethrough~~**`) | Medium | Rust Developer |
| FR-5 | Add strikethrough scope for prose highlighting | Medium | Rust Developer |

### Non-Functional Requirements

| ID | Requirement | Target | Owner |
|----|-------------|--------|-------|
| NFR-1 | No performance regression in parsing | <1% overhead | Rust Developer |
| NFR-2 | Consistent behavior across Terminal and HTML | 100% parity | Feature Tester |
| NFR-3 | Backward compatible - non-strikethrough content unchanged | 100% | Feature Tester |

## Architecture Overview

### Current State

```
markdown input
     │
     ▼
┌─────────────┐
│ pulldown-   │  Options: ENABLE_TABLES only (terminal)
│ cmark       │  Options: None (HTML)
│ Parser      │
└─────────────┘
     │
     ▼
┌─────────────┐
│ Event       │  No Tag::Strikethrough handling
│ Processing  │
└─────────────┘
     │
     ▼
  Output (Terminal ANSI / HTML)
```

### Target State

```
markdown input
     │
     ▼
┌─────────────┐
│ pulldown-   │  Options: ENABLE_TABLES | ENABLE_STRIKETHROUGH (terminal)
│ cmark       │  Options: ENABLE_STRIKETHROUGH (HTML)
│ Parser      │
└─────────────┘
     │
     ▼
┌─────────────┐
│ Event       │  Handles Tag::Strikethrough / TagEnd::Strikethrough
│ Processing  │
└─────────────┘
     │
     ▼
  Output:
  - Terminal: \x1b[9m...text...\x1b[29m (strikethrough on/off)
  - HTML: <del>...text...</del>
```

### Data Flow

1. Parser encounters `~~` token
2. Emits `Event::Start(Tag::Strikethrough)`
3. Text events processed normally with strikethrough state active
4. Emits `Event::End(TagEnd::Strikethrough)`
5. Renderer applies appropriate formatting (ANSI/HTML)

## Phases

### Phase 1: Enable Strikethrough Parsing

**Principal Owner:** Rust Developer

**Goal:** Enable pulldown-cmark to parse `~~text~~` as strikethrough

**Dependencies:** None

**Blast Radius:** `cargo test -p shared --lib markdown`

**Deliverables:**
- Modified `shared/src/markdown/output/terminal.rs` parser options
- Modified `shared/src/markdown/output/html.rs` parser options

**Technical Details:**
- `terminal.rs:550`: Change `Options::ENABLE_TABLES` to `Options::ENABLE_TABLES | Options::ENABLE_STRIKETHROUGH`
- `html.rs:109`: Change `Parser::new(md.content())` to `Parser::new_ext(md.content(), Options::ENABLE_STRIKETHROUGH)`

**Files to Modify:**
- `shared/src/markdown/output/terminal.rs` - line 550
- `shared/src/markdown/output/html.rs` - line 109

**Acceptance Criteria:**
- [ ] `grep "ENABLE_STRIKETHROUGH" shared/src/markdown/output/terminal.rs` succeeds
- [ ] `grep "ENABLE_STRIKETHROUGH" shared/src/markdown/output/html.rs` succeeds
- [ ] Parser emits `Tag::Strikethrough` events (verified in Phase 2 tests)

---

### Phase 2: Terminal Strikethrough Rendering

**Principal Owner:** Rust Developer

**Goal:** Render strikethrough text with ANSI escape code in terminal output

**Dependencies:** Phase 1

**Blast Radius:** `cargo test -p shared --lib markdown::output::terminal`

**Deliverables:**
- State tracking for strikethrough (`in_strikethrough` boolean)
- Event handlers for `Tag::Strikethrough` / `TagEnd::Strikethrough`
- ANSI escape code emission in `emit_prose_text` or inline

**Technical Details:**

ANSI escape codes:
- Strikethrough ON: `\x1b[9m`
- Strikethrough OFF: `\x1b[29m`

**IMPORTANT:** syntect's `FontStyle` enum only includes BOLD, ITALIC, UNDERLINE - it does NOT have STRIKETHROUGH. Therefore, we must apply strikethrough ANSI codes directly in `emit_prose_text()` rather than through the font_style mechanism.

Event handling pattern (similar to `in_emphasis` / `in_strong`):
```rust
// Add state variable (around line 580)
let mut in_strikethrough = false;

// Handle events (add after Tag::Link handling, around line 700)
Event::Start(Tag::Strikethrough) => {
    in_strikethrough = true;
    if let Some(scope) = ScopeCache::global().scope_for_tag(&Tag::Strikethrough) {
        scope_stack.push(scope);
    }
}
Event::End(TagEnd::Strikethrough) => {
    in_strikethrough = false;
    scope_stack.pop();
}
```

**Strikethrough ANSI code application in `emit_prose_text()`:**
```rust
// In emit_prose_text() around line 926, after existing font style codes:
// Add parameter: in_strikethrough: bool

// After the existing font style codes:
if in_strikethrough {
    result.push_str("\x1b[9m");  // Strikethrough ON
}

// ... text content ...

// Before final reset:
if in_strikethrough {
    result.push_str("\x1b[29m");  // Strikethrough OFF
}
```

**Alternative: Modify wrapper.emit_styled() call to pass strikethrough state:**
The `emit_styled` call at line 792 will need to pass `in_strikethrough` to apply the ANSI code.

**Files to Modify:**
- `shared/src/markdown/output/terminal.rs` - add strikethrough handling (~20 lines)
- `shared/src/markdown/highlighting/scope_cache.rs` - add strikethrough scope

**Acceptance Criteria:**
- [ ] File `shared/src/markdown/output/terminal.rs` contains `in_strikethrough`
- [ ] File `shared/src/markdown/output/terminal.rs` contains `Tag::Strikethrough`
- [ ] File `shared/src/markdown/output/terminal.rs` contains `\x1b[9m`
- [ ] `cargo test -p shared --lib markdown::output::terminal::tests::test_terminal_strikethrough` passes
- [ ] Nested styling works: `**~~bold strikethrough~~**` renders correctly

---

### Phase 3: HTML Strikethrough Rendering

**Principal Owner:** Rust Developer

**Goal:** Render strikethrough text with `<del>` tag in HTML output

**Dependencies:** Phase 1

**Blast Radius:** `cargo test -p shared --lib markdown::output::html`

**Deliverables:**
- Event handlers for `Tag::Strikethrough` / `TagEnd::Strikethrough`

**Technical Details:**

HTML output:
- Strikethrough ON: `<del>`
- Strikethrough OFF: `</del>`

Event handling pattern:
```rust
Event::Start(Tag::Strikethrough) => {
    output.push_str("<del>");
}
Event::End(TagEnd::Strikethrough) => {
    output.push_str("</del>");
}
```

**Files to Modify:**
- `shared/src/markdown/output/html.rs` - add 6 lines for event handling

**Acceptance Criteria:**
- [ ] File `shared/src/markdown/output/html.rs` contains `Tag::Strikethrough`
- [ ] File `shared/src/markdown/output/html.rs` contains `<del>`
- [ ] `cargo test -p shared --lib markdown::output::html::tests::test_html_strikethrough` passes
- [ ] Nested styling works: `**~~bold strikethrough~~**` renders as `<strong><del>bold strikethrough</del></strong>`

---

### Phase 4: Scope Cache Update

**Principal Owner:** Rust Developer

**Goal:** Add strikethrough scope for consistent prose highlighting

**Dependencies:** None (can run in parallel with Phase 2)

**Blast Radius:** `cargo test -p shared --lib markdown::highlighting::scope_cache`

**Deliverables:**
- New `strikethrough` field in `ScopeCache` struct
- Updated `scope_for_tag` to handle `Tag::Strikethrough`

**Technical Details:**

TextMate scope for strikethrough: `markup.strikethrough.markdown`

```rust
// In ScopeCache struct
pub strikethrough: Scope,

// In ScopeCache::new()
strikethrough: Scope::new("markup.strikethrough.markdown")
    .expect("Invalid hardcoded scope: markup.strikethrough.markdown"),

// In scope_for_tag()
Tag::Strikethrough => Some(self.strikethrough),
```

**Files to Modify:**
- `shared/src/markdown/highlighting/scope_cache.rs` - add strikethrough scope (~10 lines)

**Acceptance Criteria:**
- [ ] `grep "strikethrough" shared/src/markdown/highlighting/scope_cache.rs` returns 3+ matches
- [ ] `cargo test -p shared --lib markdown::highlighting::scope_cache::tests::test_scope_for_tag_strikethrough` passes

---

### Phase 5: Comprehensive Testing

**Principal Owner:** Feature Tester (Rust)

**Goal:** Ensure complete test coverage for strikethrough feature

**Dependencies:** Phases 2, 3, 4

**Blast Radius:** `cargo test -p shared --lib markdown`

**Deliverables:**
- Terminal strikethrough tests
- HTML strikethrough tests
- Scope cache strikethrough tests
- Nested styling tests
- Edge case tests

**Test Scenarios:**

**Positive Tests (verify strikethrough renders):**

1. **Basic strikethrough:**
   - Input: `~~strikethrough text~~`
   - Terminal: Contains `\x1b[9m` and `\x1b[29m`
   - HTML: Contains `<del>` and `</del>`

2. **Nested bold + strikethrough:**
   - Input: `**~~bold and strikethrough~~**`
   - Terminal: Contains both bold (`\x1b[1m`) and strikethrough (`\x1b[9m`) ANSI codes
   - HTML: `<strong><del>bold and strikethrough</del></strong>`

3. **Nested italic + strikethrough:**
   - Input: `*~~italic and strikethrough~~*`
   - Terminal: Contains both italic (`\x1b[3m`) and strikethrough (`\x1b[9m`) ANSI codes
   - HTML: `<em><del>italic and strikethrough</del></em>`

4. **All styles combined:**
   - Input: `***~~bold italic strikethrough~~***`
   - Terminal: Contains `\x1b[1m`, `\x1b[3m`, and `\x1b[9m`
   - HTML: `<strong><em><del>bold italic strikethrough</del></em></strong>`

5. **Multiple strikethroughs in paragraph:**
   - Input: `Some ~~deleted~~ and ~~removed~~ text`
   - Each strikethrough segment rendered correctly

6. **Strikethrough in list items:**
   - Input: `- ~~completed task~~`
   - Renders correctly within list context

7. **Strikethrough spanning soft breaks:**
   - Input: `~~text that\nspans lines~~`
   - Renders as single strikethrough segment

8. **Strikethrough with inline code:**
   - Input: `~~some \`code\` here~~`
   - Both inline code background and strikethrough should apply

**Negative Tests (verify no false positives):**

9. **No strikethrough without markers:**
   - Input: `Normal text without strikethrough`
   - Terminal: Should NOT contain `\x1b[9m`
   - HTML: Should NOT contain `<del>`

10. **Unclosed markers:**
    - Input: `~~unclosed text`
    - Should NOT render as strikethrough (tilde rendered literally)

11. **Single tilde:**
    - Input: `~single tilde~`
    - Should NOT render as strikethrough (requires double tilde)

**Edge Cases:**

12. **Empty strikethrough:**
    - Input: `~~~~`
    - Verify parser behavior (may be empty or no-op)

13. **Strikethrough at paragraph boundaries:**
    - Input: `~~start~~ middle ~~end~~`
    - Each segment renders independently

**Regression Tests:**

14. **Strikethrough doesn't break existing styles:**
    - Input: `**bold** *italic* and ~~strikethrough~~`
    - All three styles should render independently and correctly

15. **Existing tests still pass:**
    - Run full test suite to verify no regressions

**Files to Create/Modify:**
- `shared/src/markdown/output/terminal.rs` - add 8+ test functions (~120 lines)
- `shared/src/markdown/output/html.rs` - add 6+ test functions (~80 lines)
- `shared/src/markdown/highlighting/scope_cache.rs` - add 1 test function (~10 lines)

**Acceptance Criteria:**
- [ ] `cargo test -p shared --lib markdown` passes with 0 failures
- [ ] New tests: `test_terminal_strikethrough_basic` exists
- [ ] New tests: `test_terminal_strikethrough_nested_bold` exists
- [ ] New tests: `test_terminal_strikethrough_nested_italic` exists
- [ ] New tests: `test_terminal_strikethrough_all_styles` exists
- [ ] New tests: `test_terminal_no_strikethrough_without_markers` exists (negative test)
- [ ] New tests: `test_terminal_strikethrough_unclosed` exists (edge case)
- [ ] New tests: `test_html_strikethrough_basic` exists
- [ ] New tests: `test_html_strikethrough_nested` exists
- [ ] New tests: `test_html_no_strikethrough_without_markers` exists (negative test)
- [ ] New tests: `test_scope_for_tag_strikethrough` exists
- [ ] New tests: `test_strikethrough_preserves_other_styles` exists (regression)
- [ ] Total new tests: 15-18 added

---

## Cross-Cutting Concerns

### Testing Strategy
- Unit tests in `#[cfg(test)] mod tests` blocks
- Test both positive cases (correct rendering) and negative cases (no strikethrough when not present)
- Use `strip_ansi_codes` helper for terminal output verification
- Verify ANSI code structure: `\x1b[9m...text...\x1b[29m`

### Security Considerations
- No new security concerns - strikethrough is purely visual formatting
- XSS already handled by existing HTML escaping

### Performance Considerations
- Adding one more parser option has negligible overhead
- Event handling is O(1) per event
- No additional allocations required

### Rust Best Practices
- Follow existing patterns for `in_emphasis` / `in_strong` tracking
- Use `Tag::Strikethrough` pattern matching
- Maintain consistent code style with existing event handlers

## Parallelization Opportunities

| Parallel Group | Phases | Reason |
|----------------|--------|--------|
| Group A | Phase 1 | Foundation - must complete first |
| Group B | Phase 2, Phase 3, Phase 4 | Independent implementation paths |
| Group C | Phase 5 | Depends on all previous phases |

### Parallelization Diagram

```text
Timeline:
────────────────────────────────────────────────────►

Phase 1: ████ (Enable parsing)
              │
              ├── Phase 2: ████████ (Terminal rendering)
              │
              ├── Phase 3: ██████ (HTML rendering)
              │
              └── Phase 4: ████ (Scope cache)
                                │
Phase 5:                        └──████████████ (Testing)
```

### Synchronization Points

1. **After Phase 1:** Parser options must be committed before rendering phases
2. **After Phases 2-4:** All rendering complete before comprehensive testing

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| ANSI code compatibility | Low | `\x1b[9m` is widely supported; test on multiple terminals |
| Scope not in theme | Low | Default to base style if strikethrough scope missing |
| Breaking existing tests | Medium | Run full test suite before merging |

## Open Questions

- [x] Use `<del>` or `<s>` for HTML? **Decision: `<del>` (semantic, indicates deleted text)**
- [x] ANSI code for strikethrough? **Answer: `\x1b[9m` on, `\x1b[29m` off**
- [x] TextMate scope for strikethrough? **Answer: `markup.strikethrough.markdown`**

## Implementation Notes

### ANSI Escape Codes Reference

| Style | ON | OFF |
|-------|-----|-----|
| Bold | `\x1b[1m` | `\x1b[22m` |
| Italic | `\x1b[3m` | `\x1b[23m` |
| Underline | `\x1b[4m` | `\x1b[24m` |
| **Strikethrough** | `\x1b[9m` | `\x1b[29m` |

### pulldown-cmark Tag Reference

```rust
// Strikethrough events
Event::Start(Tag::Strikethrough)
Event::End(TagEnd::Strikethrough)
```

### Estimated Implementation Size

| Phase | Lines of Code | Files Modified |
|-------|--------------|----------------|
| Phase 1 | ~5 | 2 |
| Phase 2 | ~30 | 1 |
| Phase 3 | ~10 | 1 |
| Phase 4 | ~15 | 1 |
| Phase 5 | ~210 | 3 |
| **Total** | **~270** | **5** |

## Future Improvements (from Architect Review)

**Parser Options Centralization (Optional):**
Currently, parser options are duplicated in each renderer. For better maintainability when adding more GFM features, consider creating a centralized function:

```rust
// In shared/src/markdown/mod.rs or new file
pub fn gfm_parser_options() -> Options {
    Options::ENABLE_TABLES | Options::ENABLE_STRIKETHROUGH
}
```

This prevents duplication when adding task lists, footnotes, etc. in the future. However, this is not required for the strikethrough implementation.
