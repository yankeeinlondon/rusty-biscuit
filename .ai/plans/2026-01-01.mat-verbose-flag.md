# Add Verbose Flag to mat CLI

**Created:** 2026-01-01
**Status:** Reviewed - Ready for Implementation

## Executive Summary

Add `--verbose`/`-v` flag to the `mat` CLI that outputs WARN level traces, and `-vv` for INFO level traces (and above). This follows the established pattern from the `research` CLI in this monorepo.

## Requirements

### Functional Requirements

| ID | Requirement | Priority | Owner |
|----|-------------|----------|-------|
| FR-1 | Add `-v`/`--verbose` flag using `ArgAction::Count` | High | Rust Developer |
| FR-2 | `-v` outputs WARN level traces | High | Rust Developer |
| FR-3 | `-vv` outputs INFO level traces and above | High | Rust Developer |
| FR-4 | Default (no flag) produces no trace output (zero overhead) | High | Rust Developer |

### Non-Functional Requirements

| ID | Requirement | Target | Owner |
|----|-------------|--------|-------|
| NFR-1 | Follow existing tracing patterns from research CLI | Required | Rust Developer |
| NFR-2 | Output traces to stderr (not stdout) | Required | Rust Developer |
| NFR-3 | Respect `RUST_LOG` environment variable override | Nice-to-have | Rust Developer |

## Architecture Overview

This is a small, self-contained change to the `mat` CLI binary. No changes to library code are required.

### Component Changes

```
mat/
├── Cargo.toml      # Add tracing, tracing-subscriber dependencies
└── src/main.rs     # Add -v flag, init_tracing function
```

### Data Flow

1. User invokes `mat -v file.md` or `mat -vv file.md`
2. clap parses `-v` count into `u8` field
3. `init_tracing()` configures tracing-subscriber with appropriate filter level
4. Trace events are emitted to stderr during markdown processing

## Phases

### Phase 1: Add Dependencies and Verbose Flag

**Principal Owner:** Rust Developer

**Goal:** Add tracing infrastructure and CLI argument

**Dependencies:** None

**Blast Radius:** `cargo test -p mat`

**Files to modify:**
- `mat/Cargo.toml` - Add `tracing = "0.1"` and `tracing-subscriber = { version = "0.3", features = ["env-filter"] }`
- `mat/src/main.rs` - Add verbose field to `Cli` struct

**Technical Details:**
```rust
// In Cli struct
/// Increase verbosity (-v for WARN, -vv for INFO)
#[arg(short = 'v', long = "verbose", action = clap::ArgAction::Count)]
verbose: u8,
```

**Acceptance Criteria:**
- [ ] `grep "tracing" mat/Cargo.toml` shows tracing dependencies
- [ ] `grep "tracing-subscriber" mat/Cargo.toml` shows tracing-subscriber with env-filter
- [ ] Verify tracing versions match research CLI: `grep "tracing" research/cli/Cargo.toml`
- [ ] `grep "verbose" mat/src/main.rs` shows verbose field
- [ ] `cargo build -p mat` succeeds

---

### Phase 2: Implement Tracing Initialization

**Principal Owner:** Rust Developer

**Goal:** Initialize tracing based on verbosity level

**Dependencies:** Phase 1

**Blast Radius:** `cargo test -p mat`

**Files to modify:**
- `mat/src/main.rs` - Add `init_tracing()` function and call it from `main()`

**Technical Details:**

Add function following the pattern from `research/cli/src/main.rs`:

```rust
use tracing_subscriber::{filter::EnvFilter, fmt, layer::SubscriberExt, util::SubscriberInitExt};

fn init_tracing(verbose: u8) {
    // Only initialize if verbose mode is enabled
    if verbose == 0 {
        return;
    }

    let base_filter = match std::env::var("RUST_LOG") {
        Ok(filter) => filter,
        Err(_) => match verbose {
            // -v: Show WARN level
            1 => "warn".to_string(),
            // -vv+: Show INFO level and above
            _ => "info".to_string(),
        },
    };

    let filter = EnvFilter::try_new(&base_filter).unwrap_or_else(|_| EnvFilter::new("warn"));

    tracing_subscriber::registry()
        .with(filter)
        .with(
            fmt::layer()
                .with_target(true)
                .with_level(true)
                .with_thread_ids(false)
                .with_writer(std::io::stderr)
                .compact(),
        )
        .init();
}
```

Call at start of `main()`:
```rust
fn main() -> Result<()> {
    color_eyre::install()?;
    let cli = Cli::parse();
    init_tracing(cli.verbose);
    // ... rest of main
}
```

**Acceptance Criteria:**
- [ ] `grep "init_tracing" mat/src/main.rs` shows function definition
- [ ] `grep "tracing_subscriber" mat/src/main.rs` shows import
- [ ] `mat --help` shows `-v, --verbose` option
- [ ] `mat --help | grep "Increase verbosity"` verifies help text
- [ ] `mat -v README.md` runs without error (if README.md exists)
- [ ] `cargo test -p mat` passes all tests
- [ ] `cargo clippy -p mat` passes
- [ ] Manual test: `RUST_LOG=debug mat file.md` respects env var override

---

## Cross-Cutting Concerns

### Testing Strategy
- Existing CLI tests in `mat/src/main.rs` (assert_cmd based) should continue to pass
- Manual testing: `mat -v file.md`, `mat -vv file.md`
- No new automated tests required for this minimal change

### Security Considerations
- None - tracing only outputs to stderr

### Performance Considerations
- No performance impact when verbose=0 (tracing not initialized)
- Minimal overhead when verbose enabled (stderr writes)

## Parallelization Opportunities

Both phases are sequential - Phase 2 depends on Phase 1.

| Parallel Group | Phases | Reason |
|----------------|--------|--------|
| Sequential | Phase 1, Phase 2 | Phase 2 uses Phase 1 dependencies |

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Tracing subscriber conflicts with color-eyre | Low | color-eyre and tracing are compatible; tested in research CLI |
| Breaking existing tests | Low | Verbose flag is opt-in; default behavior unchanged |

## Review Summary

**Reviews Completed:** 2026-01-01

**Reviewers:**
- Rust Developer: Approve with Changes

**Key Changes from Review:**
1. Clarified FR-4: Default produces no trace output with zero overhead (tracing not initialized)
2. Added version verification step for dependencies
3. Added help text verification in acceptance criteria
4. Added RUST_LOG manual test verification

**Resolved Concerns:**
- Verbosity level mapping confirmed correct: -v=WARN, -vv=INFO, no flag=no output
- This differs from research CLI (which always outputs WARN) but matches the user's specific request

## Open Questions (Resolved)

- ~~Should we support `-vvv` for DEBUG level?~~ **No** - Spec only requires WARN and INFO
- ~~Should we add `--json` flag?~~ **No** - Not requested, keep it simple

## Implementation Notes

This is a simple feature following an established pattern. The research CLI (`research/cli/src/main.rs`) provides a working reference implementation.

Key differences from research CLI:
1. No `--json` flag (not requested)
2. Simpler filter levels (WARN and INFO only, not DEBUG/TRACE)
3. No global flag (mat has no subcommands)
