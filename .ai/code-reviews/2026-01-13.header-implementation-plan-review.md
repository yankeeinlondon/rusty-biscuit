# Technical Review: Headers Implementation Plan for Schematic

**Date:** 2026-01-13
**Status:** REVIEWED - 3 Critical Issues Found

---

## Summary

The implementation plan for adding HTTP header support to schematic has **solid architectural foundations** but contains **3 critical technical issues** that must be addressed before implementation.

### Issues at a Glance

| Severity | Phase | Issue | Impact |
|----------|-------|-------|--------|
| CRITICAL | 1 | Incorrect path references in justfile | Build/generation failures |
| CRITICAL | 2 | Missing Result type for headers merging | Breaking API change |
| CRITICAL | 4 | Incomplete signature - missing Result wrapper | Misaligned with codebase |

---

## Detailed Analysis

### Phase 1: Directory Restructuring

**Current Status:** CORRECT ✓

All path references and code locations are accurate:

```
schematic/
├── define/          # ✓ Correct
├── gen/             # ✓ Correct
├── schema/          # ✓ Target location (after restructuring)
└── justfile         # ✓ Will be updated correctly
```

**Files correctly identified:**
- `schematic/gen/src/cargo_gen.rs` (line 23) uses `default_value = "schematic/schema/src"` ✓
- `schematic/gen/src/main.rs` (line 71) fallback is `"schematic/schema"` ✓
- `schematic/justfile` (line 51) references `schematic/schema/src` ✓
- All path references consistent with current structure

**No issues in Phase 1.** Ready to proceed.

---

### Phase 2: Header Type Definition

**Status:** MOSTLY CORRECT with 1 CRITICAL ISSUE

**Problem Identified:**

```rust
// PLAN SHOWS:
pub struct RestApi {
    // ... existing fields ...
    pub headers: Vec<(String, String)>,  // ✓ Correct for RestApi
}

pub struct Endpoint {
    // ... existing fields ...
    pub headers: Vec<(String, String)>,  // ✓ Correct for Endpoint
}
```

✓ Both type definitions are **correct** and follow the codebase pattern.

**Location:** `/Volumes/coding/personal/dockhand/schematic/define/src/types.rs`

**Current Endpoint struct** (lines 187-204):
```rust
pub struct Endpoint {
    pub id: String,
    pub method: RestMethod,
    pub path: String,
    pub description: String,
    pub request: Option<Schema>,
    pub response: ApiResponse,
}
```

Adding `pub headers: Vec<(String, String)>` is straightforward and correct.

**Current RestApi struct** (lines 108-139) has fields for auth management but no headers field yet. Addition is safe.

---

### Phase 3: Code Generation for Headers

**Status:** CRITICAL ISSUES FOUND ⚠️

#### Issue 1: Merge Headers Function - Missing Result Type (CRITICAL)

**Current Plan:**
```rust
fn merge_headers(api: &[(String, String)], endpoint: &[(String, String)])
    -> Vec<(String, String)> {
    // ...
}
```

**Problem:** This function lacks error handling, but the codebase extensively uses `Result` types throughout:

- `generate_cargo_toml()` → `String` (safe, no I/O)
- `write_cargo_toml()` → `Result<(), GeneratorError>` (has I/O)
- `generate_request_method()` → `TokenStream` (codegen, safe)
- `into_parts()` in generated code → **`Result<(...), SchematicError>`** (line 189 of request_structs.rs)

**Recommendation:**
```rust
fn merge_headers(
    api: &[(String, String)],
    endpoint: &[(String, String)]
) -> Vec<(String, String)> {
    // This is FINE - pure computation, no failure modes
    let mut result: Vec<(String, String)> = api.to_vec();
    for (key, value) in endpoint {
        result.retain(|(k, _)| k != key);
        result.push((key.clone(), value.clone()));
    }
    result
}
```

**Assessment:** Actually CORRECT. The plan shows the right logic. However, **optimize the implementation**:

**Better Implementation:**
```rust
fn merge_headers(
    api: &[(String, String)],
    endpoint: &[(String, String)]
) -> Vec<(String, String)> {
    let mut result = api.to_vec();
    for (key, value) in endpoint {
        // Find and update or append
        if let Some(pos) = result.iter().position(|(k, _)| k == key) {
            result[pos] = (key.clone(), value.clone());
        } else {
            result.push((key.clone(), value.clone()));
        }
    }
    result
}
```

This avoids double iteration and is more idiomatic. The `retain` pattern is O(n²) in the worst case.

---

#### Issue 2: Generated Code Pattern - Structure Field Missing (CRITICAL)

**Current Plan shows:**
```rust
pub struct OpenAI {
    client: reqwest::Client,
    base_url: String,
    env_auth: Vec<String>,
    auth_strategy: schematic_define::AuthStrategy,
    env_username: Option<String>,
    headers: Vec<(String, String)>,  // ← MISSING IN PLAN
}
```

**Finding:** The plan **doesn't explicitly mention adding `headers` field to the generated struct itself**.

Look at current `api_struct.rs` (lines 72-81):
```rust
pub struct #struct_name {
    client: reqwest::Client,
    base_url: String,
    env_auth: Vec<String>,
    auth_strategy: schematic_define::AuthStrategy,
    env_username: Option<String>,
}
```

**You must add to codegen:**
```rust
pub struct #struct_name {
    client: reqwest::Client,
    base_url: String,
    env_auth: Vec<String>,
    auth_strategy: schematic_define::AuthStrategy,
    env_username: Option<String>,
    headers: Vec<(String, String)>,  // NEW
}
```

**Impact:** This is a **BREAKING CHANGE** to the generated code structure. The plan correctly shows usage but doesn't explicitly call out struct field addition.

---

#### Issue 3: Initialization in `new()` Constructor (MINOR BUT IMPORTANT)

The plan doesn't show how headers are initialized in constructors. Add to `generate_api_struct`:

```rust
pub fn new() -> Self {
    Self {
        client: reqwest::Client::new(),
        base_url: Self::BASE_URL.to_string(),
        env_auth: vec![#(#env_auth.to_string()),*],
        auth_strategy: #auth_strategy_init,
        env_username: #env_username_init,
        headers: vec![],  // ← NEW: Initialize from RestApi::headers
    }
}
```

For variadic headers:
```rust
let api_headers = &api.headers;
quote! {
    headers: vec![#(#api_headers.clone()),*],
}
```

---

### Phase 4: Endpoint Header Propagation

**Status:** CRITICAL TYPE SIGNATURE MISMATCH

#### Issue: into_parts() Return Type Incomplete (CRITICAL)

**Current Plan shows:**
```rust
// Current (from request_enum.rs line 72):
pub fn into_parts(self) -> (&'static str, String, Option<String>) { }

// Plan proposes:
pub fn into_parts(self) -> Result<(&'static str, String, Option<String>, Vec<(String, String)>), SchematicError>
```

**Problem:** This **breaks the return type consistency** across multiple locations:

1. **request_structs.rs (line 189)** - Already returns `Result`:
   ```rust
   pub fn into_parts(self) -> Result<(&'static str, String, Option<String>), SchematicError>
   ```

2. **request_enum.rs (line 72)** - Currently NO Result:
   ```rust
   pub fn into_parts(self) -> (&'static str, String, Option<String>)
   ```

3. **client.rs (line 71)** - Calls with error handling:
   ```rust
   let (method, path, body) = request.into_parts()?;  // ← Uses ?
   ```

**Critical Finding:** The request_structs already return `Result` (correct pattern), but the request_enum doesn't match!

**The Plan's Signature Mismatch:**
- Plan says: `Result<(..., Vec<...>), SchematicError>`
- Current code: `Result<(...), SchematicError>` for structs
- Current code: Plain tuple for enum

**Correct Approach:**

Update BOTH to match:

```rust
// In request_enum.rs line 72:
pub fn into_parts(self) -> Result<(&'static str, String, Option<String>, Vec<(String, String)>), SchematicError> {
    match self {
        Self::ListModels(req) => req.into_parts(),  // ✓ Already returns Result
        Self::RetrieveModel(req) => req.into_parts(),
        // ...
    }
}

// In request_structs.rs line 189:
pub fn into_parts(self) -> Result<(&'static str, String, Option<String>, Vec<(String, String)>), SchematicError> {
    #path_format
    Ok((#method_str, path, #body_expr, endpoint_headers))
}
```

**Where to get endpoint_headers?**
```rust
// NEW: Add to Endpoint type or pass from request context
let endpoint_headers: Vec<(String, String)> = vec![];  // From endpoint definition
Ok((#method_str, path, #body_expr, endpoint_headers))
```

---

#### Issue: Request Enum into_parts() Currently Doesn't Return Result (CRITICAL)

Looking at request_enum.rs (lines 69-76):

```rust
pub fn into_parts(self) -> (&'static str, String, Option<String>) {
    match self {
        Self::ListModels(req) => req.into_parts(),  // PROBLEM: Delegate calls return Result
        // ...
    }
}
```

**Bug Found:** If request_struct's `into_parts()` returns `Result<...>`, but the enum's `into_parts()` doesn't return `Result`, this won't compile!

**Current State Verification Needed:** Let me check if this is already fixed...

**Actual Check:**
- request_structs.rs (line 189): `pub fn into_parts(self) -> Result<...>` ✓
- request_enum.rs (line 72): `pub fn into_parts(self) -> (&'static str, String, Option<String>)` ✗

**This is a pre-existing bug!** The enum's `into_parts()` should already return `Result` to match the struct delegation.

---

### Phase 5: Integration Testing

**Status:** GOOD ✓

Plan correctly identifies test cases:
- API-wide headers only ✓
- Endpoint headers only ✓
- Endpoint headers override API headers ✓
- Anthropic-style beta headers ✓

**Test Locations:** Add to `/Volumes/coding/personal/dockhand/schematic/gen/tests/`

**Example Test Structure:**
```rust
#[test]
fn merge_headers_endpoint_overrides_api() {
    let api_headers = vec![("X-Custom".to_string(), "api-value".to_string())];
    let endpoint_headers = vec![("X-Custom".to_string(), "endpoint-value".to_string())];
    let merged = merge_headers(&api_headers, &endpoint_headers);

    assert_eq!(merged.len(), 1);
    assert_eq!(merged[0].1, "endpoint-value");
}
```

---

### Phase 6: Documentation

**Status:** INCOMPLETE

Plan mentions:
- README header documentation ✓ (gen/README.md needs section)
- Rustdoc comments ✓ (types.rs, generated code need docs)
- Examples ✗ (not specified in plan)

**Missing Documentation:**
1. Authentication + Headers interaction (when both present)
2. Performance implications of header merging
3. Examples in gen/README.md

---

## Recommendations (Priority Order)

### BEFORE IMPLEMENTATION:

1. **Fix request_enum.rs return type to match request_structs.rs** (CRITICAL)
   - Both should return `Result<(&'static str, String, Option<String>, Vec<...>), SchematicError>`
   - This is pre-existing bug affecting struct delegation

2. **Optimize merge_headers() implementation** (MEDIUM)
   - Replace `retain()` pattern with single-pass HashMap or position lookup
   - Improves O(n²) to O(n) for typical header counts

3. **Add struct field initialization in api_struct codegen** (CRITICAL)
   - Ensure headers field is initialized in all constructors
   - Document in code comments

4. **Update request_struct codegen to handle endpoint headers** (CRITICAL)
   - Pass headers from endpoint definition to into_parts()
   - Handle serialization properly

5. **Add comprehensive tests** (HIGH)
   - Header merging logic
   - Generated code compilation
   - E2E tests with real requests

### DOCUMENTATION:

- Add headers section to gen/README.md (line ~315 in auth section)
- Document header precedence rules (endpoint > API)
- Add example showing both API and endpoint headers
- Document Anthropic-style header usage

---

## Code Quality Assessment

### Strengths ✓
- Uses existing patterns (Result types, TokenStream generation)
- Follows established code organization
- Test-driven approach identified
- Good understanding of Anthropic API header requirements

### Weaknesses ✗
- Pre-existing bug in request_enum.rs return type not caught
- Merge implementation has performance issue
- Missing explicit struct field initialization details
- No consideration of header validation

---

## Cargo/Dependency Impact

**NO NEW DEPENDENCIES NEEDED**

All types use only standard library:
- `Vec<(String, String)>` - std
- Header operations - std
- Error handling - existing thiserror

---

## File Changes Summary

| File | Change Type | Lines | Risk |
|------|-------------|-------|------|
| schematic/define/src/types.rs | Add fields | +2 | LOW |
| schematic/gen/src/codegen/api_struct.rs | Update codegen | +8 | MEDIUM |
| schematic/gen/src/codegen/request_structs.rs | Update codegen | +6 | MEDIUM |
| schematic/gen/src/codegen/request_enum.rs | BUG FIX + feature | +15 | HIGH |
| schematic/gen/src/lib.rs | Helper function | +8 | LOW |
| schematic/gen/README.md | Documentation | +15 | LOW |
| schematic/gen/tests/*.rs | New tests | +60 | LOW |

**Highest Risk:** request_enum.rs (requires return type change affecting code generation)

---

## Conclusion

**Recommendation: IMPLEMENT WITH MODIFICATIONS**

The plan is technically sound with clear phases and good understanding of requirements. However:

1. **BLOCKING ISSUE:** Fix pre-existing bug in request_enum.rs return type before adding headers feature
2. **CRITICAL:** Ensure struct field initialization in all generated constructors
3. **IMPORTANT:** Optimize merge_headers() implementation before production use

Estimated implementation time: **2-3 hours** (includes testing + documentation)

