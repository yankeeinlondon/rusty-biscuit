# Tree-hugger Linting + Syntax Review (2026-01-21)

## Scope
Reviewed linting and syntax diagnostics for tree-hugger across supported grammars, with attention to tree-sitter usage patterns, performance, reuse opportunities, and test coverage.

## Suggested Changes

### Tree-sitter usage and correctness

- Use tree-sitter comment captures for ignore directives instead of line-based string scanning so `tree-hugger-ignore` only triggers on real comments (avoids false positives for `//` in strings and enables block comments) in `tree-hugger/lib/src/ignore_directives.rs` and `tree-hugger/lib/src/file/tree_file.rs:905`.
- Add a fast path for syntax diagnostics by returning early when `root.has_error()` is false, rather than traversing the entire tree every call, in `tree-hugger/lib/src/file/tree_file.rs:1324`.
- Improve syntax error messaging by including expected node kinds for missing nodes and consider adding `SourceContext` to syntax diagnostics for consistent UX; this will touch `tree-hugger/lib/src/shared/symbol.rs:595` and `tree-hugger/lib/src/file/tree_file.rs:1324`.
- Tighten dead-code detection to match specific terminal calls/macros via node text or query captures instead of treating all macro invocations/call expressions as terminal, reducing false positives across languages in `tree-hugger/lib/src/dead_code.rs` and `tree-hugger/lib/src/file/tree_file.rs:1032`.
- Consider validating qualifiers in qualified references (`foo.bar`, `module::symbol`) instead of skipping them entirely so undefined-module cases are still caught across languages in `tree-hugger/lib/src/file/tree_file.rs:1090`.

### Performance and reuse

- Consolidate SourceContext creation into a single helper that operates from a `CodeRange` and reuse a precomputed line index to avoid repeated `source.lines().nth()` scans in `tree-hugger/lib/src/file/tree_file.rs`.
- When a lint query resolves to an empty or comment-only file, skip `Query::new` and cache a no-op path so languages without pattern rules do not incur repeated query compilation errors or overhead in `tree-hugger/lib/src/queries/mod.rs:79` and `tree-hugger/lib/queries/*/lint.scm`.

### Test coverage

- Add syntax error regression tests with invalid fixtures (missing delimiters, incomplete statements) for a representative subset of languages to exercise `syntax_diagnostics` in `tree-hugger/lib/tests/tree_file.rs`.
- Add semantic lint coverage for `undefined-symbol`, `unused-symbol`, `unused-import`, and `dead-code` so cross-grammar behavior is validated beyond pattern rules in `tree-hugger/lib/tests/lint_diagnostics.rs` and `tree-hugger/lib/tests/fixtures`.

## Updates Implemented

- Added semantic lint diagnostics tests for `undefined-symbol`, `unused-symbol`, `unused-import`, and `dead-code` in `tree-hugger/lib/tests/lint_diagnostics.rs`.
- Added syntax diagnostics regression tests for invalid Rust, JavaScript, and Python snippets using temp files in `tree-hugger/lib/tests/tree_file.rs`.
