//! Implementation of the `#[derive(RestApi)]` macro.
//!
//! This module handles parsing the input struct and its attributes,
//! then generates the API client infrastructure.

use proc_macro2::TokenStream;
use quote::quote;
use syn::{parse2, DeriveInput, Error, Result};

use crate::parse::ApiConfig;

/// Main implementation for the `#[derive(RestApi)]` macro.
pub fn derive_rest_api_impl(input: TokenStream) -> TokenStream {
    match derive_rest_api_inner(input) {
        Ok(tokens) => tokens,
        Err(err) => err.to_compile_error(),
    }
}

fn derive_rest_api_inner(input: TokenStream) -> Result<TokenStream> {
    let input: DeriveInput = parse2(input)?;
    let config = ApiConfig::from_attrs(&input.attrs)?;

    // For now, just validate and return empty - actual implementation in Phase 5
    config.validate()?;

    let name = &input.ident;

    // Skeleton implementation - generates minimal valid code
    // Full implementation will be added in Phase 5
    let expanded = quote! {
        // Generated by #[derive(RestApi)]
        // Full implementation pending Phase 5
        impl #name {
            /// Returns the base URL for this API.
            #[doc(hidden)]
            pub fn __api_base_url() -> &'static str {
                // This will be replaced with the actual base_url in Phase 5
                ""
            }
        }
    };

    Ok(expanded)
}

#[cfg(test)]
mod tests {
    use super::*;
    use quote::quote;

    #[test]
    fn test_derive_parses_basic_struct() {
        let input = quote! {
            #[api(base_url = "https://api.example.com")]
            pub struct TestApi;
        };

        let result = derive_rest_api_impl(input);
        // Should not produce a compile error
        assert!(!result.to_string().contains("compile_error"));
    }

    #[test]
    fn test_derive_requires_base_url() {
        let input = quote! {
            pub struct TestApi;
        };

        let result = derive_rest_api_impl(input);
        // Should produce a compile error about missing base_url
        assert!(result.to_string().contains("compile_error"));
    }
}
